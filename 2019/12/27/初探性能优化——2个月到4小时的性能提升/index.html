<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="一直不知道性能优化都要做些什么，从哪方面思考，直到最近接手了一个公司的小项目，可谓麻雀虽小五脏俱全。让我这个编程小白学到了很多性能优化的知识，或者说一些思考方式。真的感受到任何一点效率的损失放大一定倍数时，将会是天文数字。最初我的程序计算下来需要跑2个月才能跑完，经过2周不断地调整架构和细节，将性能提升到了4小时完成。很多心得体会，希望和大家分享，也希望多多批评指正，共同进步。">
<meta property="og:type" content="article">
<meta property="og:title" content="初探性能优化——2个月到4小时的性能提升">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2019&#x2F;12&#x2F;27&#x2F;%E5%88%9D%E6%8E%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%942%E4%B8%AA%E6%9C%88%E5%88%B04%E5%B0%8F%E6%97%B6%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87&#x2F;index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="一直不知道性能优化都要做些什么，从哪方面思考，直到最近接手了一个公司的小项目，可谓麻雀虽小五脏俱全。让我这个编程小白学到了很多性能优化的知识，或者说一些思考方式。真的感受到任何一点效率的损失放大一定倍数时，将会是天文数字。最初我的程序计算下来需要跑2个月才能跑完，经过2周不断地调整架构和细节，将性能提升到了4小时完成。很多心得体会，希望和大家分享，也希望多多批评指正，共同进步。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102701-2881e.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102701-7c22d.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102701-8b0c1.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102701-dd182.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102702-dd348.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102702-40c81.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102702-3d909.jpeg">
<meta property="og:updated_time" content="2019-12-27T02:29:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;08&#x2F;20190822102701-2881e.jpeg">

<link rel="canonical" href="http://congsheng.wang/2019/12/27/%E5%88%9D%E6%8E%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%942%E4%B8%AA%E6%9C%88%E5%88%B04%E5%B0%8F%E6%97%B6%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>初探性能优化——2个月到4小时的性能提升 | 个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">winrains的个人博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">108</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">82</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">469</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2019/12/27/%E5%88%9D%E6%8E%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%942%E4%B8%AA%E6%9C%88%E5%88%B04%E5%B0%8F%E6%97%B6%E7%9A%84%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="winrains">
      <meta itemprop="description" content="淡泊明志">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          初探性能优化——2个月到4小时的性能提升
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-27 10:29:49" itemprop="dateCreated datePublished" datetime="2019-12-27T10:29:49+08:00">2019-12-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>一直不知道性能优化都要做些什么，从哪方面思考，直到最近接手了一个公司的小项目，可谓麻雀虽小五脏俱全。让我这个编程小白学到了很多性能优化的知识，或者说一些思考方式。真的感受到任何一点效率的损失放大一定倍数时，将会是天文数字。最初我的程序计算下来需要跑<strong>2个月</strong>才能跑完，经过2周不断地调整架构和细节，将性能提升到了<strong>4小时</strong>完成。<br>很多心得体会，希望和大家分享，也希望多多批评指正，共同进步。</p>
<a id="more"></a>

<h2 id="项目描述"><a href="#项目描述" class="headerlink" title="项目描述"></a><strong>项目描述</strong></h2><p>我将公司的项目内容抽象，大概是要做<strong>这样一件事情</strong>。<br>\1. 数据库A中有2000万条用户数据<br>\2. 将数据库A中的用户读出，为每条用户生成guid，并保存到数据库B中<br>\3. 同时在数据库A中生成关联表</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102701-2881e.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<p>项目<strong>要求</strong>为：<br>\1. 将用户存入数据库B的过程需要<strong>调用sdk</strong>的注册接口，不允许直接操作jdbc进行插入<br>\2. 数据要求<strong>可恢复</strong>：再次运行要跳过已成功的数据；出错的数据要进行持久化以便下次可以选择恢复该部分数据<br>\3. 数据要保证<strong>一致性</strong>：在不出错的情况下，数据库B的用户必然一一对应数据库A的关联表。如果出错，那么正确的数据加上记录下来的出错数据后要保证一致性。<br>\4. <strong>速度</strong>要尽可能块：共2000万条数据，在保证正确性的前提下，至多一天内完成</p>
<h2 id="第一版，面向过程——2个月"><a href="#第一版，面向过程——2个月" class="headerlink" title="第一版，面向过程——2个月"></a><strong>第一版，面向过程——2个月</strong></h2><p><strong>特征：</strong>面向过程、单一线程、不可拓展、极度耦合、逐条插入、数据不可恢复</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102701-7c22d.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<p>最初的一版简直是汇聚了一个项目的所有缺点。整个流程就是从A库读出一条数据，立刻做处理，然后调用接口插入B库，然后在拼一个关联表的sql语句，插入A库。没有计数器，没有错误信息处理。这样下来的代码最终<strong>预测2000万条数据要处理2个月</strong>。如果中间哪怕一条数据出错，又要重新再来2个月。简直可怕。<br>这个流程图就等同于废话，是完全基于<strong>面向过程</strong>的思想，整个代码就是在一个大main方法里写的，实际业务流程完全等同于代码的流程。思考起来简单，但实现和维护起来极为困难，代码结构冗长混乱。而且几乎是不可扩展的。暂且不谈代码的设计美观，它的<strong>效率如此低</strong>下主要有一下几点：<br>\1. 每一条数据的速度受制于整个链条中<strong>最慢的一环</strong>。试想假如有一条A库插入关联表的数据卡住了，等待将近1分钟（夸张了点），那这一分钟jvm完全就在傻等，它完全可以继续进行之前的两步。正如你等待鸡蛋煮熟的过程中可以同时去做其他的事一样。<br>\2. 向B库插入用户需要调用sdk（HTTP请求）接口，那每一次调用都需要<strong>建立连接，等待响应，再释放链接</strong>。正如你要给朋友送一箱苹果，你分成100次每次只送一个，时间全搭载路上了。</p>
<h2 id="第二版，面向对象——21天"><a href="#第二版，面向对象——21天" class="headerlink" title="第二版，面向对象——21天"></a><strong>第二版，面向对象——21天</strong></h2><p><strong>特征：</strong>面向对象、单一线程、可拓展、略微耦合、批量插入、数据可恢复</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102701-8b0c1.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a><strong>架构设计</strong></h3><p>根据第一版设计的问题，第二版有了一些改进。当然最明显的就是从面向过程的思想转变为面向对象。<br>我将整个过程抽离出来，分配给不同的对象去处理。这样，我所分配的对象时这样的：<br><strong>1. 一个配置对象</strong>：<strong>BatchStrategy</strong>。负责从配置文件中读取本次任务的策略并传递给执行者，配置包括基础配置如总条数，每次批量查询的数量，每次批量插入的数量。还有一些数据源方面的，如来源表的表名、列名、等，这样如果换成其他数据库的类似导入，就能供通过配置进行拓展了。<br><strong>2. 三个执行者：</strong>整个执行过程可以分成三个部分：读数据–处理数据–写数据，可以分别交给三个对象<strong>Reader，Processor，Writer</strong>进行。这样如果某一处逻辑变了，可以单独进行改变而不影响其他环节。<br><strong>3. 一个失败数据处理类：ErrorHandler</strong>。这样每当有数据出现异常时，便把改数据扔给这个类，在这给类中进行写入日志，或者其他的处理办法。在一定程度上将失败数据的处理解耦。<br>这种设计很大程度上解除了耦合，尤其是失败数据的处理基本上完全解耦。但由于整个执行过程仍然是需要有一个main来分别调用三个对象处理任务，因此三者之间还是没有完全解耦，main部分的逻辑依然是面向过程的思想，比较复杂。即使把main中执行的逻辑抽出一个service，这个问题依然没有解决。</p>
<h3 id="效率问题"><a href="#效率问题" class="headerlink" title="效率问题"></a><strong>效率问题</strong></h3><p>由于将第一版的逐条插入改为<strong>批量插入</strong>。其中sdk接口部分是批量传入一组数据，<strong>减少了http请求</strong>的次数。生成关联表的部分是用了<strong>jdbc batch</strong>操作，将之前逐条插入的excute改为excuteBatch，效率提升很明显。这两部分批量带来的效率提升，将原本需要两个月时间的代码，提升到了21天，但依然是天文数字。<br>可以看出，本次效率提升仅仅是在减少http请求次数，优化sql的插入逻辑方面做出来努力，但依然没有解决第一版的一个致命问题，就是一次循环的速度依然<strong>受制于整个链条中最慢的一环，</strong>三者没有解耦也可以从这一点看出，<strong>在其他两者没有将工作做完时，就只能傻等</strong>，这是效率损失最严重的地方了。</p>
<h2 id="第三版，完全解耦（队列-多线程）——3天"><a href="#第三版，完全解耦（队列-多线程）——3天" class="headerlink" title="第三版，完全解耦（队列+多线程）——3天"></a><strong>第三版，完全解耦（队列+多线程）——3天</strong></h2><p><strong>特征：</strong>面向对象、多线程、可拓展、完全解耦、批量插入、数据可恢复</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102701-dd182.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<h3 id="架构设计-1"><a href="#架构设计-1" class="headerlink" title="架构设计"></a><strong>架构设计</strong></h3><p>该版并没有代码实现，但确是过度到下一版的重要思考过程，故记录在次。这一版本较上一版的重大改进之处有两点：<strong>队列和多线程</strong>。<br><strong>队列：</strong>其中队列的使用使上一版未完全解耦的执行类之间，实现了<strong>完全解耦</strong>，将同步过程变为异步，同时也是多线程能够使用的前提。Reader做的事就是读取数据，并放入队列，至于它的下一个环节Processor如何处理队列的数据，它完全不用理会，这时便可以继续读取数据。这便做到了完全解耦，处理队列的数据也能够使用多线程了。<br><strong>多线程</strong>：Processor和Writer所做的事情，就是读取自身队列中的数据，然后处理。只不过Processor比Writer还承担了一个往下一环队列里放数据的过程。此处的队列用的是多线程安全队列<strong>ConcurrentLinkedQueue。</strong>因此可以肆无忌惮地使用多线程来执行这两者的任务。由于各个环节之间的完全解耦，某一环上的偶尔卡主并不再影响整个过程的进度，所以效率提升不知一两点。<br>还有一点就是数据的可恢复性在这个设计中有了保障，成功过的<strong>用户</strong>被保存起来以便再次运行不会冲突，失败的<strong>关联表</strong>数据也被记录下来，在下次运行时Writer会先将这一部分加入到自己的队列里，整个数据的正确性就有了一个不是特别完善的方案，效率也有了可观的提升。</p>
<h3 id="效率问题-1"><a href="#效率问题-1" class="headerlink" title="效率问题"></a><strong>效率问题</strong></h3><p>虽然效率从21天提升到了3天，但我们还要思考一些问题。实际在执行的过程中发现，<strong>Writer所完成的数据总是紧跟在Processor之后</strong>。这就说明Processor的处理速度要慢于Writer，因为Processor插入数据库之前还要走一段注册用户的业务逻辑。这就有个问题，当上一环的速度慢过下一环时，还有必要进行批量的操作么？答案是不需要的。试想一下，如果你在生产线上，你的上一环2秒钟处理一个零件，而你的速度是1秒钟一个。这时即使你的批量处理速度更快，从系统最优的角度考虑，你也应该来一个零件就马上处理，而不是等积攒到100个再批量处理。<br>还有一个问题是，我们从未考虑过<strong>Reader</strong>的性能。实际上我用的是<strong>limit</strong>操作来批量读取数据库，而mysql的limit是先全表查再截取，当起始位置很大时，就会越来越慢。0-1000万还算轻松，但1000万到2000万简直是“寸步难行”。所以最终效率的瓶颈反而落到了<strong>读库操作</strong>上。</p>
<h2 id="第四版，高度抽象（一键启动）——4小时"><a href="#第四版，高度抽象（一键启动）——4小时" class="headerlink" title="第四版，高度抽象（一键启动）——4小时"></a><strong>第四版，高度抽象（一键启动）——4小时</strong></h2><p><strong>特征：</strong>面向接口、多线程、可拓展、完全解耦、批量或逐条插入、数据可恢复、优化查询的limit操作</p>
<h3 id="架构的思考"><a href="#架构的思考" class="headerlink" title="架构的思考"></a><strong>架构的思考</strong></h3><p>优雅的代码应该是整洁而美妙，不应是冗长而复杂的。这一版将会设计出简洁度如第一版，而性能和拓展性超越所有版本的架构。<br>通过总结前三版特征，我发现不论是Reader，Processor，Writer，都有共同的特征：<strong>启动任务、处理任务、结束任务。</strong>而Reader和Processor又有一个共同的可以<strong>向下一道工序传递数据</strong>，<strong>通知下一道工序数据传递结束</strong>的功能。他们就像生产线上的一个个工序，相互关联而又各自独立地运行着。每一道工序都可以启动，疯狂地处理任务，直到上一道工序通知结束为止。而第一个发起通知结束的便是Reader，之后便一个通知下一个，直到整个工序停止，这个过程就是美妙的。</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102702-dd348.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<p>因此我们可以将这三者都看做是<strong>Job</strong>，除了<strong>Reader</strong>外又都有与上一道工序交互的能力（其实<strong>Reader</strong>的上一道工序就是数据库），因此便有了如下的接口设计。</p>
<p><img src="http://image.winrains.cn/2019/08/20190822102702-40c81.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 工作步骤接口.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> interface Job &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">finish</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * 可交互的（传入，通知结束）.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> interface Interactive&lt;T&gt; &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * 开放与外界交互的通道</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">openInteract</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * 接收外界传来的数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * @param t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">receive</span><span class="params">(T t)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * 关闭交互的通道</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">closeInteract</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * 是否处于可交互的状态</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  * @return true可交互的 false不可交互的活已关闭交互状态</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">isInteractive</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>有了这样的接口设计，不论实现类具体怎么写，主方法已经可以写出了，变得异常整洁有序。<br>只提炼主干部分，去掉了一些细枝末节，如日志输出、时间记录等。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> Job reader = Reader.getInstance();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> Job processor = Processor.getInstance();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"> Job writer = Writer.getInstance();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> reader.init();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"> processor.init();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> writer.init();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> start(reader, processor, processor, processor, writer, writer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(Job... jobs)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">for</span> (Job job:jobs) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">     Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">         job.start();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">       &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">   &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">   thread.start();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"> &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>接下来就是具体实现类的问题了，这里实现类主要实现的是三个功能：</p>
<p><strong>1. 接收上一环的数据</strong>：属于<strong>Interactive</strong>接口的<strong>receive</strong>方法的实现，基于之前的设计，即是对象中有一个<strong>ConcurrentLinkedQueue</strong>类型的属性，用来接收上一环传来的数据。<br><strong>2. 处理数据并传递给下一环</strong>：在每一个（有下一环的）对象属性中，放入下一环的对象。如<strong>Reader</strong>中要有<strong>Processor</strong>对象，<strong>Processor</strong>要有<strong>Writer</strong>，一旦有数据需要加入下一环的队列，调用其<strong>receiive</strong>方法即可。<br><strong>3. 告诉下一环我结束了</strong>：本任务结束时，调用下一环对象的<strong>closeInteractive</strong>方法。而每个对象判断自身结束的方法视情况而定，比如<strong>Reader</strong>结束的条件是批量读取的数据超过了一开始设置的<strong>total</strong>，说明数据读取完毕，可以结束。而<strong>Processor</strong>结束的条件是，它被上一环通知了结束，并且从自己的队列中<strong>poll</strong>不出东西了，证明应该结束，结束后再通知下一环节。这样整个工序就安全有序地退出了。不过由于是多线程，所以Processor不能贸然通知Writer结束信号，需要在Processor内部弄一个计数器，只有计数器达到预期的数量的那个线程的Processor，才能发起结束通知。</p>
<h3 id="效率问题-2"><a href="#效率问题-2" class="headerlink" title="效率问题"></a><strong>效率问题</strong></h3><p>正如上一版提出的，<strong>Processor</strong>的处理速度要慢于<strong>Writer</strong>，所以<strong>Writer</strong>并不需要用<strong>batch</strong>去处理数据的插入，该成逐条插入反而是提高性能的一种方式。<br>大数据量limit操作十分耗时，由于测试部分只是在<strong>前</strong>几百万条测试，所以还是大大低估了效率的损失。在<strong>后</strong>几百万条可以说每一次limit的读取都寸步难行。考虑到这个问题，我选去了唯一一个有索引并且稍稍易于排序的字段“<strong>用户的手机号</strong>”，（不想吐槽它们设计表的时候居然没有自增id。。。），每次全表将手机号<strong>排序</strong>，再limit查询。查询之后将最后一条的手机号保存起来，成为当前读取的<strong>最后一条数据的一个标识</strong>。下次再limit操作就可以从这个手机号之后开始查询了。这样每次查询不论从哪里开始，速度都是一样的。虽然前面部分的数据速度与之前的方案相比慢了不少，但却完美解决了大数据量limit操作的超长等待时间，预防了危险的发生。<br><strong>至此，项目架构再次简洁起来，但同第一版相比，已经不是同一级别的简洁了。</strong></p>
<p><img src="http://image.winrains.cn/2019/08/20190822102702-3d909.jpeg" alt="初探性能优化——2个月到4小时的性能提升"></p>
<h2 id="关于继续优化的思考"><a href="#关于继续优化的思考" class="headerlink" title="关于继续优化的思考"></a><strong>关于继续优化的思考</strong></h2><p>\1. Reader部分是单线程在处理，由于读取是从数据库中，并不是队列中，因此设计成多线程有些麻烦，但并不是不可，这里是优化点<br>\2. 日志部分占有很大一部分比例，2000万条读、处理、写就要有至少6000万次日志输出。如果设计成异步处理，效率会提升不少。</p>
<blockquote>
<p>作者：cpp软件架构狮</p>
<p>来源：<a href="https://www.toutiao.com/i6672902811568570894/" target="_blank" rel="noopener">https://www.toutiao.com/i6672902811568570894/</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/27/%E9%AB%98%E5%8F%AF%E7%94%A8Redis%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90%E4%B8%8E%E6%90%AD%E5%BB%BA/" rel="prev" title="高可用Redis服务架构分析与搭建">
      <i class="fa fa-chevron-left"></i> 高可用Redis服务架构分析与搭建
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/27/%E4%BB%8E%E9%9B%B6%E5%88%B0%E7%99%BE%E4%BA%BF%E4%BA%92%E8%81%94%E7%BD%91%E9%87%91%E8%9E%8D%E6%9E%B6%E6%9E%84%E5%8F%91%E5%B1%95%E5%8F%B2/" rel="next" title="从零到百亿互联网金融架构发展史">
      从零到百亿互联网金融架构发展史 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#项目描述"><span class="nav-number">1.</span> <span class="nav-text">项目描述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第一版，面向过程——2个月"><span class="nav-number">2.</span> <span class="nav-text">第一版，面向过程——2个月</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二版，面向对象——21天"><span class="nav-number">3.</span> <span class="nav-text">第二版，面向对象——21天</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构设计"><span class="nav-number">3.1.</span> <span class="nav-text">架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#效率问题"><span class="nav-number">3.2.</span> <span class="nav-text">效率问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三版，完全解耦（队列-多线程）——3天"><span class="nav-number">4.</span> <span class="nav-text">第三版，完全解耦（队列+多线程）——3天</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构设计-1"><span class="nav-number">4.1.</span> <span class="nav-text">架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#效率问题-1"><span class="nav-number">4.2.</span> <span class="nav-text">效率问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第四版，高度抽象（一键启动）——4小时"><span class="nav-number">5.</span> <span class="nav-text">第四版，高度抽象（一键启动）——4小时</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#架构的思考"><span class="nav-number">5.1.</span> <span class="nav-text">架构的思考</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#效率问题-2"><span class="nav-number">5.2.</span> <span class="nav-text">效率问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于继续优化的思考"><span class="nav-number">6.</span> <span class="nav-text">关于继续优化的思考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">winrains</p>
  <div class="site-description" itemprop="description">淡泊明志</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">469</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">82</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">108</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">winrains</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

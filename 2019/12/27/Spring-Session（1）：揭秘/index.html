<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="怀瑾握瑜前言在开始spring-session揭秘之前，先做下热脑（活动活动脑子）运动。主要从以下三个方面进行热脑：  为什么要spring-session 比较traditional-session方案和spring-session方案 JSR340规范与spring-session的透明继承">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Session（1）：揭秘">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2019&#x2F;12&#x2F;27&#x2F;Spring-Session%EF%BC%881%EF%BC%89%EF%BC%9A%E6%8F%AD%E7%A7%98&#x2F;index.html">
<meta property="og:site_name" content="congsheng的博客">
<meta property="og:description" content="怀瑾握瑜前言在开始spring-session揭秘之前，先做下热脑（活动活动脑子）运动。主要从以下三个方面进行热脑：  为什么要spring-session 比较traditional-session方案和spring-session方案 JSR340规范与spring-session的透明继承">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;a8a71-1286175-20180918232306231-326643336.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;ee43a-1286175-20180918232339701-1747137442.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;74e77-1286175-20180918232404171-1125631131.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;3e301-1286175-20180918232433276-1511319332.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;cd758-1286175-20180918232504852-612980271.png">
<meta property="og:updated_time" content="2019-12-27T08:17:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;09&#x2F;a8a71-1286175-20180918232306231-326643336.png">

<link rel="canonical" href="http://congsheng.wang/2019/12/27/Spring-Session%EF%BC%881%EF%BC%89%EF%BC%9A%E6%8F%AD%E7%A7%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Spring Session（1）：揭秘 | congsheng的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">congsheng的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问：winrains.cn</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2019/12/27/Spring-Session%EF%BC%881%EF%BC%89%EF%BC%9A%E6%8F%AD%E7%A7%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="congsheng的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Session（1）：揭秘
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-27 16:17:42" itemprop="dateCreated datePublished" datetime="2019-12-27T16:17:42+08:00">2019-12-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Spring技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/Spring-Session/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Session</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="怀瑾握瑜前言"><a href="#怀瑾握瑜前言" class="headerlink" title="怀瑾握瑜前言"></a>怀瑾握瑜前言</h1><p>在开始spring-session揭秘之前，先做下热脑（活动活动脑子）运动。主要从以下三个方面进行热脑：</p>
<ol>
<li>为什么要spring-session</li>
<li>比较traditional-session方案和spring-session方案</li>
<li>JSR340规范与spring-session的透明继承</li>
</ol>
<a id="more"></a>

<h2 id="一-为什么要spring-session"><a href="#一-为什么要spring-session" class="headerlink" title="一.为什么要spring-session"></a>一.为什么要spring-session</h2><p>在传统单机web应用中，一般使用tomcat/jetty等web容器时，用户的session都是由容器管理。浏览器使用cookie中记录sessionId，容器根据sessionId判断用户是否存在会话session。这里的限制是，session存储在web容器中，被单台服务器容器管理。<br>但是网站主键演变，分布式应用和集群是趋势（提高性能）。此时用户的请求可能被负载分发至不同的服务器，此时传统的web容器管理用户会话session的方式即行不通。除非集群或者分布式web应用能够共享session，尽管tomcat等支持这样做。但是这样存在以下两点问题：</p>
<ul>
<li>需要侵入web容器，提高问题的复杂</li>
<li>web容器之间共享session，集群机器之间势必要交互耦合</li>
</ul>
<p>基于这些，必须提供新的可靠的集群分布式/集群session的解决方案，突破traditional-session单机限制（即web容器session方式，下面简称traditional-session），spring-session应用而生。</p>
<h2 id="二-比较traditional-session方案和spring-session方案"><a href="#二-比较traditional-session方案和spring-session方案" class="headerlink" title="二.比较traditional-session方案和spring-session方案"></a>二.比较traditional-session方案和spring-session方案</h2><p>下图展示了traditional-session和spring-session的区别</p>
<p><img src="http://image.winrains.cn/2019/09/a8a71-1286175-20180918232306231-326643336.png" alt="http://image.winrains.cn/2019/09/a8a71-1286175-20180918232306231-326643336.png"></p>
<p>传统模式中，当request进入web容器，根据reqest获取session时，如果web容器中存在session则返回，如果不存在，web容器则创建一个session。然后返回response时，将sessonId作为response的head一并返回给客户端或者浏览器。<br>但是上节中说明了traditional-session的局限性在于：单机session。在此限制的相反面，即将session从web容器中抽出来，形成独立的模块，以便分布式应用或者集群都能共享，即能解决。<br>spring-session的核心思想在于此：将session从web容器中剥离，存储在独立的存储服务器中。目前支持多种形式的session存储器：Redis、Database、MogonDB等。session的管理责任委托给spring-session承担。当request进入web容器，根据request获取session时，由spring-session负责存存储器中获取session，如果存在则返回，如果不存在则创建并持久化至存储器中。</p>
<h2 id="三-JSR340规范与spring-session的透明继承"><a href="#三-JSR340规范与spring-session的透明继承" class="headerlink" title="三.JSR340规范与spring-session的透明继承"></a>三.JSR340规范与spring-session的透明继承</h2><p>JSR340是Java Servlet 3.1的规范提案，其中定义了大量的api，包括：servlet、servletRequest/HttpServletRequest/HttpServletRequestWrapper、servletResponse/HttpServletResponse/HttpServletResponseWrapper、Filter、Session等，是标准的web容器需要遵循的规约，如tomcat/jetty/weblogic等等。<br>在日常的应用开发中，develpers也在频繁的使用servlet-api，比如：<br>以下的方式获取请求的session：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">HttpServletRequest <span class="attr">request</span> = ...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">HttpSession <span class="attr">session</span> = request.getSession(<span class="literal">false</span>);</span></pre></td></tr></table></figure>

<p>其中HttpServletRequest和HttpSession都是servlet规范中定义的接口，web容器实现的标准。那如果引入spring-session，要如何获取session？</p>
<ul>
<li>遵循servlet规范，同样方式获取session，对应用代码无侵入且对于developers透明化</li>
<li>全新实现一套session规范，定义一套新的api和session管理机制</li>
</ul>
<p>两种方案都可以实现，但是显然第一种更友好，且具有兼容性。spring-session正是第一种方案的实现。<br>实现第一种方案的关键点在于做到透明和兼容</p>
<ul>
<li>接口适配：仍然使用HttpServletRequest获取session，获取到的session仍然是HttpSession类型——<strong>适配器模式</strong></li>
<li>类型包装增强：Session不能存储在web容器内，要外化存储——<strong>装饰模式</strong></li>
</ul>
<p>让人兴奋的是，以上的需求在Servlet规范中的扩展性都是予以支持！Servlet规范中定义一系列的接口都是支持扩展，同时提供Filter支撑扩展点。建议阅读《JavaTM Servlet Specification》。<br>热脑活动结束，下面章节正式进入今天的主题：<strong>spring-session揭秘</strong></p>
<h1 id="Spring-Session探索"><a href="#Spring-Session探索" class="headerlink" title="Spring Session探索"></a>Spring Session探索</h1><p>主要从以下两个方面来说spring-session：</p>
<ul>
<li>特点</li>
<li>工作原理</li>
</ul>
<h2 id="一-特点"><a href="#一-特点" class="headerlink" title="一.特点"></a>一.特点</h2><p>spring-session在无需绑定web容器的情况下提供对集群session的支持。并提供对以下情况的透明集成：</p>
<ul>
<li>HttpSession：容许替换web容器的HttpSession</li>
<li>WebSocket：使用WebSocket通信时，提供Session的活跃</li>
<li>WebSession：容许以应用中立的方式替换webflux的webSession</li>
</ul>
<h2 id="二-工作原理"><a href="#二-工作原理" class="headerlink" title="二.工作原理"></a>二.工作原理</h2><p>再详细阅读源码之前先来看张图，介绍下spring-session中的核心模块以及之间的交互。<img src="http://image.winrains.cn/2019/09/ee43a-1286175-20180918232339701-1747137442.png" alt="http://image.winrains.cn/2019/09/ee43a-1286175-20180918232339701-1747137442.png"><br>spring-session分为以下核心模块：</p>
<ul>
<li><code>SessionRepositoryFilter</code>：<code>Servlet</code>规范中<code>Filter</code>的实现，用来切换<code>HttpSession</code>至Spring Session，包装<code>HttpServletRequest</code>和<code>HttpServletResponse</code></li>
<li><code>HttpServerletRequest</code>/<code>HttpServletResponse</code>/<code>HttpSessionWrapper</code>包装器：包装原有的<code>HttpServletRequest</code>、<code>HttpServletResponse</code>和Spring Session，实现切换<code>Session</code>和透明继承<code>HttpSession</code>的关键之所在</li>
<li>Session：Spring Session模块</li>
<li><code>SessionRepository</code>：管理Spring Session的模块</li>
<li><code>HttpSessionStrategy</code>：映射<code>HttpRequst</code>和<code>HttpResponse</code>到<code>Session</code>的策略</li>
</ul>
<h3 id="1-SessionRepositoryFilter"><a href="#1-SessionRepositoryFilter" class="headerlink" title="1. SessionRepositoryFilter"></a>1. SessionRepositoryFilter</h3><p><code>SessionRepositoryFilter</code>是一个<code>Filter</code>过滤器，符合<code>Servlet</code>的规范定义，用来修改包装请求和响应。这里负责包装切换<code>HttpSession</code>至Spring Session的请求和响应。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> doFilterInternal(HttpServletRequest request,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        HttpServletResponse response, FilterChain filterChain)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">throws</span> ServletException, IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置SessionRepository至Request的属性中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    request.setAttribute(SESSION_REPOSITORY_ATTR, <span class="keyword">this</span>.sessionRepository);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 包装原始HttpServletRequest至SessionRepositoryRequestWrapper</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    SessionRepositoryRequestWrapper wrappedRequest = <span class="keyword">new</span> SessionRepositoryRequestWrapper(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            request, response, <span class="keyword">this</span>.servletContext);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 包装原始HttpServletResponse响应至SessionRepositoryResponseWrapper</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    SessionRepositoryResponseWrapper wrappedResponse = <span class="keyword">new</span> SessionRepositoryResponseWrapper(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            wrappedRequest, response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置当前请求的HttpSessionStrategy策略</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    HttpServletRequest strategyRequest = <span class="keyword">this</span>.httpSessionStrategy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            .wrapRequest(wrappedRequest, wrappedResponse);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置当前响应的HttpSessionStrategy策略</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    HttpServletResponse strategyResponse = <span class="keyword">this</span>.httpSessionStrategy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            .wrapResponse(wrappedRequest, wrappedResponse);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        filterChain.doFilter(strategyRequest, strategyResponse);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">finally</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 提交session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        wrappedRequest.commitSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>以上是<code>SessionRepositoryFilter</code>的核心操作，每个<code>HttpRequest</code>进入，都会被该<code>Filter</code>包装成切换<code>Session</code>的请求很响应对象。</p>
<blockquote>
<p>Tips：责任链模式<br><code>Filter</code>是<code>Servlet</code>规范中的非常重要的组件，在tomcat的实现中使用了责任链模式，将多个<code>Filter</code>组织成链式调用。<code>Filter</code>的作用就是在业务逻辑执行前后对请求和响应做修改配置。配合<code>HttpServletRequestWrapper</code>和<code>HttpServletResponseWrapper</code>使用，可谓威力惊人！</p>
</blockquote>
<h3 id="2-SessionRepositoryRequestWrapper"><a href="#2-SessionRepositoryRequestWrapper" class="headerlink" title="2. SessionRepositoryRequestWrapper"></a>2. SessionRepositoryRequestWrapper</h3><p>对于<code>developers</code>获取<code>HttpSession</code>的api</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">HttpServletRequest request</span> = ...;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">HttpSession session</span> = request.getSession(true);</span></pre></td></tr></table></figure>

<p>在spring session中<code>request</code>的实际类型<code>SessionRepositoryRequestWrapper</code>。调用<code>SessionRepositoryRequestWrapper</code>的<code>getSession</code>方法会触发创建spring session，而非web容器的<code>HttpSession</code>。<br><code>SessionRepositoryRequestWrapper</code>用来包装原始的<code>HttpServletRequest</code>实现<code>HttpSession</code>切换至Spring Session。是透明Spring Session透明集成<code>HttpSession</code>的关键。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionRepositoryRequestWrapper</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String CURRENT_SESSION_ATTR = HttpServletRequestWrapper<span class="class">.<span class="keyword">class</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="class">                .<span class="title">getName</span>()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 当前请求sessionId有效</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> Boolean requestedSessionIdValid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 当前请求sessionId无效</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> requestedSessionInvalidated;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpServletResponse response;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServletContext servletContext;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SessionRepositoryRequestWrapper</span><span class="params">(HttpServletRequest request,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">            HttpServletResponse response, ServletContext servletContext)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 调用HttpServletRequestWrapper构造方法，实现包装</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">super</span>(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.response = response;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.servletContext = servletContext;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><code>SessionRepositoryRequestWrapper</code>继承<code>Servlet</code>规范中定义的包装器<code>HttpServletRequestWrapper</code>。<code>HttpServletRequestWrapper</code>是<code>Servlet</code>规范api提供的用于扩展<code>HttpServletRequest</code>的扩张点——即装饰器模式，可以通过重写一些api达到功能点的增强和自定义。</p>
<blockquote>
<p>Tips：装饰器模式<br>装饰器模式（包装模式）是对功能增强的一种绝佳模式。实际利用的是面向对象的多态性实现扩展。<code>Servlet</code>规范中开放此<code>HttpServletRequestWrapper</code>接口，是让developers自行扩展实现。这种使用方式和jdk中的<code>FilterInputStream</code>/<code>FilterInputStream</code>如出一辙。</p>
</blockquote>
<p><code>HttpServletRequestWrapper</code>中持有一个<code>HttpServletRequest</code>对象，然后实现<code>HttpServletRequest</code>接口的所有方法，所有方法实现中都是调用持有的<code>HttpServletRequest</code>对象的相应的方法。继承<code>HttpServletRequestWrapper</code> 可以对其重写。<code>SessionRepositoryRequestWrapper</code>继承<code>HttpServletRequestWrapper</code>，在构造方法中将原有的<code>HttpServletRequest</code>通过调用super完成对<code>HttpServletRequestWrapper</code>中持有的<code>HttpServletRequest</code>初始化赋值，然后重写和<code>session</code>相关的方法。这样就保证<code>SessionRepositoryRequestWrapper</code>的其他方法调用都是使用原有的<code>HttpServletRequest</code>的数据，只有<code>session</code>相关的是重写的逻辑。</p>
<blockquote>
<p>Tips：<br>这里的设计是否很精妙！一切都多亏与<code>Servlet</code>规范设计的的巧妙啊！</p>
</blockquote>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">HttpSessionWrapper <span class="title">getSession</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">getSession</span><span class="params">(<span class="keyword">true</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>重写<code>HttpServletRequest</code>的<code>getSession()</code>方法，调用有参数<code>getSession(arg)</code>方法，默认为true，表示当前reques没有session时创建session。继续看下有参数<code>getSession(arg)</code>的重写逻辑.</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> HttpSessionWrapper getSession(<span class="type">boolean</span> <span class="keyword">create</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    // 从当前请求的<span class="keyword">attribute</span>中获取<span class="keyword">session</span>，如果有直接返回</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    HttpSessionWrapper currentSession = getCurrentSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (currentSession != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> currentSession;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    // 获取当前request的sessionId，这里使用了HttpSessionStrategy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    // 决定怎样将Request映射至<span class="keyword">Session</span>，默认使用Cookie策略，即从cookies中解析sessionId</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    String requestedSessionId = getRequestedSessionId();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    // 请求的如果sessionId存在且当前request的<span class="keyword">attribute</span>中的没有<span class="keyword">session</span>失效属性</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    // 则根据sessionId获取spring <span class="keyword">session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (requestedSessionId != <span class="keyword">null</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            &amp;&amp; getAttribute(INVALID_SESSION_ID_ATTR) == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        S <span class="keyword">session</span> = getSession(requestedSessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        // 如果spring <span class="keyword">session</span>不为空，则将spring <span class="keyword">session</span>包装成HttpSession并</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        // 设置到当前Request的<span class="keyword">attribute</span>中，防止同一个request getsession时频繁的到存储器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        //中获取<span class="keyword">session</span>，提高性能</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (<span class="keyword">session</span> != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            this.requestedSessionIdValid = <span class="keyword">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            currentSession = <span class="built_in">new</span> HttpSessionWrapper(<span class="keyword">session</span>, getServletContext());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            currentSession.setNew(<span class="keyword">false</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            setCurrentSession(currentSession);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> currentSession;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        // 如果根据sessionId，没有获取到<span class="keyword">session</span>，则设置当前request属性，此sessionId无效</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        // 同一个请求中获取<span class="keyword">session</span>，直接返回无效</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            // This <span class="keyword">is</span> an invalid <span class="keyword">session</span> id. <span class="keyword">No</span> need <span class="keyword">to</span> ask again <span class="keyword">if</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            // request.getSession <span class="keyword">is</span> invoked <span class="keyword">for</span> the duration <span class="keyword">of</span> this request</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (SESSION_LOGGER.isDebugEnabled()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">                SESSION_LOGGER.<span class="keyword">debug</span>(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                        "No session found by id: Caching result for getSession(false) for this HttpServletRequest.");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            setAttribute(INVALID_SESSION_ID_ATTR, "true");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    // 判断是否创建<span class="keyword">session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!<span class="keyword">create</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (SESSION_LOGGER.isDebugEnabled()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        SESSION_LOGGER.<span class="keyword">debug</span>(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">                "A new session was created. To help you troubleshoot where the session was created we provided a StackTrace (this is not an error). You can prevent this from appearing by disabling DEBUG logging for "</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                        + SESSION_LOGGER_NAME,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">                <span class="built_in">new</span> RuntimeException(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">                        "For debugging purposes only (not an error)"));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    // 根据sessionRepository创建spring <span class="keyword">session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    S <span class="keyword">session</span> = SessionRepositoryFilter.this.sessionRepository.createSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    // 设置<span class="keyword">session</span>的最新访问时间</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">session</span>.setLastAccessedTime(<span class="keyword">System</span>.currentTimeMillis());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    // 包装成HttpSession透明化集成</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">    currentSession = <span class="built_in">new</span> HttpSessionWrapper(<span class="keyword">session</span>, getServletContext());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    // 设置<span class="keyword">session</span>至Requset的<span class="keyword">attribute</span>中，提高同一个request访问<span class="keyword">session</span>的性能</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    setCurrentSession(currentSession);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> currentSession;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>再来看下spring session的持久化。上述<code>SessionRepositoryFilter</code>在包装<code>HttpServletRequest</code>后，执行<code>FilterChain</code>中使用<code>finally</code>保证请求的<code>Session</code>始终<code>session</code>会被提交，此提交操作中将<code>sesionId</code>设置到<code>response</code>的<code>head</code>中并将<code>session</code>持久化至存储器中。<br>持久化只持久spring session，并不是将spring session包装后的<code>HttpSession</code>持久化，因为<code>HttpSession</code>不过是包装器，持久化没有意义。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Uses the HttpSessionStrategy to write the session id to the response and</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * persist the Session.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void commitSession() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取当前session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    HttpSessionWrapper wrappedSession = getCurrentSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果当前session为空，则删除cookie中的相应的sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (wrappedSession == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (isInvalidateClientSession()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            SessionRepositoryFilter.<span class="keyword">this</span>.httpSessionStrategy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                    .onInvalidateSession(<span class="keyword">this</span>, <span class="keyword">this</span>.response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 从HttpSession中获取当前spring session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        S session = wrappedSession.getSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 持久化spring session至存储器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        SessionRepositoryFilter.<span class="keyword">this</span>.sessionRepository.save(session);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 如果是新创建spring session，sessionId到response的cookie</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!isRequestedSessionIdValid()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                || !session.getId().equals(getRequestedSessionId())) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            SessionRepositoryFilter.<span class="keyword">this</span>.httpSessionStrategy.onNewSession(session,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">this</span>, <span class="keyword">this</span>.response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>再来看下包装的响应<code>SessionRepositoryResponseWrapper</code>。</p>
<h3 id="3-SessionRepositoryResponseWrapper"><a href="#3-SessionRepositoryResponseWrapper" class="headerlink" title="3.SessionRepositoryResponseWrapper"></a>3.SessionRepositoryResponseWrapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Allows ensuring that the session is saved if the response is committed.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rob Winch</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionRepositoryResponseWrapper</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">OnCommittedResponseWrapper</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SessionRepositoryRequestWrapper request;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * Create a new &#123;<span class="doctag">@link</span> SessionRepositoryResponseWrapper&#125;.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> request the request to be wrapped</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> response the response to be wrapped</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    SessionRepositoryResponseWrapper(SessionRepositoryRequestWrapper request,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            HttpServletResponse response) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">super</span>(response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"request cannot be null"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.request = request;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResponseCommitted</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.request.commitSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>上面的注释已经非常详细，这里不再赘述。这里只讲述为什么需要包装原始的响应。从注释上可以看出包装响应时为了：<strong>确保如果响应被提交session能够被保存</strong>。<br>这里我有点疑惑：在上述的<code>SessionRepositoryFilter.doFilterInternal</code>方法中不是已经<code>request.commitSession()</code>了吗，<code>FilterChain</code>执行完或者异常后都会执行<code>Finally</code>中的<code>request.commitSession</code>。为什么这里仍然需要包装响应，为了确保session能够保存，包装器中的<code>onResponseCommitted</code>方法可以看出也是做了一次<code>request.commitSession()</code>。难道这不是多此一举？</p>
<blockquote>
<p>Tips<br>如果有和我相同疑问的同学，那就说明我们的基础都不扎实，对<code>Servlet</code>仍然没有一个清楚全面的认识。对于此问题，我特意在github上提了issuse：<a href="https://github.com/spring-projects/spring-session/issues/1183" target="_blank" rel="noopener">Why is the request.commitSession() method called repeatedly?</a>。</p>
</blockquote>
<p>但是在提完issue后的回家路上，我思考了下<code>response</code>可以有流方式的写，会不会在<code>response.getOutStream</code>写的时候已经将响应全部返回到客户端，这时响应结束。<br>在家中是，spring sesion作者大大已经回复了我的issue：</p>
<blockquote>
<p>Is this causing you problems? The reason is that we need to ensure that the session is created before the response is committed. If the response is already committed there will be no way to track the session (i.e. a cookie cannot be written to the response to keep track of which session id).</p>
</blockquote>
<p>他的意思是：我们需要在<code>response</code>被提交之前确保<code>session</code>被创建。如果<code>response</code>已经被提交，将没有办法追踪<code>session</code>（例如：无法将<code>cookie</code>写入<code>response</code>以跟踪哪个session id）。<br>在此之前我又阅读了JavaTM Servlet Specification，规范中这样解释<code>Response</code>的<code>flushBuffer</code>接口：</p>
<blockquote>
<p>The isCommitted method returns a boolean value indicating whether any response bytes have been returned to the client. The flushBuffer method forces content in the buffer to be written to the client.</p>
</blockquote>
<p>并且看了<code>ServletResponse</code>的<code>flushBuffer</code>的javadocs:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Forces any content in the buffer to be written to the client. A call to</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * this method automatically commits the response, meaning the status code</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * and headers will be written.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException if an I/O occurs during the flushing of the response</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> #setBufferSize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getBufferSize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> #isCommitted</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@see</span> #reset</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span></pre></td></tr></table></figure>

<p>结合以上两点，一旦<code>response</code>执行<code>flushBuffer</code>方法，迫使<code>Response</code>中在<code>Buffer</code>中任何数据都会被返回至<code>client</code>端。这个方法自动提交响应中的status code和head。那么如果不包装请求，监听<code>flushBuffer</code>事件在提交<code>response</code>前，将<code>session</code>写入<code>response</code>和持久化<code>session</code>，将导致作者大大说的无法追踪<code>session</code>。<br><code>SessionRepositoryResponseWrapper</code>继承父类<code>OnCommittedResponseWrapper</code>，其中<code>flushBuffer</code>方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Makes sure &#123;<span class="doctag">@link</span> OnCommittedResponseWrapper#onResponseCommitted()&#125; is invoked</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * before calling the superclass &lt;code&gt;flushBuffer()&lt;/code&gt;.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException if an input or output exception occurred</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    doOnResponseCommitted();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">super</span>.flushBuffer();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Calls &lt;code&gt;onResponseCommmitted()&lt;/code&gt; with the current contents as long as</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #disableOnResponseCommitted()&#125; was not invoked.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">doOnResponseCommitted</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.disableOnCommitted) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        onResponseCommitted();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        disableOnResponseCommitted();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>重写<code>HttpServletResponse</code>方法，监听response commit，当发生response commit时，可以在commit之前写session至response中并持久化session。</p>
<blockquote>
<p>Tips:<br>spring mvc中<code>HttpMessageConverters</code>使用到的<code>jackson</code>即调用了<code>outstream.flushBuffer()</code>，当使用<code>@ResponseBody</code>时。</p>
</blockquote>
<p>以上做法固然合理，但是如此重复操作两次commit，存在两次persist session?<br>这个问题后面涉及<code>SessionRepository</code>时再详述！<br>再看<code>SessionRepository</code>之前，先来看下spring session中的session接口。</p>
<h3 id="3-Session接口"><a href="#3-Session接口" class="headerlink" title="3.Session接口"></a>3.Session接口</h3><p>spring-session和tomcat中的Session的实现模式上有很大不同，tomcat中直接对<code>HttpSession</code>接口进行实现，而spring-session中则抽象出单独的<code>Session</code>层接口，让后再使用适配器模式将<code>Session</code>适配层<code>Servlet</code>规范中的<code>HttpSession</code>。spring-sesion中关于<code>session</code>的实现和适配整个UML类图如下：</p>
<p><img src="http://image.winrains.cn/2019/09/74e77-1286175-20180918232404171-1125631131.png" alt="http://image.winrains.cn/2019/09/74e77-1286175-20180918232404171-1125631131.png"></p>
<blockquote>
<p>Tips：适配器模式<br>spring-session单独抽象出<code>Session</code>层接口，可以应对多种场景下不同的<code>session</code>的实现，然后通过适配器模式将<code>Session</code>适配成<code>HttpSession</code>的接口，精妙至极！</p>
</blockquote>
<p><code>Session</code>是spring-session对<code>session</code>的抽象，主要是为了鉴定用户，为Http请求和响应提供上下文过程，该<code>Session</code>可以被<code>HttpSession</code>、WebSocket Session，非WebSession等使用。定义了<code>Session</code>的基本行为：</p>
<ul>
<li>getId：获取sessionId</li>
<li>setAttribute：设置session属性</li>
<li>getAttribte：获取session属性</li>
</ul>
<p><code>ExipringSession</code>：提供Session额外的过期特性。定义了以下关于过期的行为：</p>
<ul>
<li>setLastAccessedTime：设置最近Session会话过程中最近的访问时间</li>
<li>getLastAccessedTime：获取最近的访问时间</li>
<li>setMaxInactiveIntervalInSeconds：设置Session的最大闲置时间</li>
<li>getMaxInactiveIntervalInSeconds：获取最大闲置时间</li>
<li>isExpired：判断Session是否过期</li>
</ul>
<p><code>MapSession</code>：基于<code>java.util.Map</code>的<code>ExpiringSession</code>的实现<br><code>RedisSession</code>：基于<code>MapSession</code>和Redis的<code>ExpiringSession</code>实现，提供<code>Session</code>的持久化能力<br>先来看下<code>MapSession</code>的代码源码片段</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> class MapSession implements ExpiringSession, Serializable &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * Default &#123;@link #setMaxInactiveIntervalInSeconds(int)&#125; (30 minutes).</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> DEFAULT_MAX_INACTIVE_INTERVAL_SECONDS = <span class="number">1800</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; sessionAttrs = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> creationTime = System.currentTimeMillis();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastAccessedTime = <span class="keyword">this</span>.creationTime;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * Defaults to 30 minutes.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> maxInactiveInterval = DEFAULT_MAX_INACTIVE_INTERVAL_SECONDS;</span></pre></td></tr></table></figure>

<p><code>MapSession</code>中持有<code>HashMap</code>类型的变量<code>sessionAtts</code>用于存储<code>Session</code>设置属性，比如调用的<code>setAttribute</code>方法的<code>k-v</code>就存储在该<code>HashMap</code>中。这个和tomcat内部实现<code>HttpSession</code>的方式类似，tomcat中使用了<code>ConcurrentHashMap</code>存储。<br>其中<code>lastAccessedTime</code>用于记录最近的一次访问时间，<code>maxInactiveInterval</code>用于记录<code>Session</code>的最大闲置时间（过期时间-针对没有<code>Request</code>活跃的情况下的最大时间，即相对于最近一次访问后的最大闲置时间）。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(<span class="keyword">String</span> attributeName, Object attributeValue)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (attributeValue == null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        removeAttribute(attributeName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.sessionAttrs.<span class="built_in">put</span>(attributeName, attributeValue);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><code>setAttribute</code>方法极其简单，null时就移除<code>attributeName</code>，否则put存储。<br>重点熟悉<code>RedisSession</code>如何实现<code>Session</code>的行为：<code>setAttribute</code>、<code>persistence</code>等。</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * A custom implementation of &#123;<span class="doctag">@link</span> Session&#125; that uses a &#123;<span class="doctag">@link</span> MapSession&#125; as the</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * basis for its mapping. It keeps track of any attributes that have changed. When</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.session.data.redis.RedisOperationsSessionRepository.RedisSession#saveDelta()&#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * is invoked all the attributes that have been changed will be persisted.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rob Winch</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisSession</span> <span class="keyword">implements</span> <span class="title">ExpiringSession</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapSession cached;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">Long</span> originalLastAccessTime;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; delta = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isNew;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> String originalPrincipalName;</span></pre></td></tr></table></figure>

<p>首先看javadocs，对于阅读源码，学会看javadocs非常重要！<br>基于<code>MapSession</code>的基本映射实现的<code>Session</code>，能够追踪发生变化的所有属性，当调用<code>saveDelta</code>方法后，变化的属性将被持久化！<br>在<code>RedisSession</code>中有两个非常重要的成员属性：</p>
<ul>
<li>cached：实际上是一个<code>MapSession</code>实例，用于做本地缓存，每次在<code>getAttribute</code>时无需从Redis中获取，主要为了improve性能</li>
<li>delta：用于跟踪变化数据，做持久化</li>
</ul>
<p>再来看下<code>RedisSession</code>中最为重要的行为saveDelta——持久化Session至Redis中：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Saves any attributes that have been changed and updates the expiration of this</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * session.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void saveDelta() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果delta为空，则Session中没有任何数据需要存储</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.delta.isEmpty()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    String sessionId = getId();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 使用spring data redis将delta中的数据保存至Redis中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    getSessionBoundHashOperations(sessionId).putAll(<span class="keyword">this</span>.delta);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    String principalSessionKey = getSessionAttrNameKey(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            FindByIndexNameSessionRepository.PRINCIPAL_NAME_INDEX_NAME);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    String securityPrincipalSessionKey = getSessionAttrNameKey(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            SPRING_SECURITY_CONTEXT);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.delta.containsKey(principalSessionKey)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            || <span class="keyword">this</span>.delta.containsKey(securityPrincipalSessionKey)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.originalPrincipalName != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            String originalPrincipalRedisKey = getPrincipalKey(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">this</span>.originalPrincipalName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            RedisOperationsSessionRepository.<span class="keyword">this</span>.sessionRedisOperations</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                    .boundSetOps(originalPrincipalRedisKey).remove(sessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        String principal = PRINCIPAL_NAME_RESOLVER.resolvePrincipal(<span class="keyword">this</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.originalPrincipalName = principal;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (principal != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            String principalRedisKey = getPrincipalKey(principal);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            RedisOperationsSessionRepository.<span class="keyword">this</span>.sessionRedisOperations</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">                    .boundSetOps(principalRedisKey).add(sessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 清空delta，代表没有任何需要持久化的数据。同时保证</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//SessionRepositoryFilter和SessionRepositoryResponseWrapper的onResponseCommitted</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//只会持久化一次Session至Redis中，解决前面提到的疑问</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta = new HashMap&lt;String, Object&gt;(<span class="keyword">this</span>.delta.size());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 更新过期时间，滚动至下一个过期时间间隔的时刻</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Long</span> originalExpiration = <span class="keyword">this</span>.originalLastAccessTime == <span class="literal">null</span> ? <span class="literal">null</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">            : <span class="keyword">this</span>.originalLastAccessTime + TimeUnit.SECONDS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                    .toMillis(getMaxInactiveIntervalInSeconds());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    RedisOperationsSessionRepository.<span class="keyword">this</span>.expirationPolicy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">            .onExpirationUpdated(originalExpiration, <span class="keyword">this</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>从javadoc中可以看出，<code>saveDelta</code>用于存储<code>Session</code>的属性：</p>
<ol>
<li>保存<code>Session</code>中的属性数据至Redis中</li>
<li>清空delta中数据，防止重复提交Session中的数据</li>
<li>更新过期时间至下一个过期时间间隔的时刻</li>
</ol>
<p>再看下<code>RedisSession</code>中的其他行为</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置session的存活时间，即最大过期时间。先保存至本地缓存，然后再保存至delta</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxInactiveIntervalInSeconds</span><span class="params">(<span class="keyword">int</span> interval)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.cached.setMaxInactiveIntervalInSeconds(interval);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta.<span class="built_in">put</span>(MAX_INACTIVE_ATTR, getMaxInactiveIntervalInSeconds());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    flushImmediateIfNecessary();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接从本地缓存获取过期时间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxInactiveIntervalInSeconds</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.cached.getMaxInactiveIntervalInSeconds();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接从本地缓存中获取Session中的属性</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(<span class="string">"unchecked"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getAttribute</span><span class="params">(<span class="keyword">String</span> attributeName)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.cached.getAttribute(attributeName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存Session属性至本地缓存和delta中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(<span class="keyword">String</span> attributeName, Object attributeValue)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.cached.setAttribute(attributeName, attributeValue);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta.<span class="built_in">put</span>(getSessionAttrNameKey(attributeName), attributeValue);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    flushImmediateIfNecessary();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>除了<code>MapSession</code>和<code>RedisSession</code>还有<code>JdbcSession</code>、<code>MongoExpiringSession</code>，感兴趣的读者可以自行阅读。<br>下面看<code>SessionRepository</code>的逻辑。<code>SessionRepository</code>是spring session中用于管理spring session的核心组件。</p>
<h3 id="4-SessionRepository"><a href="#4-SessionRepository" class="headerlink" title="4. SessionRepository"></a>4. SessionRepository</h3><blockquote>
<p>A repository interface for managing {@link Session} instances.</p>
</blockquote>
<p>javadoc中描述<code>SessionRepository</code>为管理spring-session的接口实例。抽象出：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function">S <span class="title">createSession</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save</span><span class="params">(S session)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function">S <span class="title">getSession</span><span class="params">(<span class="keyword">String</span> id)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">String</span> id)</span></span>;</span></pre></td></tr></table></figure>

<p>创建、保存、获取、删除<code>Session</code>的接口行为。根据<code>Session</code>的不同，分为很多种<code>Session</code>操作仓库。</p>
<p><img src="http://image.winrains.cn/2019/09/3e301-1286175-20180918232433276-1511319332.png" alt="http://image.winrains.cn/2019/09/3e301-1286175-20180918232433276-1511319332.png"></p>
<p>这里重点介绍下<code>RedisOperationsSessionRepository</code>。在详细介绍其之前，了解下<code>RedisOperationsSessionRepository</code>的数据存储细节。<br>当创建一个RedisSession，然后存储在Redis中时，<code>RedisSession</code>的存储细节如下：<br>spring:session:sessions:33fdd1b6-b496-4b33-9f7d-df96679d32fe<br>spring:session:sessions:expires:33fdd1b6-b496-4b33-9f7d-df96679d32fe<br>spring:session:expirations:1439245080000<br>Redis会为每个<code>RedisSession</code>存储三个<code>k-v</code>。</p>
<ol>
<li>第一个<code>k-v</code>用来存储<code>Session</code>的详细信息，包括<code>Session</code>的过期时间间隔、最近的访问时间、attributes等等。这个k的过期时间为<code>Session</code>的最大过期时间 + 5分钟。如果默认的最大过期时间为30分钟，则这个k的过期时间为35分钟</li>
<li>第二个k-v用来表示<code>Session</code>在Redis中的过期，这个k-v不存储任何有用数据，只是表示<code>Session</code>过期而设置。这个k在Redis中的过期时间即为Session的过期时间间隔</li>
<li>第三个k-v存储这个<code>Session</code>的id，是一个<code>Set</code>类型的Redis数据结构。这个k中的最后的1439245080000值是一个时间戳，根据这个<code>Session</code>过期时刻滚动至下一分钟而计算得出。</li>
</ol>
<p>这里不由好奇，为什么一个<code>RedisSession</code>却如此复杂的存储。关于这个可以参考spring-session作者本人在github上的两篇回答：<br><a href="https://github.com/spring-projects/spring-session/issues/92" target="_blank" rel="noopener">Why does Spring Session use spring:session:expirations?</a><br><a href="https://github.com/spring-projects/spring-session/commit/d96c8f2ce5968ced90cb43009156a61bd21853d1" target="_blank" rel="noopener">Clarify Redis expirations and cleanup task</a><br>简单描述下，为什么<code>RedisSession</code>的存储用到了三个Key，而非一个Redis过期Key。<br>对于<code>Session</code>的实现，需要支持<code>HttpSessionEvent</code>，即<code>Session</code>创建、过期、销毁等事件。当应用用监听器设置监听相应事件，<code>Session</code>发生上述行为时，监听器能够做出相应的处理。<br>Redis的强大之处在于支持KeySpace Notifiction——键空间通知。即可以监视某个key的变化，如删除、更新、过期。当key发生上述行为是，以便可以接受到变化的通知做出相应的处理。具体详情可以参考：<br><a href="https://redis.io/topics/notifications" target="_blank" rel="noopener">Redis Keyspace Notifications</a><br>但是Redis中带有过期的key有两种方式：</p>
<ul>
<li>当访问时发现其过期</li>
<li>Redis后台逐步查找过期键</li>
</ul>
<p>当访问时发现其过期，会产生过期事件，但是无法保证key的过期时间抵达后立即生成过期事件。具体可以参考：<a href="https://redis.io/topics/notifications" target="_blank" rel="noopener">Timing of expired events</a><br>spring-session为了能够及时的产生Session的过期时的过期事件，所以增加了：<br>spring:session:sessions:expires:33fdd1b6-b496-4b33-9f7d-df96679d32fe<br>spring:session:expirations:1439245080000<br>spring-session中有个定时任务，每个整分钟都会查询相应的<strong><code>spring:session:expirations</code>:整分钟的时间戳</strong>中的过期SessionId，然后再访问一次这个SessionId，即<strong><code>spring:session:sessions:expires:SessionId</code></strong>，以便能够让Redis及时的产生key过期事件——即Session过期事件。<br>接下来再看下<code>RedisOperationsSessionRepository</code>中的具体实现原理</p>
<h4 id="createSession方法："><a href="#createSession方法：" class="headerlink" title="createSession方法："></a>createSession方法：</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RedisSession createSession() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// new一个RedisSession实例</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    RedisSession redisSession = new RedisSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果设置的最大过期时间不为空，则设置RedisSession的过期时间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMaxInactiveInterval != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        redisSession.setMaxInactiveIntervalInSeconds(<span class="keyword">this</span>.defaultMaxInactiveInterval);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> redisSession;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>再来看下<code>RedisSession</code>的构造方法：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Creates a new instance ensuring to mark all of the new attributes to be</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * persisted in the next save operation.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">RedisSession() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置本地缓存为MapSession</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> MapSession());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置Session的基本属性</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta.<span class="built_in">put</span>(CREATION_TIME_ATTR, getCreationTime());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta.<span class="built_in">put</span>(MAX_INACTIVE_ATTR, getMaxInactiveIntervalInSeconds());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.delta.<span class="built_in">put</span>(LAST_ACCESSED_ATTR, getLastAccessedTime());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 标记Session的是否为新创建</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.isNew = <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 持久化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    flushImmediateIfNecessary();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="save方法："><a href="#save方法：" class="headerlink" title="save方法："></a>save方法：</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public void save(RedisSession session) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 调用RedisSession的saveDelta持久化Session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    session.save<span class="constructor">Delta()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果Session为新创建，则发布一个Session创建的事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (session.is<span class="constructor">New()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        String sessionCreatedKey = get<span class="constructor">SessionCreatedChannel(<span class="params">session</span>.<span class="params">getId</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        this.sessionRedisOperations.convert<span class="constructor">AndSend(<span class="params">sessionCreatedKey</span>, <span class="params">session</span>.<span class="params">delta</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        session.set<span class="constructor">New(<span class="params">false</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="getSession方法："><a href="#getSession方法：" class="headerlink" title="getSession方法："></a>getSession方法：</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据SessionId获取Session，这里的false代表的参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指：如果Session已经过期，是否仍然获取返回</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RedisSession <span class="title">getSession</span><span class="params">(<span class="keyword">String</span> id)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> getSession(id, <span class="literal">false</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在有些情况下，<code>Session</code>过期，仍然需要能够获取到<code>Session</code>。这里先来看下<code>getSession(String id, boolean allowExpired)</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RedisSession get<span class="constructor">Session(String <span class="params">id</span>, <span class="params">boolean</span> <span class="params">allowExpired</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 根据SessionId，从Redis获取到持久化的Session信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Map&lt;Object, Object&gt; entries = get<span class="constructor">SessionBoundHashOperations(<span class="params">id</span>)</span>.entries<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果Redis中没有，则返回null</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (entries.is<span class="constructor">Empty()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        return null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 根据Session信息，加载创建一个MapSession对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    MapSession loaded = load<span class="constructor">Session(<span class="params">id</span>, <span class="params">entries</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//  判断是否允许过期获取和Session是否过期</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!allowExpired<span class="operator"> &amp;&amp; </span>loaded.is<span class="constructor">Expired()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        return null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 根据MapSession new一个信息的RedisSession，此时isNew为false</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    RedisSession result = <span class="keyword">new</span> <span class="constructor">RedisSession(<span class="params">loaded</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置最新的访问时间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    result.originalLastAccessTime = loaded.get<span class="constructor">LastAccessedTime()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    return result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这里需要注意的是<code>loaded.isExpired()</code>和<code>loadSession</code>。<code>loaded.isExpired</code>判断<code>Session</code>是否过期，如果过期返回null：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> boolean isExpired() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 根据当前时间判断是否过期</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> isExpired(System.currentTimeMillis());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">boolean isExpired(long now) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果maxInactiveInterval小于0，表示Session永不过期</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.maxInactiveInterval &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 最大过期时间单位转换为毫秒</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 当前时间减去Session的最大有效期间隔以获取理论上有效的上一次访问时间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 然后在与实际的上一次访问时间进行比较</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果大于，表示理论上的时间已经在实际的访问时间之后，那么表示Session已经过期</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> now - TimeUnit.SECONDS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            .toMillis(<span class="keyword">this</span>.maxInactiveInterval) &gt;= <span class="keyword">this</span>.lastAccessedTime;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><code>loadSession</code>中，将Redis中存储的<code>Session</code>信息转换为<code>MapSession</code>对象，以便从<code>Session</code>中获取属性时能够从内存直接获取提高性能：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MapSession load<span class="constructor">Session(String <span class="params">id</span>, Map&lt;Object, Object&gt; <span class="params">entries</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    MapSession loaded = <span class="keyword">new</span> <span class="constructor">MapSession(<span class="params">id</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    for (Map.Entry&lt;Object, Object&gt; entry : entries.entry<span class="constructor">Set()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        String key = (String) entry.get<span class="constructor">Key()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">CREATION_TIME_ATTR</span>.</span></span>equals(key)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            loaded.set<span class="constructor">CreationTime((Long)</span> entry.get<span class="constructor">Value()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">MAX_INACTIVE_ATTR</span>.</span></span>equals(key)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            loaded.set<span class="constructor">MaxInactiveIntervalInSeconds((Integer)</span> entry.get<span class="constructor">Value()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">LAST_ACCESSED_ATTR</span>.</span></span>equals(key)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            loaded.set<span class="constructor">LastAccessedTime((Long)</span> entry.get<span class="constructor">Value()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (key.starts<span class="constructor">With(SESSION_ATTR_PREFIX)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            loaded.set<span class="constructor">Attribute(<span class="params">key</span>.<span class="params">substring</span>(SESSION_ATTR_PREFIX.<span class="params">length</span>()</span>),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                    entry.get<span class="constructor">Value()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    return loaded;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>至此，可以看出spring-session中<code>request.getSession(false)</code>的过期实现原理。</p>
<h4 id="delete方法："><a href="#delete方法：" class="headerlink" title="delete方法："></a>delete方法：</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> <span class="type">void</span> <span class="keyword">delete</span>(String sessionId) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    // 获取<span class="keyword">Session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    RedisSession <span class="keyword">session</span> = getSession(sessionId, <span class="keyword">true</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">session</span> == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    cleanupPrincipalIndex(<span class="keyword">session</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    // 从过期集合中移除sessionId</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    this.expirationPolicy.onDelete(<span class="keyword">session</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    String expireKey = getExpiredKey(<span class="keyword">session</span>.getId());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    // 删除<span class="keyword">session</span>的过期键</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    this.sessionRedisOperations.<span class="keyword">delete</span>(expireKey);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    // 设置<span class="keyword">session</span>过期</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">session</span>.setMaxInactiveIntervalInSeconds(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    save(<span class="keyword">session</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>至此<code>RedisOperationsSessionRepository</code>的核心原理就介绍完毕。但是<code>RedisOperationsSessionRepository</code>中还包括关于<code>Session</code>事件的处理和清理<code>Session</code>的定时任务。这部分内容在后述的<code>SessionEvent</code>部分介绍。</p>
<h4 id="5-HttpSessionStrategy"><a href="#5-HttpSessionStrategy" class="headerlink" title="5. HttpSessionStrategy"></a>5. HttpSessionStrategy</h4><blockquote>
<p>A strategy for mapping HTTP request and responses to a {@link Session}.</p>
</blockquote>
<p>从javadoc中可以看出，<code>HttpSessionStrategy</code>是建立<code>Request/Response</code>和<code>Session</code>之间的映射关系的策略。</p>
<blockquote>
<p>Tips：策略模式<br>策略模式是一个传神的神奇模式，是java的多态非常典型应用，是开闭原则、迪米特法则的具体体现。将同类型的一系列的算法封装在不同的类中，通过使用接口注入不同类型的实现，以达到的高扩展的目的。一般是定义一个策略接口，按照不同的场景实现各自的策略。</p>
</blockquote>
<p>该策略接口中定义一套策略行为：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据请求获取SessionId，即建立请求至Session的映射关系</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">String</span> <span class="title">getRequestedSessionId</span><span class="params">(HttpServletRequest request)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于新创建的Session，通知客户端</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onNewSession</span><span class="params">(Session session, HttpServletRequest request,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">            HttpServletResponse response)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于session无效，通知客户端</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onInvalidateSession</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span>;</span></pre></td></tr></table></figure>

<p>如下UML类图：</p>
<p><img src="http://image.winrains.cn/2019/09/cd758-1286175-20180918232504852-612980271.png" alt="http://image.winrains.cn/2019/09/cd758-1286175-20180918232504852-612980271.png"></p>
<p>这里主要介绍<code>CookieHttpSessionStrategy</code>，这个也是默认的策略，可以查看spring-session中类<code>SpringHttpSessionConfiguration</code>，在注册<code>SessionRepositoryFilter</code> Bean时默认采用<code>CookieHttpSessionStrategy</code>：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;S extends ExpiringSession&gt; SessionRepositoryFilter&lt;? extends ExpiringSession&gt; springSessionRepositoryFilter(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        SessionRepository&lt;S&gt; sessionRepository) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    SessionRepositoryFilter&lt;S&gt; sessionRepositoryFilter = new SessionRepositoryFilter&lt;S&gt;(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            sessionRepository);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    sessionRepositoryFilter.setServletContext(<span class="keyword">this</span>.servletContext);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.httpSessionStrategy instanceof MultiHttpSessionStrategy) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        sessionRepositoryFilter.setHttpSessionStrategy(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                (MultiHttpSessionStrategy) <span class="keyword">this</span>.httpSessionStrategy);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        sessionRepositoryFilter.setHttpSessionStrategy(<span class="keyword">this</span>.httpSessionStrategy);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> sessionRepositoryFilter;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>下面来分析<code>CookieHttpSessionStrategy</code>的原理。该策略使用<code>Cookie</code>来映射<code>Request/Response</code>至<code>Session</code>。即<code>request/requset</code>的head中cookie存储SessionId，当请求至web服务器，可以解析请求head中的cookie，然后获取<code>sessionId</code>，根据<code>sessionId</code>获取spring-session。当创建新的<code>session</code>或者<code>session</code>过期，将相应的<code>sessionId</code>写入response的set-cookie或者从respose中移除<code>sessionId</code>。</p>
<h4 id="getRequestedSessionId方法"><a href="#getRequestedSessionId方法" class="headerlink" title="getRequestedSessionId方法"></a>getRequestedSessionId方法</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">String</span> <span class="title">getRequestedSessionId</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取当前请求的sessionId：session别名和sessionId映射</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; sessionIds = getSessionIds(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取当前请求的Session别名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> sessionAlias = getCurrentSessionAlias(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取相应别名的sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> sessionIds.<span class="built_in">get</span>(sessionAlias);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>接下来看下具体获取<code>SessionIds</code>的具体过程：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public <span class="built_in">String</span> getRequestedSessionId(HttpServletRequest request) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取当前请求的sessionId：session别名和sessionId映射</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; sessionIds = getSessionIds(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取当前请求的Session别名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">String</span> sessionAlias = getCurrentSessionAlias(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取相应别名的sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> sessionIds.<span class="keyword">get</span>(sessionAlias);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">public <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; getSessionIds(HttpServletRequest request) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 解析request中的cookie值</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; cookieValues = <span class="keyword">this</span>.cookieSerializer.readCookieValues(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">String</span> sessionCookieValue = cookieValues.isEmpty() ? <span class="string">""</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            : cookieValues.iterator().next();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 根据分词器对sessionId进行分割，因为spring-session支持多session。默认情况只有一个session</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    StringTokenizer tokens = <span class="keyword">new</span> StringTokenizer(sessionCookieValue, <span class="keyword">this</span>.deserializationDelimiter);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果只有一个session，则设置默认别名为0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (tokens.countTokens() == <span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        result.put(DEFAULT_ALIAS, tokens.nextToken());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果有多个session，则建立别名和sessionId的映射</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (tokens.hasMoreTokens()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">String</span> alias = tokens.nextToken();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!tokens.hasMoreTokens()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">String</span> id = tokens.nextToken();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        result.put(alias, id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; readCookieValues(HttpServletRequest request) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取request的cookie</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    Cookie[] cookies = request.getCookies();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; matchingCookieValues = <span class="keyword">new</span> ArrayList&lt;<span class="built_in">String</span>&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (cookies != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// 如果是以SESSION开头，则表示是SessionId，毕竟cookie不只有sessionId，还有可能存储其他内容</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.cookieName.equals(cookie.getName())) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 决策是否需要base64 decode</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">                <span class="built_in">String</span> sessionId = <span class="keyword">this</span>.useBase64Encoding</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">                        ? base64Decode(cookie.getValue()) : cookie.getValue();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">if</span> (sessionId == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.jvmRoute != <span class="keyword">null</span> &amp;&amp; sessionId.endsWith(<span class="keyword">this</span>.jvmRoute)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">                    sessionId = sessionId.substring(<span class="number">0</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">                            sessionId.length() - <span class="keyword">this</span>.jvmRoute.length());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 存入list中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">                matchingCookieValues.add(sessionId);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> matchingCookieValues;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>再来看下获取当前request对应的<code>Session</code>的别名方法<code>getCurrentSessionAlias</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String getCurrentSessionAlias(HttpServletRequest request) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果session参数为空，则返回默认session别名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.sessionParam == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> DEFAULT_ALIAS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 从request中获取session别名，如果为空则返回默认别名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    String u = request.getParameter(<span class="keyword">this</span>.sessionParam);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (u == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> DEFAULT_ALIAS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!ALIAS_PATTERN.matcher(u).matches()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> DEFAULT_ALIAS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> u;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>spring-session为了支持多<code>session</code>，才弄出多个<code>session</code>别名。当时一般应用场景都是一个<code>session</code>，都是默认的<code>session</code>别名0。<br>上述获取<code>sessionId</code>和别名映射关系中，也是默认别名0。这里返回别名0，所以返回当前请求对应的<code>sessionId</code>。</p>
<h3 id="onNewSession方法"><a href="#onNewSession方法" class="headerlink" title="onNewSession方法"></a>onNewSession方法</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewSession</span><span class="params">(Session session, HttpServletRequest request,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">        HttpServletResponse response)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 从当前request中获取已经写入Cookie的sessionId集合</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Set&lt;<span class="keyword">String</span>&gt; sessionIdsWritten = getSessionIdsWritten(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 判断是否包含，如果包含，表示该sessionId已经写入过cookie中，则直接返回</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (sessionIdsWritten.contains(session.getId())) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果没有写入，则加入集合，后续再写入</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    sessionIdsWritten.add(session.getId());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; sessionIds = getSessionIds(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> sessionAlias = getCurrentSessionAlias(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    sessionIds.<span class="built_in">put</span>(sessionAlias, session.getId());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取cookieValue</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> cookieValue = createSessionCookieValue(sessionIds);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//将cookieValue写入Cookie中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.cookieSerializer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            .writeCookieValue(<span class="keyword">new</span> CookieValue(request, response, cookieValue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><code>sessionIdsWritten</code>主要是用来记录已经写入<code>Cookie</code>的<code>SessionId</code>，防止<code>SessionId</code>重复写入<code>Cookie</code>中。</p>
<h4 id="onInvalidateSession方法"><a href="#onInvalidateSession方法" class="headerlink" title="onInvalidateSession方法"></a>onInvalidateSession方法</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidateSession</span><span class="params">(HttpServletRequest request,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">        HttpServletResponse response)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 从当前request中获取sessionId和别名映射</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; sessionIds = getSessionIds(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取别名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> requestedAlias = getCurrentSessionAlias(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 移除sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    sessionIds.<span class="built_in">remove</span>(requestedAlias);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> cookieValue = createSessionCookieValue(sessionIds);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 写入移除后的sessionId</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.cookieSerializer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            .writeCookieValue(<span class="keyword">new</span> CookieValue(request, response, cookieValue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>继续看下具体的写入<code>writeCookieValue</code>原理：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void writeCookieValue(CookieValue cookieValue) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取request/respose和cookie值</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    HttpServletRequest request = cookieValue.getRequest();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    HttpServletResponse response = cookieValue.getResponse();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    String requestedCookieValue = cookieValue.getCookieValue();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    String actualCookieValue = <span class="keyword">this</span>.jvmRoute == <span class="literal">null</span> ? requestedCookieValue</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            : requestedCookieValue + <span class="keyword">this</span>.jvmRoute;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 构造servlet规范中的Cookie对象，注意这里cookieName为：SESSION，表示为Session，</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 上述的从Cookie中读取SessionId，也是使用该cookieName</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    Cookie sessionCookie = new Cookie(<span class="keyword">this</span>.cookieName, <span class="keyword">this</span>.useBase64Encoding</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            ? base64Encode(actualCookieValue) : actualCookieValue);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 设置cookie的属性：secure、path、domain、httpOnly</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    sessionCookie.setSecure(isSecureCookie(request));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    sessionCookie.setPath(getCookiePath(request));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    String domainName = getDomainName(request);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (domainName != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        sessionCookie.setDomain(domainName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.useHttpOnlyCookie) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        sessionCookie.setHttpOnly(<span class="literal">true</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果cookie值为空，则失效</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="string">""</span>.equals(requestedCookieValue)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        sessionCookie.setMaxAge(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        sessionCookie.setMaxAge(<span class="keyword">this</span>.cookieMaxAge);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 写入cookie到response中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    response.addCookie(sessionCookie);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>至此，<code>CookieHttpSessionStrategy</code>介绍结束。<br>由于篇幅过长，关于spring-session event和<code>RedisOperationSessionRepository</code>清理<code>session</code>并且产生过期事件的部分后续文章介绍。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>spring-session提供集群环境下<code>HttpSession</code>的透明集成。spring-session的优势在于开箱即用，具有较强的设计模式。且支持多种持久化方式，其中<code>RedisSession</code>较为成熟，与spring-data-redis整合，可谓威力无穷。</p>
<blockquote>
<p>作者：怀瑾握瑜</p>
<p>来源：<a href="https://www.cnblogs.com/lxyit/p/9672097.html" target="_blank" rel="noopener">https://www.cnblogs.com/lxyit/p/9672097.html</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/27/tomcat%E6%9E%B6%E6%9E%84%E5%88%86%E6%9E%90%EF%BC%9ASession%E7%AE%A1%E7%90%86/" rel="prev" title="tomcat架构分析：Session管理">
      <i class="fa fa-chevron-left"></i> tomcat架构分析：Session管理
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/27/Spring-Session%EF%BC%882%EF%BC%89%EF%BC%9A%E6%8F%AD%E7%A7%98%E7%BB%AD%E7%AF%87/" rel="next" title="Spring Session（2）：揭秘续篇">
      Spring Session（2）：揭秘续篇 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#怀瑾握瑜前言"><span class="nav-number">1.</span> <span class="nav-text">怀瑾握瑜前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-为什么要spring-session"><span class="nav-number">1.1.</span> <span class="nav-text">一.为什么要spring-session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-比较traditional-session方案和spring-session方案"><span class="nav-number">1.2.</span> <span class="nav-text">二.比较traditional-session方案和spring-session方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-JSR340规范与spring-session的透明继承"><span class="nav-number">1.3.</span> <span class="nav-text">三.JSR340规范与spring-session的透明继承</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Session探索"><span class="nav-number">2.</span> <span class="nav-text">Spring Session探索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-特点"><span class="nav-number">2.1.</span> <span class="nav-text">一.特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-工作原理"><span class="nav-number">2.2.</span> <span class="nav-text">二.工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-SessionRepositoryFilter"><span class="nav-number">2.2.1.</span> <span class="nav-text">1. SessionRepositoryFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-SessionRepositoryRequestWrapper"><span class="nav-number">2.2.2.</span> <span class="nav-text">2. SessionRepositoryRequestWrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-SessionRepositoryResponseWrapper"><span class="nav-number">2.2.3.</span> <span class="nav-text">3.SessionRepositoryResponseWrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Session接口"><span class="nav-number">2.2.4.</span> <span class="nav-text">3.Session接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-SessionRepository"><span class="nav-number">2.2.5.</span> <span class="nav-text">4. SessionRepository</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#createSession方法："><span class="nav-number">2.2.5.1.</span> <span class="nav-text">createSession方法：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#save方法："><span class="nav-number">2.2.5.2.</span> <span class="nav-text">save方法：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getSession方法："><span class="nav-number">2.2.5.3.</span> <span class="nav-text">getSession方法：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#delete方法："><span class="nav-number">2.2.5.4.</span> <span class="nav-text">delete方法：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-HttpSessionStrategy"><span class="nav-number">2.2.5.5.</span> <span class="nav-text">5. HttpSessionStrategy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getRequestedSessionId方法"><span class="nav-number">2.2.5.6.</span> <span class="nav-text">getRequestedSessionId方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onNewSession方法"><span class="nav-number">2.2.6.</span> <span class="nav-text">onNewSession方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#onInvalidateSession方法"><span class="nav-number">2.2.6.1.</span> <span class="nav-text">onInvalidateSession方法</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

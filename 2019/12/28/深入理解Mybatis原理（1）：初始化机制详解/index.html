<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="对于任何框架而言，在使用前都要进行一系列的初始化，MyBatis也不例外。本章将通过以下几点详细介绍MyBatis的初始化过程。  1.MyBatis的初始化做了什么\2. MyBatis基于XML配置文件创建Configuration对象的过程\3. 手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象\4. 涉及到的设计模式">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Mybatis原理（1）：初始化机制详解">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2019&#x2F;12&#x2F;28&#x2F;%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mybatis%E5%8E%9F%E7%90%86%EF%BC%881%EF%BC%89%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3&#x2F;index.html">
<meta property="og:site_name" content="congsheng的博客">
<meta property="og:description" content="对于任何框架而言，在使用前都要进行一系列的初始化，MyBatis也不例外。本章将通过以下几点详细介绍MyBatis的初始化过程。  1.MyBatis的初始化做了什么\2. MyBatis基于XML配置文件创建Configuration对象的过程\3. 手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象\4. 涉及到的设计模式">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174356-cf8d5.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174357-5deb8.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174357-68a2c.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174358-57b7c.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174358-6d84a.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174359-724bc.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174359-b7098.png">
<meta property="og:updated_time" content="2019-12-28T12:12:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;10&#x2F;20191016174356-cf8d5.png">

<link rel="canonical" href="http://congsheng.wang/2019/12/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mybatis%E5%8E%9F%E7%90%86%EF%BC%881%EF%BC%89%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>深入理解Mybatis原理（1）：初始化机制详解 | congsheng的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">congsheng的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问：winrains.cn</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2019/12/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mybatis%E5%8E%9F%E7%90%86%EF%BC%881%EF%BC%89%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%BA%E5%88%B6%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="congsheng的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          深入理解Mybatis原理（1）：初始化机制详解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-28 20:12:26" itemprop="dateCreated datePublished" datetime="2019-12-28T20:12:26+08:00">2019-12-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Java技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/Mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">Mybatis</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>对于任何框架而言，在使用前都要进行一系列的初始化，MyBatis也不例外。本章将通过以下几点详细介绍MyBatis的初始化过程。</p>
<blockquote>
<p>1.MyBatis的初始化做了什么<br>\2. MyBatis基于XML配置文件创建<code>Configuration</code>对象的过程<br>\3. 手动加载XML配置文件创建<code>Configuration</code>对象完成初始化，创建并使用<code>SqlSessionFactory</code>对象<br>\4. 涉及到的设计模式</p>
</blockquote>
<a id="more"></a>

<h1 id="一、-MyBatis的初始化做了什么"><a href="#一、-MyBatis的初始化做了什么" class="headerlink" title="一、 MyBatis的初始化做了什么"></a>一、 MyBatis的初始化做了什么</h1><p>任何框架的初始化，无非是加载自己运行时所需要的配置信息。MyBatis的配置信息，大概包含以下信息，其高层级结构如下：<br>× configuration 配置</p>
<p>× properties 属性</p>
<p>× settings 设置</p>
<p>× typeAliases 类型命名</p>
<p>× typeHandlers 类型处理器</p>
<p>× objectFactory 对象工厂</p>
<p>× plugins 插件</p>
<p>× environments 环境</p>
<p>×environment 环境变量</p>
<p>× transactionManager 事务管理器</p>
<p>×dataSource 数据源</p>
<p>×映射器<br>MyBatis的上述配置信息会配置在XML配置文件中，那么，这些信息被加载进入MyBatis内部，MyBatis是怎样维护的呢？<br>MyBatis采用了一个非常直白和简单的方式—使用 <code>org.apache.ibatis.session.Configuration</code> 对象作为一个所有配置信息的容器，<code>Configuration</code>对象的组织结构和XML配置文件的组织结构几乎完全一样（当然，<code>Configuration</code>对象的功能并不限于此，它还负责创建一些MyBatis内部使用的对象，如<code>Executor</code>等，这将在后续的文章中讨论）。如下图所示：<br><img src="http://image.winrains.cn/2019/10/20191016174356-cf8d5.png" alt="img"><br>MyBatis根据初始化好<code>Configuration</code>信息，这时候用户就可以使用MyBatis进行数据库操作了。<br>可以这么说，MyBatis初始化的过程，就是创建 <code>Configuration</code>对象的过程。<br>MyBatis的初始化可以有两种方式：</p>
<ul>
<li>基于XML配置文件：基于XML配置文件的方式是将MyBatis的所有配置信息放在XML文件中，MyBatis通过加载并XML配置文件，将配置文信息组装成内部的<code>Configuration</code>对象</li>
<li>基于Java API：这种方式不使用XML配置文件，需要MyBatis使用者在Java代码中，手动创建<code>Configuration</code>对象，然后将配置参数set 进入<code>Configuration</code>对象中</li>
</ul>
<p>（PS: MyBatis具体配置信息有哪些，又分别表示什么意思，不在本文的叙述范围，读者可以参考我的《Java Persistence withMyBatis 3 (中文版)》 的第二章 引导MyBatis中有详细的描述）<br>接下来我们将通过 基于XML配置文件方式的MyBatis初始化，深入探讨MyBatis是如何通过配置文件构建<code>Configuration</code>对象，并使用它的。</p>
<h1 id="二、MyBatis基于XML配置文件创建Configuration对象的过程"><a href="#二、MyBatis基于XML配置文件创建Configuration对象的过程" class="headerlink" title="二、MyBatis基于XML配置文件创建Configuration对象的过程"></a>二、MyBatis基于XML配置文件创建Configuration对象的过程</h1><p>现在就从使用MyBatis的简单例子入手，深入分析一下MyBatis是怎样完成初始化的，都初始化了什么。看以下代码：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">String resource</span> = <span class="string">"mybatis-config.xml"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">InputStream inputStream</span> = Resources.getResourceAsStream(resource);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">SqlSessionFactory sqlSessionFactory</span> = new SqlSessionFactoryBuilder().build(inputStream);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">SqlSession sqlSession</span> = sqlSessionFactory.openSession();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">List list</span> = sqlSession.selectList(<span class="string">"com.foo.bean.BlogMapper.queryAllBlogInfo"</span>);</span></pre></td></tr></table></figure>

<p>有过MyBatis使用经验的读者会知道，上述语句的作用是执行<code>com.foo.bean.BlogMapper.queryAllBlogInfo</code> 定义的SQL语句，返回一个<code>List</code>结果集。总的来说，上述代码经历了mybatis初始化 –&gt;创建<code>SqlSession</code> –&gt;执行SQL语句 返回结果三个过程。<br>上述代码的功能是根据配置文件<code>mybatis-config.xml</code> 配置文件，创建<code>SqlSessionFactory</code>对象，然后产生<code>SqlSession</code>，执行SQL语句。而mybatis的初始化就发生在第三句：<code>SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</code> 现在就让我们看看第三句到底发生了什么。<br><strong>MyBatis初始化基本过程：</strong><br><code>SqlSessionFactoryBuilder</code>根据传入的数据流生成<code>Configuration</code>对象，然后根据<code>Configuration</code>对象创建默认的<code>SqlSessionFactory</code>实例。<br>初始化的基本过程如下序列图所示：<br><img src="http://image.winrains.cn/2019/10/20191016174357-5deb8.png" alt="img"><br>由上图所示，mybatis初始化要经过简单的以下几步：<br>\1. 调用<code>SqlSessionFactoryBuilder</code>对象的<code>build(inputStream)</code>方法；<br>\2. <code>SqlSessionFactoryBuilder</code>会根据输入流<code>inputStream</code>等信息创建<code>XMLConfigBuilder</code>对象;<br>\3. <code>SqlSessionFactoryBuilder</code>调用<code>XMLConfigBuilder</code>对象的<code>parse()</code>方法；<br>\4. <code>XMLConfigBuilder</code>对象返回<code>Configuration</code>对象；<br>\5. <code>SqlSessionFactoryBuilder</code>根据<code>Configuration</code>对象创建一个<code>DefaultSessionFactory</code>对象；<br>\6. <code>SqlSessionFactoryBuilder</code>返回 <code>DefaultSessionFactory</code>对象给<code>Client</code>，供Client使用。<br><code>SqlSessionFactoryBuilder</code>相关的代码如下所示：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> build(inputStream, null, null);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(InputStream inputStream, <span class="keyword">String</span> environment, Properties properties)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 2. 创建XMLConfigBuilder对象用来解析XML配置文件，生成Configuration对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(inputStream, environment, properties);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 3. 将XML配置文件内的信息解析成Java对象Configuration对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        Configuration <span class="built_in">config</span> = parser.parse();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 4. 根据Configuration对象创建出SqlSessionFactory对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> build(<span class="built_in">config</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">"Error building SqlSession."</span>, e);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125; finally &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        ErrorContext.instance().reset();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            inputStream.<span class="built_in">close</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// Intentionally ignore. Prefer previous error.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从此处可以看出，MyBatis内部通过Configuration对象来创建SqlSessionFactory,用户也可以自己通过API构造好Configuration对象，调用此方法创建SqlSessionFactory</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Configuration <span class="built_in">config</span>)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSqlSessionFactory(<span class="built_in">config</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>上述的初始化过程中，涉及到了以下几个对象：</p>
<ol>
<li><code>SqlSessionFactoryBuilder</code> ： <code>SqlSessionFactory</code>的构造器，用于创建<code>SqlSessionFactory</code>，采用了<code>Builder</code>设计模式</li>
<li><code>Configuration</code> ：该对象是<code>mybatis-config.xml</code>文件中所有mybatis配置信息</li>
<li><code>SqlSessionFactory</code>：<code>SqlSession</code>工厂类，以工厂形式创建<code>SqlSession</code>对象，采用了<code>Factory</code>工厂设计模式</li>
<li><code>XmlConfigParser</code> ：负责将<code>mybatis-config.xml</code>配置文件解析成<code>Configuration</code>对象，共<code>SqlSessonFactoryBuilder</code>使用，创建<code>SqlSessionFactory</code></li>
</ol>
<p><strong>创建Configuration对象的过程</strong><br>接着上述的 MyBatis初始化基本过程讨论，当<code>SqlSessionFactoryBuilder</code>执行<code>build()</code>方法，调用了<code>XMLConfigBuilder</code>的<code>parse()</code>方法，然后返回了<code>Configuration</code>对象。那么<code>parse()</code>方法是如何处理XML文件，生成<code>Configuration</code>对象的呢？<br>\1. <code>XMLConfigBuilder</code>会将XML配置文件的信息转换为<code>Document</code>对象，而XML配置定义文件DTD转换成<code>XMLMapperEntityResolver</code>对象，然后将二者封装到<code>XpathParser</code>对象中，<code>XpathParser</code>的作用是提供根据<code>Xpath</code>表达式获取基本的<code>DOM</code>节点<code>Node</code>信息的操作。如下图所示：<br><img src="http://image.winrains.cn/2019/10/20191016174357-68a2c.png" alt="img"><br><img src="http://image.winrains.cn/2019/10/20191016174358-57b7c.png" alt="img"><br>\2. 之后<code>XMLConfigBuilder</code>调用<code>parse()</code>方法：会从<code>XPathParser</code>中取出<code></code>节点对应的<code>Node</code>对象，然后解析此<code>Node</code>节点的子Node：properties, settings, typeAliases,typeHandlers, objectFactory, objectWrapperFactory, plugins, environments,databaseIdProvider, mappers</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public Configuration parse<span class="literal">()</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (parsed) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">BuilderException(<span class="string">"Each XMLConfigBuilder can only be used once."</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    parsed = <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 源码中没有这一句，只有 parseConfiguration(parser.evalNode("/configuration"));</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 为了让读者看得更明晰，源码拆分为以下两句</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    XNode configurationNode = parser.eval<span class="constructor">Node(<span class="string">"/configuration"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    parse<span class="constructor">Configuration(<span class="params">configurationNode</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    return configuration;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 解析 "/configuration"节点下的子节点信息，然后将解析的结果设置到Configuration对象中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void parse<span class="constructor">Configuration(XNode <span class="params">root</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 1.首先处理properties 节点</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        properties<span class="constructor">Element(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"properties"</span>)</span>); <span class="comment">// issue #117 read</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                                                        <span class="comment">// properties first</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 2.处理typeAliases</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">type</span><span class="constructor">AliasesElement(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"typeAliases"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 3.处理插件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        plugin<span class="constructor">Element(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"plugins"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 4.处理objectFactory</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        object<span class="constructor">FactoryElement(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"objectFactory"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 5.objectWrapperFactory</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        object<span class="constructor">WrapperFactoryElement(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"objectWrapperFactory"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 6.settings</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        settings<span class="constructor">Element(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"settings"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 7.处理environments</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// read it after objectFactory and objectWrapperFactory issue #631</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        environments<span class="constructor">Element(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"environments"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 8.database</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        database<span class="constructor">IdProviderElement(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"databaseIdProvider"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 9. typeHandlers</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">type</span><span class="constructor">HandlerElement(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"typeHandlers"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 10 mappers</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        mapper<span class="constructor">Element(<span class="params">root</span>.<span class="params">evalNode</span>(<span class="string">"mappers"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    &#125; catch (Exception e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">BuilderException(<span class="string">"Error parsing SQL Mapper Configuration. Cause: "</span> + <span class="params">e</span>, <span class="params">e</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>注意：在上述代码中，还有一个非常重要的地方，就是解析XML配置文件子节点``的方法<code>mapperElements(root.evalNode(&quot;mappers&quot;))</code>, 它将解析我们配置的<code>Mapper.xml</code>配置文件，Mapper配置文件可以说是MyBatis的核心，MyBatis的特性和理念都体现在此Mapper的配置和设计上，我们将在后续的文章中讨论它，敬请期待～</strong><br>\3. 然后将这些值解析出来设置到<code>Configuration</code>对象中。<br>解析子节点的过程这里就不一一介绍了，用户可以参照MyBatis源码仔细揣摩，我们就看上述的<code>environmentsElement(root.evalNode(&quot;environments&quot;));</code> 方法是如何将<code>environments</code>的信息解析出来，设置到<code>Configuration</code>对象中的：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 解析environments节点，并将结果设置到Configuration对象中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 注意：创建envronment时，如果SqlSessionFactoryBuilder指定了特定的环境（即数据源）；</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 则返回指定环境（数据源）的Environment对象，否则返回默认的Environment对象； 这种方式实现了MyBatis可以连接多数据源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void environments<span class="constructor">Element(XNode <span class="params">context</span>)</span> throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (context != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (environment<span class="operator"> == </span>null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            environment = context.get<span class="constructor">StringAttribute(<span class="string">"default"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        for (XNode child : context.get<span class="constructor">Children()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            String id = child.get<span class="constructor">StringAttribute(<span class="string">"id"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (is<span class="constructor">SpecifiedEnvironment(<span class="params">id</span>)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 1.创建事务工厂 TransactionFactory</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                TransactionFactory txFactory = transaction<span class="constructor">ManagerElement(<span class="params">child</span>.<span class="params">evalNode</span>(<span class="string">"transactionManager"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                DataSourceFactory dsFactory = data<span class="constructor">SourceElement(<span class="params">child</span>.<span class="params">evalNode</span>(<span class="string">"dataSource"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 2.创建数据源DataSource</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                DataSource dataSource = dsFactory.get<span class="constructor">DataSource()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 3. 构造Environment对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.<span class="constructor">Builder(<span class="params">id</span>)</span>.transaction<span class="constructor">Factory(<span class="params">txFactory</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                        .data<span class="constructor">Source(<span class="params">dataSource</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 4. 将创建的Envronment对象设置到configuration 对象中</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                configuration.set<span class="constructor">Environment(<span class="params">environmentBuilder</span>.<span class="params">build</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> boolean is<span class="constructor">SpecifiedEnvironment(String <span class="params">id</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (environment<span class="operator"> == </span>null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">BuilderException(<span class="string">"No environment specified."</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (id<span class="operator"> == </span>null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">BuilderException(<span class="string">"Environment requires an id attribute."</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (environment.equals(id)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        return <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    return <span class="literal">false</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>\4. 返回Configuration对象<br>我们将上述的MyBatis初始化基本过程的序列图细化，<br><img src="http://image.winrains.cn/2019/10/20191016174358-6d84a.png" alt="img"></p>
<h1 id="三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象"><a href="#三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象" class="headerlink" title="三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象"></a>三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象</h1><p>我们可以使用<code>XMLConfigBuilder</code>手动解析XML配置文件来创建<code>Configuration</code>对象，代码如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">"mybatis-config.xml"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">InputStream inputStream = <span class="module-access"><span class="module"><span class="identifier">Resources</span>.</span></span>get<span class="constructor">ResourceAsStream(<span class="params">resource</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//手动创建XMLConfigBuilder，并解析创建Configuration对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">XMLConfigBuilder parser = <span class="keyword">new</span> <span class="constructor">XMLConfigBuilder(<span class="params">inputStream</span>, <span class="params">null</span>,<span class="params">null</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">Configuration configuration=parse<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用Configuration对象创建SqlSessionFactory</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> <span class="constructor">SqlSessionFactoryBuilder()</span>.build(configuration);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用MyBatis</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">SqlSession sqlSession = sqlSessionFactory.<span class="keyword">open</span><span class="constructor">Session()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">List <span class="built_in">list</span> = sqlSession.select<span class="constructor">List(<span class="string">"com.foo.bean.BlogMapper.queryAllBlogInfo"</span>)</span>;</span></pre></td></tr></table></figure>

<h1 id="四、涉及到的设计模式"><a href="#四、涉及到的设计模式" class="headerlink" title="四、涉及到的设计模式"></a>四、涉及到的设计模式</h1><p>初始化的过程涉及到创建各种对象，所以会使用一些<strong>创建型的设计模式</strong>。在初始化的过程中，Builder模式运用的比较多。<br><strong>Builder模式应用1： SqlSessionFactory的创建</strong><br>对于创建<code>SqlSessionFactory</code>时，会根据情况提供不同的参数，其参数组合可以有以下几种：<br><img src="http://image.winrains.cn/2019/10/20191016174359-724bc.png" alt="img"><br>由于构造时参数不定，可以为其创建一个构造器<code>Builder</code>，将<code>SqlSessionFactory</code>的构建过程和表示分开：<br><img src="http://image.winrains.cn/2019/10/20191016174359-b7098.png" alt="img"><br>MyBatis将<code>SqlSessionFactoryBuilder</code>和<code>SqlSessionFactory</code>相互独立。<br><strong>Builder模式应用2： 数据库连接环境Environment对象的创建</strong><br>在构建<code>Configuration</code>对象的过程中，<code>XMLConfigParser</code>解析 mybatis XML配置文件节点``节点时，会有以下相应的代码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void environments<span class="constructor">Element(XNode <span class="params">context</span>)</span> throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (context != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (environment<span class="operator"> == </span>null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            environment = context.get<span class="constructor">StringAttribute(<span class="string">"default"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        for (XNode child : context.get<span class="constructor">Children()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            String id = child.get<span class="constructor">StringAttribute(<span class="string">"id"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// 是和默认的环境相同时，解析之</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (is<span class="constructor">SpecifiedEnvironment(<span class="params">id</span>)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                TransactionFactory txFactory = transaction<span class="constructor">ManagerElement(<span class="params">child</span>.<span class="params">evalNode</span>(<span class="string">"transactionManager"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                DataSourceFactory dsFactory = data<span class="constructor">SourceElement(<span class="params">child</span>.<span class="params">evalNode</span>(<span class="string">"dataSource"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                DataSource dataSource = dsFactory.get<span class="constructor">DataSource()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">// 使用了Environment内置的构造器Builder，传递id 事务工厂和数据源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                Environment.Builder environmentBuilder = <span class="keyword">new</span> Environment.<span class="constructor">Builder(<span class="params">id</span>)</span>.transaction<span class="constructor">Factory(<span class="params">txFactory</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                        .data<span class="constructor">Source(<span class="params">dataSource</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                configuration.set<span class="constructor">Environment(<span class="params">environmentBuilder</span>.<span class="params">build</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在<code>Environment</code>内部，定义了静态内部<code>Builder</code>类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Environment</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionFactory transactionFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Environment(String id, TransactionFactory transactionFactory, DataSource dataSource) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (id == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">"Parameter 'id' must not be null"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (transactionFactory == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">"Parameter 'transactionFactory' must not be null"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.id = id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (dataSource == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> new IllegalArgumentException(<span class="string">"Parameter 'dataSource' must not be null"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.transactionFactory = transactionFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.dataSource = dataSource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> static <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">private</span> String id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">private</span> TransactionFactory transactionFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">private</span> DataSource dataSource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Builder(String id) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">this</span>.id = id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Builder transactionFactory(TransactionFactory transactionFactory) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">this</span>.transactionFactory = transactionFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Builder dataSource(DataSource dataSource) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">this</span>.dataSource = dataSource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> String id() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Environment build() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> new Environment(<span class="keyword">this</span>.id, <span class="keyword">this</span>.transactionFactory, <span class="keyword">this</span>.dataSource);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> String getId() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> TransactionFactory getTransactionFactory() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.transactionFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> DataSource getDataSource() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dataSource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<blockquote>
<p>作者：亦山</p>
<p>来源：<a href="https://blog.csdn.net/luanlouis/article/details/37744073" target="_blank" rel="noopener">https://blog.csdn.net/luanlouis/article/details/37744073</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/12/28/InnoDB-MVCC-%E8%AF%A6%E8%A7%A3/" rel="prev" title="InnoDB MVCC 详解">
      <i class="fa fa-chevron-left"></i> InnoDB MVCC 详解
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/12/28/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Mybatis%E5%8E%9F%E7%90%86%EF%BC%882%EF%BC%89%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E4%B8%8E%E8%BF%9E%E6%8E%A5%E6%B1%A0/" rel="next" title="深入理解Mybatis原理（2）：数据源与连接池">
      深入理解Mybatis原理（2）：数据源与连接池 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、-MyBatis的初始化做了什么"><span class="nav-number">1.</span> <span class="nav-text">一、 MyBatis的初始化做了什么</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、MyBatis基于XML配置文件创建Configuration对象的过程"><span class="nav-number">2.</span> <span class="nav-text">二、MyBatis基于XML配置文件创建Configuration对象的过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象"><span class="nav-number">3.</span> <span class="nav-text">三、手动加载XML配置文件创建Configuration对象完成初始化，创建并使用SqlSessionFactory对象</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、涉及到的设计模式"><span class="nav-number">4.</span> <span class="nav-text">四、涉及到的设计模式</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

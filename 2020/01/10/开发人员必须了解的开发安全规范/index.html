<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="安全问题其实是很多程序员想了解又容易忽略的问题，但需要我们重视起来，提高应用程序的安全性。常出现的安全问题包括，程序接受数据可能来源于未经验证的用户，网络连接和其他不受信任的来源，如果未对程序接受数据进行校验，则可能会引发安全问题等等，具体也可以分成以下几方面：  数据校验 敏感信息 加密算法 序列化与反序列化 I&#x2F;O操作 多线程安全 框架和组件">
<meta name="keywords" content="规范">
<meta property="og:type" content="article">
<meta property="og:title" content="开发人员必须了解的开发安全规范">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;10&#x2F;%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E5%BF%85%E9%A1%BB%E4%BA%86%E8%A7%A3%E7%9A%84%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8%E8%A7%84%E8%8C%83&#x2F;index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="安全问题其实是很多程序员想了解又容易忽略的问题，但需要我们重视起来，提高应用程序的安全性。常出现的安全问题包括，程序接受数据可能来源于未经验证的用户，网络连接和其他不受信任的来源，如果未对程序接受数据进行校验，则可能会引发安全问题等等，具体也可以分成以下几方面：  数据校验 敏感信息 加密算法 序列化与反序列化 I&#x2F;O操作 多线程安全 框架和组件">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111093816-b9b60.png">
<meta property="og:updated_time" content="2020-01-10T13:12:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111093816-b9b60.png">

<link rel="canonical" href="http://congsheng.wang/2020/01/10/%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E5%BF%85%E9%A1%BB%E4%BA%86%E8%A7%A3%E7%9A%84%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8%E8%A7%84%E8%8C%83/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>开发人员必须了解的开发安全规范 | 个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">congsheng的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/10/%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E5%BF%85%E9%A1%BB%E4%BA%86%E8%A7%A3%E7%9A%84%E5%BC%80%E5%8F%91%E5%AE%89%E5%85%A8%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          开发人员必须了解的开发安全规范
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-10 21:12:35" itemprop="dateCreated datePublished" datetime="2020-01-10T21:12:35+08:00">2020-01-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Java技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>安全问题其实是很多程序员想了解又容易忽略的问题，但需要我们重视起来，提高应用程序的安全性。常出现的安全问题包括，程序接受数据可能来源于未经验证的用户，网络连接和其他不受信任的来源，如果未对程序接受数据进行校验，则可能会引发安全问题等等，具体也可以分成以下几方面：</strong></p>
<ul>
<li><strong>数据校验</strong></li>
<li><strong>敏感信息</strong></li>
<li><strong>加密算法</strong></li>
<li><strong>序列化与反序列化</strong></li>
<li><strong>I/O操作</strong></li>
<li><strong>多线程安全</strong></li>
<li><strong>框架和组件</strong></li>
</ul>
<a id="more"></a>

<p><img src="http://image.winrains.cn/2019/11/20191111093816-b9b60.png" alt="img"></p>
<h2 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h2><h3 id="数据校验-校验策略"><a href="#数据校验-校验策略" class="headerlink" title="数据校验-校验策略"></a>数据校验-校验策略</h3><p><strong>1. 白名单策略 -接受已知好的数据（ 任何时候，尽可能使用“白名单”的策略 ）</strong><br>下面的示例代码确保 name参数只包含字母、以及下划线</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">Pattern</span>.</span></span>matches(<span class="string">"^[0 -9A -Za -z_]+$"</span>, name))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException(<span class="string">"Invalid name"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>2. 黑名单策略 -拒绝已知好的数据</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public <span class="built_in">String</span> removeJavascript(<span class="built_in">String</span> input)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Pattern</span> p = <span class="built_in">Pattern</span>.compile(<span class="string">"javascript"</span>, <span class="built_in">Pattern</span>.CASE_INSENSITIVE  );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Matcher m = p.matcher(input);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> (! m.matches()) ? input : <span class="string">""</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>3. 白名单净化</strong><br>对数据中任何不属于某个已验证的、合法字符列表进行删除编码或者替换，然后再使用这些净化的数据<br><strong>4. 黑名单净化： 剔除或者转换某些字符（例如，删除引号、转换成HTML实体）</strong></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">String <span class="title">quoteApostrophe</span><span class="params">(String input)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (input != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">return</span> input.<span class="title">replaceAll</span><span class="params">(<span class="string">" \'"</span>, <span class="string">"&amp;rsquo;"</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="数据校验-输入输出"><a href="#数据校验-输入输出" class="headerlink" title="数据校验 -输入输出"></a>数据校验 -输入输出</h3><h4 id="规则1-1-校验跨信任边界传递的不可数据"><a href="#规则1-1-校验跨信任边界传递的不可数据" class="headerlink" title="规则1.1 校验跨信任边界传递的不可数据**"></a>规则1.1 校验跨信任边界传递的不可数据**</h4><p>程序接受的不可信数据源跨越任边界传递必须经过内校验，包括输入和出校验。 不可信数据：用户、网络连接等源 不可信数据：用户、网络连接等源 数据入口：</p>
<ol>
<li>终端计算机</li>
<li>互联网出入口</li>
<li>广域网出入口</li>
<li>公司对外发布服务的 DMZ服务器</li>
<li>VPN和类似远程连接设备。 信任边界：根据威胁建模划分的信任边 如 web 应用的服务端；</li>
</ol>
<h4 id="规则-1-2：禁止直接使用不可信数据来拼SQL语句"><a href="#规则-1-2：禁止直接使用不可信数据来拼SQL语句" class="headerlink" title="规则 1.2：禁止直接使用不可信数据来拼SQL语句"></a>规则 1.2：禁止直接使用不可信数据来拼SQL语句</h4><p>SQL 注入是指原始SQL查询被动态更改成一个与程序预期完全不同的查询。执行这样后可能导致信息泄露或者数据被篡改。防止 SQL注入的方式主要可以分为两类：</p>
<ol>
<li><p>使用参数化查询 （推荐使用）</p>
</li>
<li><p>对不可信数据进行校验</p>
</li>
<li><p>预编译处理</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Statement stmt= <span class="built_in">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">ResultSet</span> rs= <span class="built_in">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">try &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">String</span> userName= ctx.getAuthenticatedUserName(); <span class="comment">//this is a constant</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">String</span> sqlString= <span class="string">"SELECT * FROM t_item</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="string">    WHERE owner='"</span> + userName+ <span class="string">"' AND itemName='"</span> + request.getParameter(<span class="string">"itemName"</span>) + <span class="string">"'"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    stmt= connection.createStatement();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    rs= stmt.executeQuery(sqlString);<span class="comment">// ... result set handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加 name' OR 'a' = 'a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * FROM t_item <span class="keyword">WHERE</span> owner = <span class="string">'wiley'</span> <span class="literal">AND</span> itemname= <span class="string">'name'</span> <span class="literal">OR</span> <span class="string">'a'</span>=<span class="string">'a'</span>;</span></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>预编译处理：</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">PreparedStatement stmt = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ResultSet rs = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    String userName = ctx.get<span class="constructor">AuthenticatedUserName()</span>; <span class="comment">// this is a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">                                                      <span class="comment">// constant</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    String itemName = request.get<span class="constructor">Parameter(<span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ...Ensure that the length of userName and itemNameis legitimate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    String sqlString = <span class="string">"SELECT * FROM t_item WHERE owner=? AND itemName=?"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    stmt = connection.prepare<span class="constructor">Statement(<span class="params">sqlString</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    stmt.set<span class="constructor">String(1, <span class="params">userName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    stmt.set<span class="constructor">String(2, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    rs = stmt.execute<span class="constructor">Query()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... result set handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125; catch (SQLExceptions e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... logging and error handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>在存储过程中，通拼接参数值来构建查询字符串和应用序代码一样同是有SQL注入风险</strong> <strong>反例:</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CallableStatement = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ResultSet results = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    String userName = ctx.get<span class="constructor">AuthenticatedUserName()</span>; <span class="comment">// this is a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">                                                      <span class="comment">// constant</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    String itemName = request.get<span class="constructor">Parameter(<span class="string">"itemName"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    cs = connection.prepare<span class="constructor">Call(<span class="string">"&#123;call sp_queryItem(?,?)&#125;"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    cs.set<span class="constructor">String(1, <span class="params">userName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    cs.set<span class="constructor">String(2, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    results = cs.execute<span class="constructor">Query()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... result set handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125; catch (SQLException se) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... logging and error handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>对应的SQL Server存储过程：</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">sp_queryItem</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">  @<span class="title">userNamevarchar</span><span class="params">(50)</span>,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function">  @<span class="title">itemNamevarchar</span><span class="params">(50)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">AS</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">BEGIN</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="function"> <span class="title">DECLARE</span> @<span class="title">sql</span> <span class="title">nvarchar</span><span class="params">(500)</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"> <span class="keyword">SET</span> @sql= <span class="string">'SELECT * FROM t_item</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="string">  WHERE owner = '''</span> + @userName+ <span class="string">'''</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="string">  AND itemName= '''</span> + @itemName+ <span class="string">''''</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"> EXEC(@sql);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">END</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">GO</span></pre></td></tr></table></figure>

<p><strong>正例：</strong><br>** 在存储过程中动态构建sql，采用预编译的方式防御sql注入,**</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CallableStatement = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">ResultSet results = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    String userName = ctx.get<span class="constructor">AuthenticatedUserName()</span>; <span class="comment">// this is a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">                                                      <span class="comment">// constant</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    String itemName = request.get<span class="constructor">Parameter(<span class="string">"itemName"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... Ensure that the length of userName and itemName is legitimate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    cs = (<span class="string">"&#123;call sp_queryItem(?,?)&#125;"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    cs.set<span class="constructor">String(1, <span class="params">userName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    cs.set<span class="constructor">String(2, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    results = cs.execute<span class="constructor">Query()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... result set handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125; catch (SQLException se) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ... logging and error handling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>对应的SQL Server存储过程：</strong></p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">sp_queryItem</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">  @<span class="title">userName</span> <span class="title">varchar</span><span class="params">(50)</span>,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function">  @<span class="title">itemName</span> <span class="title">varchar</span><span class="params">(50)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">AS</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">BEGIN</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="function">  <span class="title">SELECT</span> * <span class="title">FROM</span> <span class="title">t_item</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function">  <span class="title">WHERE</span> <span class="title">userName</span>= @<span class="title">userName</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function">  <span class="title">AND</span> <span class="title">itemName</span>= @<span class="title">itemName</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">END</span></span></pre></td></tr></table></figure>

<p><strong>使用Hibernate，如果在动态构建SQL/HQL查询时包含了不可信输入，同样也会面临SQL/HQL注入的问题。</strong><br><strong>反例：</strong><br>//原生sql查询 String userName= ctx.getAuthenticatedUserName(); //this is a constant</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">String</span> itemName= request.getParameter(<span class="string">"itemName"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">Query</span> sqlQuery= session.createSQLQuery(<span class="string">"select * from where owner = '"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">                             + userName+ <span class="string">"' and itemName= '"</span> + itemName+ “’”);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">List</span>&lt;<span class="keyword">Item</span>&gt; rs= (<span class="keyword">List</span>&lt;<span class="keyword">Item</span>&gt;) sqlQuery.list();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">//HQL查询</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">String</span> userName= ctx.getAuthenticatedUserName();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">//this is a constant</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">String</span> itemName=request.getParameter(<span class="string">"itemName"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">Query</span> hqlQuery= session.createQuery(<span class="string">"from Item as item where item.owner= '"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                              + userName+ <span class="string">"' and = '"</span> + itemName+ <span class="string">"'"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">List</span>&lt;<span class="keyword">Item</span>&gt; hrs= (<span class="keyword">List</span>&lt;<span class="keyword">Item</span>&gt;) hqlQuery.list();</span></pre></td></tr></table></figure>

<p><strong>正例：</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//HQL中基于位置的参数化查询：</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">String userName= ctx.get<span class="constructor">AuthenticatedUserName()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">String itemName=request.get<span class="constructor">Parameter(<span class="string">"itemName"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">Query hqlQuery= session.create<span class="constructor">Query(<span class="string">"from Item as item where item.owner= ? and item.itemName= ?"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">hqlQuery.set<span class="constructor">String(1, <span class="params">userName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">hqlQuery.set<span class="constructor">String(2, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">List&lt;Item&gt; rs= (List&lt;Item&gt;) hqlQuery.<span class="built_in">list</span><span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//HQL中基于名称的参数化查询：</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">String userName= ctx.get<span class="constructor">AuthenticatedUserName()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">String itemName= (<span class="string">"itemName"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">Query hqlQuery= session.create<span class="constructor">Query(<span class="string">"from Item as item where item.owner= :owner and = :itemName"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">hqlQuery.set<span class="constructor">String(<span class="string">"owner"</span>, <span class="params">userName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">hqlQuery.set<span class="constructor">String(<span class="string">"itemName"</span>, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">List&lt;Item&gt; rs= (List&lt;Item&gt;) hqlQuery.<span class="built_in">list</span><span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//原生参数化查询：</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">String userName=ctx.get<span class="constructor">AuthenticatedUserName()</span>; <span class="comment">//this is a constant</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">String itemName= request.get<span class="constructor">Parameter(<span class="string">"itemName"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">Query sqlQuery= session.create<span class="constructor">SQLQuery(<span class="string">"select * from t_itemwhere owner = ? and itemName= ?"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">sqlQuery.set<span class="constructor">String(0, <span class="params">owner</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">sqlQuery.set<span class="constructor">String(1, <span class="params">itemName</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">List&lt;Item&gt; rs= (List&lt;Item&gt;) sqlQuery.<span class="built_in">list</span><span class="literal">()</span>;</span></pre></td></tr></table></figure>

<p><strong>Mybaits和ibaits的#和$</strong><br><strong>Mybaits：</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select </span>id=<span class="string">"getItems"</span> parameterClass=<span class="string">"MyClass"</span> resultClass=<span class="string">"Item"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">SELECT </span>* FROM t_item</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    WHERE owner = <span class="symbol">#userName</span># <span class="keyword">AND </span><span class="keyword">itemName= </span><span class="symbol">#itemName</span>#</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&lt;/<span class="keyword">select&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">String </span>sqlString= <span class="string">"SELECT * FROM t_itemWHERE owner=? AND itemName=?"</span><span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="symbol">PreparedStatement</span> <span class="keyword">stmt= </span>connection.prepareStatement(sqlString)<span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">stmt.setString(1, </span>myClassObj.getUserName())<span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">stmt.setString(2, </span>myClassObj.getItemName())<span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="symbol">ResultSet</span> rs= <span class="keyword">stmt.executeQuery();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">// </span>... convert results set to <span class="keyword">Item </span>objects</span></pre></td></tr></table></figure>

<p><strong>ibaits：</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id="getItems" parameterClass="MyClass"="items"&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> t_item</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">WHERE</span> owner = #userName# <span class="keyword">AND</span> itemName= <span class="string">'$itemName$'</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&lt;/<span class="keyword">select</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">String sqlString= "SELECT * FROM t_itemWHERE owner=? AND itemName='" +myClassObj.getItemName() + "'";</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">PreparedStatementstmt=<span class="keyword">connection</span>.prepareStatement(sqlString);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">stmt.setString(<span class="number">1</span>, myClassObj.getUserName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">ResultSetrs= stmt.executeQuery();</span></pre></td></tr></table></figure>

<p><strong>输入验证,针对无法参数化查询的场景</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public List&lt;Book&gt; query<span class="constructor">Books(<span class="params">queryCondition</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        StringBuilder sb = <span class="constructor">StringBuilder(<span class="string">"select * from t_bookwhere "</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        Codec oe = <span class="keyword">new</span> <span class="constructor">OracleCodec()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(queryCondition != null&amp;&amp; !queryCondition.is<span class="constructor">Empty()</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            for(Expression e : queryCondition) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">                String exprString=e.get<span class="constructor">Column()</span> + e.get<span class="constructor">Operator()</span> + e.get<span class="constructor">Value()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">                String safeExpr= <span class="module-access"><span class="module"><span class="identifier">ESAPI</span>.</span></span>encoder<span class="literal">()</span>.encode<span class="constructor">ForSQL(<span class="params">oe</span>, <span class="params">exprString</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                sb.append(safeExpr).append(<span class="string">" and "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            sb.append(<span class="string">"1=1"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            Statement stat = connection.create<span class="constructor">Statement()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            ResultSet rs= stat.execute<span class="constructor">Query(<span class="params">sb</span>.<span class="params">toString</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//other omitted code</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="规则1-3-禁止直接使用不可信数据来拼接XML"><a href="#规则1-3-禁止直接使用不可信数据来拼接XML" class="headerlink" title="规则1.3 禁止直接使用不可信数据来拼接XML"></a>规则1.3 禁止直接使用不可信数据来拼接XML</h4><p>一个用户，如果他被允许输入结构化的XML片段，则他可以在XML的数据域中注入XML标签来改写目标XML文档的结构与内容。XML解析器会对注入的标签进行识别和解释。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">private void createXMLStream(BufferedOutputStreamoutStream,<span class="built_in"> User </span>user) throws IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    String xmlString;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    xmlString= <span class="string">"&lt;user&gt;&lt;role&gt;operator&lt;/role&gt;&lt;id&gt;"</span> + user.getUserId()+ <span class="string">"&lt;/id&gt;&lt;description&gt;"</span> + user.getDescription() + <span class="string">"&lt;/description&gt;&lt;/user&gt;"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    outStream.write(xmlString.getBytes());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    outStream.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>添加joeadministratorjoe</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">role</span>&gt;</span>operator<span class="tag">&lt;/<span class="name">role</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>joe<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">role</span>&gt;</span>administrator<span class="tag">&lt;/<span class="name">role</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>joe<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>I want to be an administrator<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span></pre></td></tr></table></figure>

<p>XML Schema或者DTD校验，反例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void create<span class="constructor">XMLStream(BufferedOutputStreamoutStream, User <span class="params">user</span>)</span>throwsIOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    String xmlString;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    xmlString = <span class="string">"&lt;user&gt;&lt;id&gt;"</span> + user.get<span class="constructor">UserId()</span>+ <span class="string">"&lt;/id&gt;&lt;role&gt;operator&lt;/role&gt;&lt;description&gt;"</span>+ user.get<span class="constructor">Description()</span> + <span class="string">"&lt;/description&gt;&lt;/user&gt;"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    StreamSource xmlStream = <span class="keyword">new</span> <span class="constructor">StreamSource(<span class="params">new</span> StringReader(<span class="params">xmlString</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Build a validating SAX parser using the schema</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    SchemaFactory sf = <span class="module-access"><span class="module"><span class="identifier">SchemaFactory</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance(XMLConstants.W3C_XML_SCHEMA_NS_URI)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    StreamSource ss = <span class="keyword">new</span> <span class="constructor">StreamSource(<span class="params">newFile</span>(<span class="string">"schema.xsd"</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        Schema schema = sf.<span class="keyword">new</span><span class="constructor">Schema(<span class="params">ss</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        Validator validator = schema.<span class="keyword">new</span><span class="constructor">Validator()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        validator.validate(xmlStream);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;catch(SAXException x)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IOException(<span class="string">"Invalid userId"</span>, <span class="params">x</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// the XML is valid, proceed</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    outStream.write(xmlString.get<span class="constructor">Bytes()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    outStream.flush<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&lt;xs:schema xmlns:xs=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &lt;xs:element name=<span class="string">"user"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        &lt;xs:complexType&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            &lt;xs:sequence&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                &lt;xs:elementname=<span class="string">"id"</span> <span class="keyword">type</span>=<span class="string">"xs:string"</span>/&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                &lt;xs:element name=<span class="string">"role"</span><span class="keyword">type</span>=<span class="string">"xs:string"</span>/&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">                &lt;xs:element name=<span class="string">"description"</span> <span class="keyword">type</span>=<span class="string">"xs:string"</span>/&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            &lt;/xs:sequence&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        &lt;/xs:complexType&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    &lt;/xs:element&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&lt;/xs:schema&gt;</span></pre></td></tr></table></figure>

<p>某个恶意用户可能会使用下面的字符串作为用户ID：<br><strong>“joeAdministrator</strong><br>&lt;!—“并使用如下字符串作为描述字段：<br><strong>“-&gt;I want to be an administrator”</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>joe<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">role</span>&gt;</span>Administrator<span class="tag">&lt;/<span class="name">role</span>&gt;</span><span class="comment">&lt;!--&lt;/id&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &lt;role&gt;operator&lt;/role&gt; &lt;description&gt; --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>I want to be an administrator<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span></pre></td></tr></table></figure>

<p><strong>安全做法：白名单+安全的xml库</strong></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void create<span class="constructor">XMLStream(BufferedOutputStreamoutStream, User <span class="params">user</span>)</span> throws IOException&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Write XML string if userID contains alphanumeric and underscore characters only</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">Pattern</span>.</span></span>matches(<span class="string">"[_a-bA-B0-9]+"</span>, user.get<span class="constructor">UserId()</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="operator">         / </span>Handle format violation</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">     &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span> (!<span class="module-access"><span class="module"><span class="identifier">Pattern</span>.</span></span>matches(<span class="string">"[_a-bA-B0-9]+"</span>, user.get<span class="constructor">Description()</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">         <span class="comment">// Handle format violation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">     &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">     String xmlString= <span class="string">"&lt;user&gt;&lt;id&gt;"</span>+ user.get<span class="constructor">UserId()</span>+ <span class="string">"&lt;/id&gt;&lt;role&gt;operator&lt;/role&gt;&lt;description&gt;"</span>+ user.get<span class="constructor">Description()</span> + <span class="string">"&lt;/description&gt;&lt;/user&gt;"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">     outStream.write(xmlString.get<span class="constructor">Bytes()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">     outStream.flush<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">public static void buidl<span class="constructor">XML(FileWriterwriter, User <span class="params">user</span>)</span> throwsIOExceptionv&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    Document userDoc= <span class="module-access"><span class="module"><span class="identifier">DocumentHelper</span>.</span></span>create<span class="constructor">Documen()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    Element userElem= userDoc.add<span class="constructor">Element(<span class="string">"user"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    Element idElem= userElem.add<span class="constructor">Element(<span class="string">"id"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    idElem.set<span class="constructor">Text(<span class="params">user</span>.<span class="params">getUserId</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    Element roleElem= userElem.add<span class="constructor">Element(<span class="string">"role"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    roleElem.set<span class="constructor">Text(<span class="string">"operator"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    Element descrElem=userElem.add<span class="constructor">Element(<span class="string">"description"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    descrElem.set<span class="constructor">Text(<span class="params">user</span>.<span class="params">getDescription</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    XMLWriter output = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        OutputFormat format = <span class="module-access"><span class="module"><span class="identifier">OutputFormat</span>.</span></span>create<span class="constructor">PrettyPrint()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        format.set<span class="constructor">Encoding(<span class="string">"UTF-8"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        output = <span class="keyword">new</span> <span class="constructor">XMLWriter(<span class="params">writer</span>, <span class="params">format</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        output.write(userDoc);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        output.flush<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>Xml注入净化之后的数据</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;user&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="params">&lt;id&gt;</span>joe<span class="variable">&amp;lt</span>;/id<span class="variable">&amp;gt</span>;<span class="variable">&amp;lt</span>;role<span class="variable">&amp;gt</span>;Administrator<span class="variable">&amp;lt</span>;/role<span class="variable">&amp;gt</span>;<span class="variable">&amp;lt</span>;!—<span class="params">&lt;/id&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="params">&lt;role&gt;</span>operator<span class="params">&lt;/role&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="params">&lt;description&gt;</span>--<span class="variable">&amp;gtlt</span>;description<span class="variable">&amp;gt</span>;Iwant to be an administrator<span class="params">&lt;/description&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;/user&gt;</span></span></pre></td></tr></table></figure>

<h4 id="规则1-4：禁止直接使用不可信数据来记录日"><a href="#规则1-4：禁止直接使用不可信数据来记录日" class="headerlink" title="规则1.4：禁止直接使用不可信数据来记录日"></a>规则1.4：禁止直接使用不可信数据来记录日</h4><p>如果在记录的日志中包含未经校验的不可信数据，则可能导致日志注入漏洞。恶意用户会插入伪造的日志数据，从而让系统 管理员误以为这些日志数据是由系统记录的。例如，一个用户可能通过输入一个回车符和一个换行符（CRLF）序列来将一 条合法日志拆分成两条日志，其中每一条都可能会令人误解。<br>将未经净化的用户输入写入日志还可能会导致向信任边界之外泄露敏感数据，或者导致违反当地法律法规，在日志中写入和存储了某些类型的敏感数据。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">if</span>(loginSuccessful) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">logger</span><span class="selector-class">.severe</span>(<span class="string">"User login succeeded for: "</span> + username);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125; <span class="selector-tag">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">logger</span><span class="selector-class">.severe</span>(<span class="string">"User login failed for: "</span> + username);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>生成log：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">david May 15, 2011 2:25:52 PM java.util.logging.LogManager<span class="variable">$RootLogger</span>.log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">SEVERE:<span class="built_in"> User </span>login succeeded <span class="keyword">for</span>: administrator</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">May 15, 2011 2:19:10 PM java.util.logging.LogManager<span class="variable">$RootLogger</span> log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">SEVERE:<span class="built_in"> User </span>login failed <span class="keyword">for</span>: david</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">May 15, 2011 2:25:52 PM java.util.logging.LogManager log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">SEVERE:<span class="built_in"> User </span>login succeeded <span class="keyword">for</span>: administrator</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="attribute">Username</span>=David（生成标准日志）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">May 15, 2011 2:19:10 PM java.util.logging.LogManager<span class="variable">$RootLogger</span> log</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">SEVERE:<span class="built_in"> User </span>login failed <span class="keyword">for</span>: david</span></pre></td></tr></table></figure>

<p>登录之前会对用户名输入进行净化，从而防止注入攻击</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">if</span>(!Pattern.(<span class="string">"[A-Za-z0-9_]+"</span>, username)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Unsanitized username</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">logger</span><span class="selector-class">.severe</span>(<span class="string">"User login failed for unauthorized user"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125; <span class="selector-tag">else</span> <span class="selector-tag">if</span> (loginSuccessful) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">logger</span><span class="selector-class">.severe</span>(<span class="string">"User login succeeded for: "</span>+ username);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125; <span class="selector-tag">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">logger</span><span class="selector-class">.severe</span>(<span class="string">"User login failed for: "</span>+ username);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="规则1-5：禁止向Runtime-exec-方法传递不可信、未净化的数据"><a href="#规则1-5：禁止向Runtime-exec-方法传递不可信、未净化的数据" class="headerlink" title="规则1.5：禁止向Runtime.exec() 方法传递不可信、未净化的数据"></a>规则1.5：禁止向Runtime.exec() 方法传递不可信、未净化的数据</h4><p>在执行任意系统命令或者外部程序时使用了未经校验的不可信输入，就会导致产生命令和参数注入漏洞。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DirList</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (args.length == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"No arguments"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            System.<span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            Runtime rt = Runtime.getRuntime();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">Process</span> proc = rt.exec(<span class="string">"cmd.exe /c dir"</span> + args[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// Handle errors</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>java DirList”dummy &amp; echo bad”<br>dirdummy echo bad<br><strong>安全建议：</strong></p>
<ol>
<li><p><strong>避免直接使用Runtime.exec()，采用标准的API替代运行系统命令来完成任务</strong></p>
</li>
<li><p>白名单数据校验和数据净化</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String[] <span class="keyword">args</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(<span class="keyword">args</span>.length == 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">"No arguments"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        System.<span class="keyword">exit</span>(1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    try &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">File</span> <span class="keyword">dir</span> = newFile(<span class="keyword">args</span>[0]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// the dir need to be validated</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!validate(<span class="keyword">dir</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">"An illegal directory"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">for</span>(String <span class="keyword">file</span> : <span class="keyword">dir</span>.<span class="keyword">list</span>()) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                System.<span class="keyword">out</span>.println(<span class="keyword">file</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

</li>
</ol>
<table>
<thead>
<tr>
<th>类型</th>
<th>举例</th>
<th>常见注入模式和结果</th>
</tr>
</thead>
<tbody><tr>
<td>管道</td>
<td>|</td>
<td>| shell_command -执行命令并返回命令输出信息</td>
</tr>
<tr>
<td>内联</td>
<td>; &amp;</td>
<td>; shell_command -执行命令并返回命令输出信息 &amp; shell_command -执行命令并返回命令输出信息</td>
</tr>
<tr>
<td>逻辑运算符</td>
<td>$ &amp;&amp; ||</td>
<td>$(shell_command) -执行命令 &amp;&amp; shell_command -执行命令并返回命令输出信息 || shell_command -执行命令并返回命令输出信息</td>
</tr>
<tr>
<td>重定向运算符</td>
<td>&gt; &gt;&gt; &lt;</td>
<td>&gt; target_file -使用前面命令的输出信息写入目标文件 &gt;&gt; target_file -将前面命令的输出信息附加到目标文件 &lt; target_file-将目标文件的内容发送到前面的命令</td>
</tr>
</tbody></table>
<h4 id="规则1-6：验证路径之前应该先将其标准化"><a href="#规则1-6：验证路径之前应该先将其标准化" class="headerlink" title="规则1.6：验证路径之前应该先将其标准化"></a>规则1.6：验证路径之前应该先将其标准化</h4><p>绝对路径名或者相对路径名中可能会包含文件链接，对文件名标准化可以使得验证文件路径更加容易，同时可以防御目录遍历引发的安全漏洞。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static void main(String<span class="literal">[]</span> args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    File f = <span class="keyword">new</span><span class="constructor">File(System.<span class="params">getProperty</span>(<span class="string">"user.home"</span>)</span> + <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>get<span class="constructor">Property(<span class="string">"file.separator"</span>)</span> + args<span class="literal">[<span class="number">0</span>]</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    String absPath = f.get<span class="constructor">AbsolutePath()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(!is<span class="constructor">InSecureDir(Paths.<span class="params">get</span>(<span class="params">absPath</span>)</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Refer to Rule 3.5 for the details of isInSecureDir()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(!validate(absPath)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Validation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* … */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">public static void main(String<span class="literal">[]</span> args) throwsIOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    File f = <span class="keyword">new</span><span class="constructor">File(System.<span class="params">getProperty</span>(<span class="string">"user.home"</span>)</span> + <span class="module-access"><span class="module"><span class="identifier">System</span>.</span></span>get<span class="constructor">Property(<span class="string">"file.separator"</span>)</span> + args<span class="literal">[<span class="number">0</span>]</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    String canonicalPath= f.get<span class="constructor">CanonicalPath()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(!is<span class="constructor">InSecureDir(Paths.<span class="params">get</span>(<span class="params">absPath</span>)</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Refer to Rule3.5 for the details of isInSecureDir()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(!validate(absPath)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Validation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> <span class="constructor">IllegalArgumentException()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* ... */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="规则1-7：安全地从ZipInputStream提取文件"><a href="#规则1-7：安全地从ZipInputStream提取文件" class="headerlink" title="规则1.7：安全地从ZipInputStream提取文件"></a>规则1.7：安全地从ZipInputStream提取文件</h4><ol>
<li><p><strong>提取出的文件标准路径落在解压的目标目录之外-跨目录解压攻击，</strong></p>
</li>
<li><p>是提取出的文件消耗过多的系统资源-zip压缩炸弹。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER= <span class="number">512</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> unzip(String fileName) <span class="keyword">throws</span> java.io.IOException&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">   FileInputStream fis= <span class="keyword">new</span> FileInputStream(fileName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">   ZipInputStream zis= <span class="keyword">new</span> ZipInputStream(newBufferedInputStream(fis));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">   ZipEntry entry;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">   <span class="keyword">while</span>((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">       System.out.<span class="keyword">println</span>(<span class="string">"Extracting: "</span>+ entry);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">       <span class="keyword">int</span> <span class="keyword">count</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">       <span class="keyword">byte</span> data[] = newbyte[BUFFER];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">       <span class="comment">// Write the files to the disk</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">       FileOutputStreamfos= <span class="keyword">new</span> FileOutputStream(entry.getName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">       BufferedOutputStreamdest= <span class="keyword">new</span> BufferedOutputStream(fos, BUFFER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">       <span class="keyword">while</span>((<span class="keyword">count</span> = zis.<span class="keyword">read</span>(data, <span class="number">0</span>, BUFFER)) != -<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">           dest.<span class="keyword">write</span>(data, <span class="number">0</span>, <span class="keyword">count</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">       &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">       dest.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">       dest.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">       zis.closeEntry();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">   &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">   zis.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

</li>
</ol>
<p>未对解压的文件名做验证，直接将文件名传递给FileOutputStream构造器。它也未检查解压文件的资源消耗情况，它允许程序运行到操作完成或者本地资源被耗尽<br>示例</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER= <span class="number">512</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TOOBIG= <span class="number">0</span>x6400000; <span class="comment">// 100MB</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> unzip(String filename) <span class="keyword">throws</span> java.io.IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    FileInputStream fis = newFileInputStream(filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    ZipInputStreamzis = newZipInputStream(newBufferedInputStream(fis));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    ZipEntry entry;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">while</span>((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            System.out.<span class="keyword">println</span>(<span class="string">"Extracting: "</span>+ entry);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">int</span> <span class="keyword">count</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">byte</span> data[] = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (entry.getSize() &gt; TOOBIG)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File to be unzipped is huge."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>(entry.getSize() == -<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"File to be unzipped might be huge."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            FileOutputStreamfos = newFileOutputStream(entry.getName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            BufferedOutputStreamdest = <span class="keyword">new</span> BufferedOutputStream(fos,BUFFER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">while</span>((<span class="keyword">count</span> = zis.<span class="keyword">read</span>(data, <span class="number">0</span>, BUFFER)) != -<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                dest.<span class="keyword">write</span>(data, <span class="number">0</span>, <span class="keyword">count</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            dest.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            dest.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            zis.closeEntry();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>ZipEntry.getSize()方法在解压提取一个条目之前判断其大小，以试图解决之前的问题。攻击者可以伪造ZIP文件中用来描述解压条目大小的字段，因此，getSize()可靠的，本地资源实际仍可能被过度消耗</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> final int BUFFER= <span class="number">512</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> final int TOOBIG= <span class="number">0x6400000</span>; <span class="comment">// max size of unzipped data, 100MB</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> final int TOOMANY = <span class="number">1024</span>; <span class="comment">// max number of files</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> sanitzeFileName(<span class="keyword">String</span> entryName, <span class="keyword">String</span> intendedDir) throws IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    File f = <span class="keyword">new</span><span class="type">File</span>(intendedDir, entryName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> canonicalPath = f.getCanonicalPath();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    File iD = <span class="keyword">new</span><span class="type">File</span>(intendedDir);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> canonicalID= iD.getCanonicalPath();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(canonicalPath.startsWith(canonicalID)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> canonicalPath;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"File is outside extraction target directory."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> final void unzip(<span class="keyword">String</span> fileName) throws java.io.IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    FileInputStream fis = <span class="keyword">new</span> <span class="type">FileInputStream</span>(fileName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    ZipInputStream zis = <span class="keyword">new</span><span class="type">ZipInputStream</span>(<span class="keyword">new</span><span class="type">BufferedInputStream</span>(fis));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    ZipEntryentry;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    int entries = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    int total = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    byte[] data = <span class="keyword">new</span><span class="type">byte</span>[BUFFER];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">while</span>((entry = zis.getNextEntry()) != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            System.out.println(<span class="string">"Extracting: "</span>+ entry);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            int count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">String</span> name = sanitzeFileName(entry.getName(), <span class="string">"."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            FileOutputStream fos= <span class="keyword">new</span><span class="type">FileOutputStream</span>(name);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            BufferedOutputStream dest= <span class="keyword">new</span> <span class="type">BufferedOutputStream</span>(fos, BUFFER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">while</span> (total + BUFFER&lt;= &amp;&amp; (count = zis.read(data, <span class="number">0</span>, BUFFER)) != <span class="number">-1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">                dest.write(data, <span class="number">0</span>, count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">                total += count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            dest.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            dest.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            zis.closeEntry();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">            entries++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>(entries &gt; TOOMANY) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"Too many files to unzip."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>(total &gt; TOOBIG) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"File being unzipped is too big."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="规则1-8：禁止未经验证的用户输入直接输出到html界面"><a href="#规则1-8：禁止未经验证的用户输入直接输出到html界面" class="headerlink" title="规则1.8：禁止未经验证的用户输入直接输出到html界面"></a>规则1.8：禁止未经验证的用户输入直接输出到html界面</h4><p>用户输入未经过验证直接输出到html界面容易导致xss注入攻击，该攻击方式可以盗取用户cookie信息，严重的可以形成xss蠕虫攻击漏洞，也可以结合其他的安全漏洞进一步进行攻击和破坏系统<br>反例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">String eid = request.get<span class="constructor">Parameter(<span class="string">"eid"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">eid = <span class="module-access"><span class="module"><span class="identifier">StringEscapeUtils</span>.</span></span>escape<span class="constructor">Html(<span class="params">eid</span>)</span>;<span class="comment">//insufficient validation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">ServletOutputStream out = response.get<span class="constructor">OutputStream()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">out.print(<span class="string">"Employee ID:"</span>+eid);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">out.close<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr></table></figure>

<p>正例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Statement stmt = conn.creat<span class="constructor">Statement()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">ResultSet rs = stmt.execute<span class="constructor">Query(<span class="string">"select * from emp where id ="</span>+<span class="params">eid</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(rs != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">rs.next<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">String name = <span class="module-access"><span class="module"><span class="identifier">StringEscapeUtils</span>.</span></span>escape<span class="constructor">Html(<span class="params">rs</span>.<span class="params">getString</span>(<span class="string">"name"</span>)</span>);<span class="comment">//insufficient validation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">ServletOutputStream out = response.get<span class="constructor">OutputStream()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">out.close<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>数据类型</th>
<th>上下文</th>
<th>示例代码</th>
<th>防御措施</th>
</tr>
</thead>
<tbody><tr>
<td>string</td>
<td>HTML Body</td>
<td><span>UNTRUSTED DATA</span></td>
<td>HTML Entity编码</td>
</tr>
<tr>
<td>String</td>
<td>安全HTML变量</td>
<td><input type="text" name="fname" value="UNTRUSTED DATA"></td>
<td>1. HTML Attribute编码 2. 只把不可信数据放在安全白名单内的变量上（白名单在下文列出） 3. 严格地校验不安全变量，如background、id和name</td>
</tr>
<tr>
<td>String</td>
<td>GET参数</td>
<td><a href="/site/search?value=UNTRUSTED DATA">clickme</td>
<td>URL编码</td>
</tr>
<tr>
<td>String</td>
<td>使用在src或href变量上的不可信URLs</td>
<td><a href="UNTRUSTED URL">clickme</a>&lt;iframe src=”UNTRUSTED URL” /</td>
<td>1. 对输入进行规范化； 2. URL校验； 3. URL安全性认证 4. 只允许使用http和https协议（避免使用JavaScript协议去打开一个新窗口） 5. HTML Attribute编码</td>
</tr>
<tr>
<td>String</td>
<td>CSS值</td>
<td><div style="width: UNTRUSTED DATA;">Selection</div></td>
<td>1. 使用CSS编码； 2. 使用CSS Hex编码； 3. 良好的CSS设计</td>
</tr>
<tr>
<td>String</td>
<td>JavaScript变量</td>
<td><script> var currentValue='UNTRUSTED DATA';</script> <script>someFunction('UNTRUSTED DATA');</script></td>
<td>1. 确保所有变量值都被引号括起来； 2. 使用JavaScript Hex编码 3. 使用JavaScript Unicode编码； 4. 避免使用“反斜杠转译”（&quot;、&#39;或者\）</td>
</tr>
<tr>
<td>HTML</td>
<td>HTML Body</td>
<td><div>UNTRUSTED HTML</div></td>
<td>[HTML校验(JSoup, AntiSamy, HTML Sanitizer)]</td>
</tr>
<tr>
<td>String</td>
<td>DOM XSS</td>
<td><script> document.write("UNTRUSTED INPUT: " + document.location.hash);<script/></td>
<td>基于DOM操作的XSS漏洞防御措施</td>
</tr>
</tbody></table>
<p><strong>1、输入过滤：客户端求情参数：包括用户输入，url参数、post参数。</strong></p>
<ul>
<li>在产品形态上，针对不同输入类型，对输入做变量类型限制。</li>
<li>字符串类型的数据，需要针对<、>、/、’、”、&五个字符进行实体化转义 <strong>2、输出编码：浏览器解析中html和js编码不一样，以及上下文场景多样，所以对于后台输出的变量，不同的上下文中渲染后端变量，转码不一样。</strong></li>
</ul>
<table>
<thead>
<tr>
<th>特殊字符</th>
<th>实体编码</th>
</tr>
</thead>
<tbody><tr>
<td>&</td>
<td>&amp</td>
</tr>
<tr>
<td><</td>
<td>&lt</td>
</tr>
<tr>
<td>></td>
<td>&gt</td>
</tr>
<tr>
<td>“</td>
<td>&quot</td>
</tr>
<tr>
<td>/</td>
<td>&#x2F</td>
</tr>
<tr>
<td>‘</td>
<td>&#x27</td>
</tr>
</tbody></table>
<h4 id="规则1-9：禁止直接解析未验证的xml实体"><a href="#规则1-9：禁止直接解析未验证的xml实体" class="headerlink" title="规则1.9：禁止直接解析未验证的xml实体"></a>规则1.9：禁止直接解析未验证的xml实体</h4><p>当允许引用外部实体时，若程序针对输入xml实体未验证，攻击者通过构造恶意内容，进行xxe注入攻击，可导致读取任意文件、执行系统命令、探测内网端口、攻击内网网站等危害 反例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public void transform(InputStream xmlStream, OutputStream output) throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Transformer trans = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    TransformerFactory transFactory = <span class="module-access"><span class="module"><span class="identifier">TransformerFactory</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (this.style != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        trans = transFactory.<span class="keyword">new</span><span class="constructor">Tranformer(<span class="params">this</span>.<span class="params">style</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        trans = transFactory.<span class="keyword">new</span><span class="constructor">Tranformer()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/********* UTF-8 ***/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    trans.set<span class="constructor">OutputProperty(OutputKeys.ENCOOING, <span class="string">"UTF-8"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    Source source = <span class="keyword">new</span> <span class="constructor">SAXSource(<span class="params">new</span> InputSource(<span class="params">xmlStream</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Result result = <span class="keyword">new</span> <span class="constructor">StreamResult(<span class="params">output</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    trans.transform(source, result);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>正例：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public void transform(InputStream xmlStream, OutputStream output)throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Transformer trans = null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    TransformerFactory transFactory = <span class="module-access"><span class="module"><span class="identifier">TransformerFactory</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(this.style != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//trans=transFactory.newTranformer(this.style);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        TransformerFactory trans = <span class="module-access"><span class="module"><span class="identifier">TransformerFactory</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Feature(XMLConstans.FEATURE_SECURE_PROCESSING, <span class="params">true</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Attribute((XMLConstans.ACCESS_EXTERNAL_DTD, <span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Attribute((XMLConstans.ACCESS_EXTERNAL_STYLESHEET, <span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//trans=transFactory.newTranformer();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        TransformerFactory trans = <span class="module-access"><span class="module"><span class="identifier">TransformerFactory</span>.</span></span><span class="keyword">new</span><span class="constructor">Instance()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Feature(XMLConstans.FEATURE_SECURE_PROCESSING, <span class="params">true</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Attribute((XMLConstans.ACCESS_EXTERNAL_DTD, <span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        trfactory.set<span class="constructor">Attribute((XMLConstans.ACCESS_EXTERNAL_STYLESHEET, <span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*********UTF-8***/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    trans.set<span class="constructor">OutputProperty(OutputKeys.ENCOOING, <span class="string">"UTF-8"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    Source source = <span class="keyword">new</span> <span class="constructor">SAXSource(<span class="params">new</span> InputSource(<span class="params">xmlStream</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    Result result = <span class="keyword">new</span> <span class="constructor">StreamResult(<span class="params">output</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    trans.transform(source, result);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>不同xml解析器防御xxe注入的方法：</strong><br>XMLReader To protect a java org.xml.sax.XMLReader from XXE,do this：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">XMLReader reader=<span class="module-access"><span class="module"><span class="identifier">XMLReaderFactory</span>.</span></span>create<span class="constructor">XMLReader()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">reader.set<span class="constructor">Featrue(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>,<span class="params">true</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">reader.set<span class="constructor">Featrue(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>,<span class="params">true</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//stictly required as DTDs should not be allowed at all ,per previous</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">reader.set<span class="constructor">Featrue(<span class="string">"http://xml.org/sax/features/external-general-entilies"</span>,<span class="params">false</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">reader.set<span class="constructor">Featrue(<span class="string">"http://xml.org/sax/features/external-parameter-entilies"</span>,<span class="params">false</span>)</span>;</span></pre></td></tr></table></figure>

<p>SAXReader To protect a java org.dom4j.io.SAXReader from XXE,do this：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">saxReader.set<span class="constructor">Featrue(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>,<span class="params">true</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">saxReader.set<span class="constructor">Featrue(<span class="string">"http://xml.org/sax/features/external-general-entilies"</span>,<span class="params">false</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">saxReader.set<span class="constructor">Featrue(<span class="string">"http://xml.org/sax/features/external-parameter-entilies"</span>,<span class="params">false</span>)</span>;</span></pre></td></tr></table></figure>

<p><strong>后续会把涉及的其他安全问题全部写出来，可关注本人的下篇文章。</strong></p>
<blockquote>
<p>作者：Ccww</p>
<p>来源：<a href="https://juejin.im/post/5d5fbcfde51d4561f777e1d1" target="_blank" rel="noopener">https://juejin.im/post/5d5fbcfde51d4561f777e1d1</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E8%A7%84%E8%8C%83/" rel="tag"># 规范</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/10/IntelliJ-IDEA%E4%BD%BF%E7%94%A8%E5%A4%A7%E5%85%A8/" rel="prev" title="IntelliJ IDEA使用大全">
      <i class="fa fa-chevron-left"></i> IntelliJ IDEA使用大全
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/10/%E5%BC%80%E5%8F%91%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" rel="next" title="开发中遇到的安全性问题解决方法">
      开发中遇到的安全性问题解决方法 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据校验"><span class="nav-number">1.</span> <span class="nav-text">数据校验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据校验-校验策略"><span class="nav-number">1.1.</span> <span class="nav-text">数据校验-校验策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据校验-输入输出"><span class="nav-number">1.2.</span> <span class="nav-text">数据校验 -输入输出</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-1-校验跨信任边界传递的不可数据"><span class="nav-number">1.2.1.</span> <span class="nav-text">规则1.1 校验跨信任边界传递的不可数据**</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则-1-2：禁止直接使用不可信数据来拼SQL语句"><span class="nav-number">1.2.2.</span> <span class="nav-text">规则 1.2：禁止直接使用不可信数据来拼SQL语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-3-禁止直接使用不可信数据来拼接XML"><span class="nav-number">1.2.3.</span> <span class="nav-text">规则1.3 禁止直接使用不可信数据来拼接XML</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-4：禁止直接使用不可信数据来记录日"><span class="nav-number">1.2.4.</span> <span class="nav-text">规则1.4：禁止直接使用不可信数据来记录日</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-5：禁止向Runtime-exec-方法传递不可信、未净化的数据"><span class="nav-number">1.2.5.</span> <span class="nav-text">规则1.5：禁止向Runtime.exec() 方法传递不可信、未净化的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-6：验证路径之前应该先将其标准化"><span class="nav-number">1.2.6.</span> <span class="nav-text">规则1.6：验证路径之前应该先将其标准化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-7：安全地从ZipInputStream提取文件"><span class="nav-number">1.2.7.</span> <span class="nav-text">规则1.7：安全地从ZipInputStream提取文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#规则1-8：禁止未经验证的用户输入直接输出到html界面"><span class="nav-number">1.2.8.</span> <span class="nav-text">规则1.8：禁止未经验证的用户输入直接输出到html界面</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="安全，几乎在任何应用开发中都是绕不过去的一个基础功能。当我们将应用转移到微服务架构时，安全将会更加复杂。在2016年David Borsos在伦敦的微服务大会上提出了以下四种方案：">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud入门教程（11）：微服务安全（Security）">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;10&#x2F;Spring-Cloud%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%8811%EF%BC%89%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%EF%BC%88Security%EF%BC%89&#x2F;index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="安全，几乎在任何应用开发中都是绕不过去的一个基础功能。当我们将应用转移到微服务架构时，安全将会更加复杂。在2016年David Borsos在伦敦的微服务大会上提出了以下四种方案：">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203133-463da.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203133-7159a.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203134-ab636.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203134-7eaf8.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203134-8d255.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203135-eb213.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203136-aedd1.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203136-28e99.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203137-548e5.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203138-2af0e.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203138-1e53b.png">
<meta property="og:updated_time" content="2020-01-10T13:44:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191111203133-463da.png">

<link rel="canonical" href="http://congsheng.wang/2020/01/10/Spring-Cloud%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%8811%EF%BC%89%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%EF%BC%88Security%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Spring Cloud入门教程（11）：微服务安全（Security） | 个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">congsheng的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/10/Spring-Cloud%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%8811%EF%BC%89%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%AE%89%E5%85%A8%EF%BC%88Security%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Cloud入门教程（11）：微服务安全（Security）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-10 21:44:29" itemprop="dateCreated datePublished" datetime="2020-01-10T21:44:29+08:00">2020-01-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Spring技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/Spring-Cloud/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Cloud</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>安全，几乎在任何应用开发中都是绕不过去的一个基础功能。当我们将应用转移到微服务架构时，安全将会更加复杂。在2016年David Borsos在伦敦的微服务大会上提出了以下四种方案：</p>
<a id="more"></a>

<ol>
<li><strong>单点登录(SSO)</strong>: 每个微服务都需要和认证服务交互，但这将产生大量非常琐碎的网络流量和重复的工作，当动在应用中存在数十个或更多微服务时，该方案的弊端就非常明显;</li>
<li><strong>分布式会话(Session)方案</strong>: 该方案将用户认证的信息存储在共享存储中(如：Redis)，并使用用户会话的ID作为key来实现的简单分布式哈希映射。当用户访问微服务时，可以通过会话的ID从从共享存储中获取用户认证信息。该方案在大部分时候非常不错，但其主要缺点在于共享存储需要一定保护机制，此时相应的实现就会相对复杂;</li>
<li><strong>客户端令牌(Token)方案</strong>: 令牌在客户端生成，并由认证服务器进行签名，令牌中包含足够的信息，以便各微服务可以使用。令牌会附加到每个请求上，为微服务提供用户身份验证。该解决方案的安全性相对较好，但由于令牌由客户端生成并保存，因此身份验证注销非常麻烦，一个折衷解决方案就是通过短期令牌和频繁检查认证服务来验证令牌是否有效等。对于客户端令牌JSON Web Tokens(JWT)是一个非常好的选择;</li>
<li><strong>客户端令牌与API网关结合</strong>: 使用该方案意味着所有请求都通过网关，从而有效地隐藏了微服务。在请求时，网关将原始用户令牌转换为内部会话。这样也就可以网关对令牌进行注销，从而解决上一种方案存在的问题。</li>
</ol>
<p>在本文中我们将着重介绍基于令牌的解决方案，而基于令牌的解决方案最好的选择就是OAuth2.0。</p>
<h2 id="1-OAuth2-0"><a href="#1-OAuth2-0" class="headerlink" title="1. OAuth2.0"></a>1. OAuth2.0</h2><p>关于OAuth2.0在维基百科中描述如下：</p>
<blockquote>
<p>开放授权（OAuth）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。</p>
</blockquote>
<blockquote>
<p>OAuth允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站（例如，视频编辑网站)在特定的时段（例如，接下来的2小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容。<br>OAuth 2.0是OAuth协议的下一版本，但不向下兼容OAuth 1.0。OAuth 2.0关注客户端开发者的简易性，同时为Web应用，桌面应用和手机，和起居室设备提供专门的认证流程。</p>
</blockquote>
<p>对于让我们首先了解一下OAuth2.0中的几个关键术语：</p>
<ul>
<li><strong>Resource Owner</strong>: 资源所有者，我们可以直接理解为：用户(User);</li>
<li><strong>User Agent</strong>: 用户代理，对于Web应用可以直接理解为浏览器;</li>
<li><strong>Authorization server</strong>: 认证服务器，即提供用户认证和授权的服务器，可以是独立服务器;</li>
<li><strong>Resource server</strong>: 资源服务器，这里我们可以理解为需要保护的微服务。</li>
</ul>
<p>然后，让我们看一下OAuth2.0的认证流程图(摘自RFC6749)：<br><img src="http://image.winrains.cn/2019/11/20191111203133-463da.png" alt="img"></p>
<p>Security-OAuth2-010.png</p>
<p>认证流程步骤如下：</p>
<ul>
<li>(A)用户打开客户端以后，客户端请求用户给予授权;</li>
<li>(B)用户同意授权给客户端;</li>
<li>(C)客户端使用上一步获得的授权，向认证服务器申请令牌;</li>
<li>(D)认证服务器对客户端进行认证以后，确认无误，同意发放令牌;</li>
<li>(E)客户端使用令牌，向资源服务器申请获取资源;</li>
<li>(F)资源服务器确认令牌无误，同意向客户端开放资源。</li>
</ul>
<p>从流程上可以得知客户端必须在得到用户授权后才能够从认证服务中获取到令牌。OAuth2.0针对客户端授权提供了下面四种授权方式:</p>
<ol>
<li><strong>授权码模式(authorization code)</strong>: 该种模式是功能最完整、流程最严密的授权模式;</li>
<li><strong>简化模式(implicit)</strong>: 该模式不需要通过第三方应用程序的服务器，跳过了”授权码”这个步骤，直接在浏览器中向认证服务器申请令牌，因此称为简化模式;</li>
<li><strong>密码模式(password)</strong>: 用户向客户端提供自己的用户名和密码，客户端通过这些信息直接向认证服务器获取授权;</li>
<li><strong>客户端模式(client credentials)</strong>: 指客户端以自己的名义，而不是以用户的名义向认证服务器获取认证，这种方式下认证服务器会将客户端作为一个用户来对待。</li>
</ol>
<h2 id="2-实现微服务安全"><a href="#2-实现微服务安全" class="headerlink" title="2. 实现微服务安全"></a>2. 实现微服务安全</h2><p>下面让我们着手来实现示例项目的安全管控。</p>
<h3 id="2-1-搭建认证服务器"><a href="#2-1-搭建认证服务器" class="headerlink" title="2.1 搭建认证服务器"></a>2.1 搭建认证服务器</h3><p>首先，我们会搭建一个认证服务器(Auth Server)。该服务器也是一个标准的Spring Boot框架应用。</p>
<h4 id="2-1-1-编写Maven文件"><a href="#2-1-1-编写Maven文件" class="headerlink" title="2.1.1 编写Maven文件"></a>2.1.1 编写Maven文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>twostepsfromjava.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>twostepsfromjava-cloud-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>auth-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>MS Blog Projects(Security): Auth Server<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></pre></td></tr></table></figure>

<p>在该配置文件中我们需要引入<code>spring-cloud-security</code>和<code>spring-security-oauth2</code>依赖。</p>
<h4 id="2-1-2-实现客户端管理"><a href="#2-1-2-实现客户端管理" class="headerlink" title="2.1.2 实现客户端管理"></a>2.1.2 实现客户端管理</h4><p>对于OAuth2.0应用来说需要实现一个客户端认证管理，这里我们直接继承<code>AuthorizationServerConfigurerAdapter</code>，并通过内存管理的方式增加了一个客户端应用，代码如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">io</span><span class="selector-class">.twostepsfromjava</span><span class="selector-class">.cloud</span><span class="selector-class">.auth</span><span class="selector-class">.config</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.beans</span><span class="selector-class">.factory</span><span class="selector-class">.annotation</span><span class="selector-class">.Autowired</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.userdetails</span><span class="selector-class">.UserDetailsService</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth2</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.configurers</span><span class="selector-class">.ClientDetailsServiceConfigurer</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth2</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.AuthorizationServerConfigurerAdapter</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth2</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configurers</span><span class="selector-class">.AuthorizationServerEndpointsConfigurer</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * OAuth2Server 配置</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @author CD826(CD826Dong@gmail.com)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @since 1.0.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">@<span class="keyword">Configuration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class OAuthConfig extends AuthorizationServerConfigurerAdapter &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    private AuthenticationManager authenticationManager;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    private UserDetailsService userDetailsService;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">clients</span><span class="selector-class">.inMemory</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.withClient</span>("<span class="selector-tag">malldemo</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.secret</span>("<span class="selector-tag">pgDBd99tOX8d</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.authorizedGrantTypes</span>("<span class="selector-tag">authorization_code</span>", "<span class="selector-tag">refresh_token</span>", "<span class="selector-tag">implicit</span>", "<span class="selector-tag">password</span>", "<span class="selector-tag">client_credentials</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.scopes</span>("<span class="selector-tag">webmall</span>");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">endpoints</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.authenticationManager</span>(<span class="selector-tag">authenticationManager</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.userDetailsService</span>(<span class="selector-tag">userDetailsService</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>客户端ID我们设置为<code>malldemo</code>，secret则设置为:<code>pgDBd99tOX8d</code>，同时我们还为客户端授权了<code>authorization_code</code>, <code>refresh_token</code>, <code>implicit</code>, <code>password</code>, <code>client_credentials</code>认证模式。并且在接下来的示例中我们会使用授权码模式和密码模式来进行测试。</p>
<h4 id="2-1-3-实现用户认证和授权的管理"><a href="#2-1-3-实现用户认证和授权的管理" class="headerlink" title="2.1.3 实现用户认证和授权的管理"></a>2.1.3 实现用户认证和授权的管理</h4><p>对于使用过Spring Security的同学来说对Security中用户认证和授权的管理应该不会陌生，这里也不再细讲，不熟悉的同学可以自行搜索来了解。示例中代码如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">io</span><span class="selector-class">.twostepsfromjava</span><span class="selector-class">.cloud</span><span class="selector-class">.auth</span><span class="selector-class">.config</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Bean</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.core</span><span class="selector-class">.annotation</span><span class="selector-class">.Order</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.http</span><span class="selector-class">.HttpMethod</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.authentication</span><span class="selector-class">.builders</span><span class="selector-class">.AuthenticationManagerBuilder</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.builders</span><span class="selector-class">.HttpSecurity</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.WebSecurityConfigurerAdapter</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.userdetails</span><span class="selector-class">.UserDetailsService</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * OAuth2 安全配置</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @author CD826(CD826Dong@gmail.com)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @since 1.0.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">@<span class="keyword">Configuration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">@<span class="keyword">Order</span>(<span class="keyword">org</span>.<span class="keyword">springframework</span>.<span class="keyword">boot</span>.<span class="keyword">autoconfigure</span>.<span class="keyword">security</span>.<span class="keyword">SecurityProperties</span>.<span class="keyword">ACCESS_OVERRIDE_ORDER</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class OAuthWebSecurityConfigurer extends WebSecurityConfigurerAdapter &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    @Bean</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">super</span><span class="selector-class">.authenticationManagerBean</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    @Bean</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    public UserDetailsService userDetailsServiceBean() throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">super</span><span class="selector-class">.userDetailsServiceBean</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    protected void configure(AuthenticationManagerBuilder auth) throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">auth</span><span class="selector-class">.inMemoryAuthentication</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.withUser</span>("<span class="selector-tag">user001</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.password</span>("<span class="selector-tag">pwd001</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.roles</span>("<span class="selector-tag">USER</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.and</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.withUser</span>("<span class="selector-tag">admin</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.password</span>("<span class="selector-tag">pwdAdmin</span>")</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.roles</span>("<span class="selector-tag">USER</span>", "<span class="selector-tag">ADMIN</span>");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    @<span class="keyword">Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    protected void configure(HttpSecurity http) throws Exception &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">http</span><span class="selector-class">.csrf</span>()<span class="selector-class">.disable</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">http</span><span class="selector-class">.authorizeRequests</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.anyRequest</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.authenticated</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.and</span>()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">                <span class="selector-class">.httpBasic</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在上面的代码中，我们依然通过内存方式进行管理，并创建了两个用户：</p>
<ul>
<li>user001: 是一个普通用户，只有<code>USER</code>角色;</li>
<li>admin: 是一个管理员用户，拥有<code>USER</code>和<code>ADMIN</code>角色。</li>
</ul>
<p>在上面的代码中我们还指定了所有访问都需要认真，并且开启了httpBasic认证，通过这个当一个未认证用户访问时就可以通过浏览器弹出一个认证对话框，可以让用户输入用户名和密码进行认证。</p>
<h4 id="2-1-4-实现应用引导类"><a href="#2-1-4-实现应用引导类" class="headerlink" title="2.1.4 实现应用引导类"></a>2.1.4 实现应用引导类</h4><p>对于我们所要实现的认证服务器来说最重要的就是需要在应用引导类中增加<code>@EnableAuthorizationServer</code>注解，通过该注解就可以启动Spring Cloud Security，并且为我们提供一系列端点，从而实现OAuth2.0的认证。这些端点分别为：</p>
<ul>
<li><code>/oauth/authorize</code>: 授权端点;</li>
<li><code>/oauth/token</code>: 获取访问令牌端点;</li>
<li><code>/oauth/confirm_access</code>: 用户确认授权提交端点;</li>
<li><code>/oauth/error</code>: 认证服务器错误信息获取端点;</li>
<li><code>/oauth/check_token</code>: 用于资源服务访问的令牌解析端点;</li>
<li><code>/oauth/token_key</code>: 如果使用JWT令牌，则公开用于令牌验证的公钥。</li>
</ul>
<h4 id="2-1-5-实现用户信息加载端点"><a href="#2-1-5-实现用户信息加载端点" class="headerlink" title="2.1.5 实现用户信息加载端点"></a>2.1.5 实现用户信息加载端点</h4><p>对于认证服务来说我们还需要提供一个用户信息加载端点，这样其它微服务就可以使用令牌从认证服务器获取认证用户的信息，从而能够实现用户认证及鉴权处理。具体实现代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.twostepsfromjava.cloud.auth.api;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashMap;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 获取当前认证用户的信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@author</span> CD826(CD826Dong<span class="doctag">@gmail</span>.com)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthEndpoint</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">protected</span> Logger logger = LoggerFactory.getLogger(AuthEndpoint<span class="class">.<span class="keyword">class</span>);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping(value = &#123; <span class="meta-string">"/auth/user"</span> &#125;, produces = <span class="meta-string">"application/json"</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; user(OAuth2Authentication user) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        Map&lt;String, Object&gt; userInfo = new HashMap&lt;&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        userInfo.put(<span class="string">"user"</span>, user.getUserAuthentication().getPrincipal());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        userInfo.put(<span class="string">"authorities"</span>, AuthorityUtils.authorityListToSet( user.getUserAuthentication().getAuthorities()));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> userInfo;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>该段代码将从Spring Security中获取到当前用户信息，并转化成一个Map对象返回。</p>
<h4 id="2-1-6-编写配置文件"><a href="#2-1-6-编写配置文件" class="headerlink" title="2.1.6 编写配置文件"></a>2.1.6 编写配置文件</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义应用端口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8290</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义应用名称</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=authserver</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.org.springframework</span>=INFO</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="attr">logging.level.io.twostepsfromjava</span>=DEBUG</span></pre></td></tr></table></figure>

<h3 id="2-2-完善用户微服务"><a href="#2-2-完善用户微服务" class="headerlink" title="2.2 完善用户微服务"></a>2.2 完善用户微服务</h3><p>接下来我们将对用户微服务进行修改，增加安全处理功能。</p>
<h4 id="2-2-1-引入Security依赖"><a href="#2-2-1-引入Security依赖" class="headerlink" title="2.2.1 引入Security依赖"></a>2.2.1 引入Security依赖</h4><p>对于用户微服务来说是一个Resource server，也就是资源服务器，当访问到某些资源时需要进行用户认证及鉴权，因此需要引入对Spring Cloud Security的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr></table></figure>

<h4 id="2-2-2-完善应用引导类修改"><a href="#2-2-2-完善应用引导类修改" class="headerlink" title="2.2.2 完善应用引导类修改"></a>2.2.2 完善应用引导类修改</h4><p>在Spring Cloud Security中我们只需要对需要进行安全管理的应用增加<code>@EnableResourceServer</code>注解来开启安全管控：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.twostepsfromjava.cloud;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * TwoStepsFromJava Cloud -- User Service 服务器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@author</span> CD826(CD826Dong@gmail.com)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableResourceServer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        SpringApplication.run(Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>当引入了<code>spring-cloud-security</code>并在应用引导类中增加了<code>@EnableResourceServer</code>注解时，应用就会开启默认的安全管控处理，如果你想在自己的应用中增加更细的安全管控，那么需要继承<code>WebSecurityConfigurerAdapter</code>并实现安全相关配置，这个在这里就不细讲了。</p>
<h4 id="2-2-3-完善应用配置"><a href="#2-2-3-完善应用配置" class="headerlink" title="2.2.3 完善应用配置"></a>2.2.3 完善应用配置</h4><p>我们需要在应用配置文件中增加获取认证用户信息的端点，具体配置如下：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta"># 保持原来的配置不变</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta"># OAuth2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">security.oauth2.resource.user-info-uri=http:<span class="comment">//localhost:8290/auth/user</span></span></pre></td></tr></table></figure>

<p>所配置的端点也就是之前我们在认证服务器所实现的获取当前登录用户信息的端点。</p>
<h4 id="2-2-4-增加获取当前用户信息的端点"><a href="#2-2-4-增加获取当前用户信息的端点" class="headerlink" title="2.2.4 增加获取当前用户信息的端点"></a>2.2.4 增加获取当前用户信息的端点</h4><p>为了进行测试，我们需要在用户微服务中增加一个获取当前已登录用户信息的端点，代码如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@<span class="constructor">RequestMapping(<span class="params">value</span> = <span class="string">"/my"</span>, <span class="params">method</span> = RequestMethod.GET)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public UserDto my<span class="constructor">Detail()</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Map curUser = (Map) <span class="module-access"><span class="module"><span class="identifier">SecurityContextHolder</span>.</span></span>get<span class="constructor">Context()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            .get<span class="constructor">Authentication()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            .get<span class="constructor">Principal()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    String userName = (String)curUser.get(<span class="string">"username"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    return <span class="keyword">new</span> <span class="constructor">UserDto(<span class="params">userName</span>, <span class="params">userName</span>, <span class="string">"/avatar/default.png"</span>, <span class="string">""</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这里的代码非常简单，就是直接从<code>SecurityContextHolder</code>中获取到当前已登录用户的信息，并构造成一个<code>UserDto</code>，然后返回。<br>Ok，到此用户微服务的改造就完成了。如果你现在启动用户微服务并进行访问上面所提供的端点，就会看到如下返回：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203133-7159a.png" alt="img"></p>
<p>未认证访问用户微服务</p>
<p>也就是说，现在需要权限才可以访问该端点。那么我们如何提供权限呢？<br>之前在讲OAuth2.0的时候我们提到客户端授权模式有四种，那么我们来看看如何使用这些授权模式来实现具体的用户认证处理。</p>
<h3 id="2-3-通过授权码模式-authorization-code-访问"><a href="#2-3-通过授权码模式-authorization-code-访问" class="headerlink" title="2.3 通过授权码模式(authorization code)访问"></a>2.3 通过授权码模式(authorization code)访问</h3><p>首先，让我们来看看如何通过OAuth2.0所提供的最全面的授权流程授权码模式来实现用户认证。<br>我们需要依次启动：服务治理服务器（Eureak Server）、认证服务器（Auth Server）和用户微服务。<br>第一步，我们首先来构造获取访问令牌的Url：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">http://localhost:<span class="number">8290</span>/oauth/authorize?response_type=code&amp;client_id=malldemo&amp;redirect_uri=http://localhost:<span class="number">8260</span>&amp;scope=webmall&amp;<span class="keyword">state</span>=<span class="number">63879</span></span></pre></td></tr></table></figure>

<p>对于该Url说明如下：</p>
<ul>
<li><code>/oauth/authorize</code>: 这个是获取授权码的端点;</li>
<li><code>client_id</code>: 客户端的ID，在请求的Url中必选包含。请注意一下我们这里给的值为: <code>malldemo</code>，这个就是我们在认证服务器中配置客户端列表是所配置的;</li>
<li><code>response_type</code>: 表示授权类型，也是必选的，对于授权码模式，这里固定填写为：<code>code</code>;</li>
<li><code>scope</code>: 表示申请的权限范围，可以不填。这个是指当有不同的客户端时所授权是否复用;</li>
<li><code>redirect_uri</code>: 授权成功后重定向到的URI;</li>
<li><code>state</code>: 表示客户端的当前状态，可以指定任意值，不论授权是否成功认证服务器都会原封不动地返回这个值。</li>
</ul>
<p>我们，接下来可以直接在浏览器中请求这个地址，然后返回的页面如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203134-ab636.png" alt="img"></p>
<p>用户登录截图</p>
<p>这个一个浏览器自身的用户登录窗口。因为，我们没有登录过，所以认证服务器通过<code>httpBasic</code>开启浏览器登录模式，这样当用户尚未认证时就会弹出如上的登录窗口。<br>我们在登录窗口中输入<code>user001</code>和<code>pwd001</code>也就是之前认证服务器中所配置的用户列表中的一个，然后就会跳转到如下页面：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203134-7eaf8.png" alt="img"></p>
<p>用户授权截图</p>
<p>这里就是用户是否授权的界面。在该界面中我们可以看到所传入的客户端应用的ID和授权范围都会显示出来。这里我们点击【Approve】，然后浏览器就会跳转到<code>redirect_uri</code>所指定的地址，这时候仔细观察所跳转回来的地址，如下:</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">http://localhost:<span class="number">8260</span>/?code=tn8n8F&amp;<span class="keyword">state</span>=<span class="number">63879</span></span></pre></td></tr></table></figure>

<p>可以发现在地址包含了两个参数：</p>
<ul>
<li><code>code</code>: 为认证服务所发放的授权码。该码的有效期很短，默认为10分钟，并且客户端只能使用该码一次，否则会被认证服务器拒绝。还需要说明一点就是该码与客户端ID及重定向URI，是一一对应关系;</li>
<li><code>state</code>: 这个就是上面我们请求时所传入的参数，认证服务器会原封不动的返回来。</li>
</ul>
<p>Ok，第一步我们已经获取到了授权码。那么第二步就是根据这个授权码来获取访问令牌，在获取访问令牌时我们使用Postman来进行，界面截图如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203134-8d255.png" alt="img"></p>
<p>获取访问令牌</p>
<p>这该截图中我们需要填写以下参数：</p>
<ul>
<li><code>/oauth/token</code>: 这个是获取访问令牌的端点;</li>
<li><code>grant_type</code>: 表示使用的授权模式，必须填写，对于授权码模式值固定为”authorization_code”;</li>
<li><code>code</code>: 也就是上一步我们所获得的授权码;</li>
<li><code>redirect_uri</code>: 获取成功后重定向到的URI，同样我们需要设置为之前所给的地址;</li>
<li><code>client_id</code>: 客户端ID，必须填写，而且需要与之前保持一致。</li>
</ul>
<p>此外，在上面的截图中我们还需要填写授权认证信息，这个因为我们认证服务器开启了权限验证，这里填写客户端的ID和secret即可。此时服务器就会把客户端作为一个用户来对待，从而能够访问<code>/oauth/token</code>端点。</p>
<blockquote>
<p>P.S. 这里这么做主要时简化测试方法，使得我们上一步访问时可以弹出认证对话框。但实际生产使用时不应这么做，需要自己定义用户登录页面、授权页面。</p>
</blockquote>
<p>上面的请求，我们可以获得如下返回：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203135-eb213.png" alt="img"></p>
<p>获取到访问令牌</p>
<p>返回的内容如下：</p>
<ul>
<li><code>access_token</code>: 这个是所获取访问令牌;</li>
<li><code>token_type</code>: 令牌类型，Spring Cloud OAuth默认返回的值为<code>bearer</code>;</li>
<li><code>expires_in</code>: 表示令牌过期时间，单位为秒，默认为12小时;</li>
<li><code>refresh_token</code>: 更新令牌，过期后可以用来获取下一次的访问令牌;</li>
<li><code>scope</code>: 权限范围，一般与客户端申请范围一致。</li>
</ul>
<p>有了访问令牌下一步我就可以访问用户微服务了，访问方式如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203136-aedd1.png" alt="img"></p>
<p>通过访问令牌访问用户微服务</p>
<p>访问时我们需要在Header中指定<code>Authorization</code>，并且将值设置为上一步所获取到的访问令牌即可，这样我们就可以得到正确的数据返回了，如上图所示。<br>这样我们就完成了通过授权码模式实现用户认证的测试。</p>
<h3 id="2-4-通过密码模式-password-访问"><a href="#2-4-通过密码模式-password-访问" class="headerlink" title="2.4 通过密码模式(password)访问"></a>2.4 通过密码模式(password)访问</h3><p>如果认证服务器是第三方的，那么使用上面的流程问题不大。如果认证服务器是我们自己搭建的，比如该示例，那么上面的授权显有点复杂。接下来让我们看看如何使用密码模式来简化。<br>我们按照下图方式来直接请求认证服务器获取访问令牌：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203136-28e99.png" alt="img"></p>
<p>通过密码获取用户授权-1</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203137-548e5.png" alt="img"></p>
<p>通过密码获取用户授权-2</p>
<p>在上图中我们需要同时设置客户端的ID、secret及访问用户的用户名和密码，并将<code>grant_type</code>设置为<code>password</code>，这样就可以直接获取到访问令牌，如下图所示：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203138-2af0e.png" alt="img"></p>
<p>通过密码获取访问令牌</p>
<p>然后，我们根据所获取到的访问令牌再次访问用户微服务，可以获取如下界面：</p>
<p><img src="http://image.winrains.cn/2019/11/20191111203138-1e53b.png" alt="img"></p>
<p>访问用户微服务</p>
<p>这说明，用户认证也是成功的。<br>可见，通过密码模式可以大大简化用户认证流程，但是需要用户信任客户端的情况下才会提供，因此这种方式适合客户端与认证服务器是同一个应用的情况下。<br>对于其它客户端授权模式这里就不再一一进行测试了。本文中所提到的示例你可以在<a href="https://github.com/cd826/springcloud-sample-projects/tree/master/sleuth" target="_blank" rel="noopener">这里</a>下载。</p>
<blockquote>
<p>作者：CD826</p>
<p>来源：<a href="https://www.jianshu.com/p/664c71b6681a" target="_blank" rel="noopener">https://www.jianshu.com/p/664c71b6681a</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/10/Spring-Cloud%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B%EF%BC%8810%EF%BC%89%EF%BC%9A%E6%B6%88%E6%81%AF%E6%80%BB%E7%BA%BF-Bus/" rel="prev" title="Spring Cloud入门教程（10）：消息总线(Bus)">
      <i class="fa fa-chevron-left"></i> Spring Cloud入门教程（10）：消息总线(Bus)
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/10/Spring-Cloud%EF%BC%880%EF%BC%89%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF/" rel="next" title="Spring Cloud（0）：微服务的那些事儿">
      Spring Cloud（0）：微服务的那些事儿 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-OAuth2-0"><span class="nav-number">1.</span> <span class="nav-text">1. OAuth2.0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-实现微服务安全"><span class="nav-number">2.</span> <span class="nav-text">2. 实现微服务安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-搭建认证服务器"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 搭建认证服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-编写Maven文件"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1 编写Maven文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-实现客户端管理"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2 实现客户端管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-实现用户认证和授权的管理"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3 实现用户认证和授权的管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-实现应用引导类"><span class="nav-number">2.1.4.</span> <span class="nav-text">2.1.4 实现应用引导类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-5-实现用户信息加载端点"><span class="nav-number">2.1.5.</span> <span class="nav-text">2.1.5 实现用户信息加载端点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-6-编写配置文件"><span class="nav-number">2.1.6.</span> <span class="nav-text">2.1.6 编写配置文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-完善用户微服务"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 完善用户微服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-1-引入Security依赖"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.2.1 引入Security依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-2-完善应用引导类修改"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2.2 完善应用引导类修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-3-完善应用配置"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.2.3 完善应用配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-4-增加获取当前用户信息的端点"><span class="nav-number">2.2.4.</span> <span class="nav-text">2.2.4 增加获取当前用户信息的端点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-通过授权码模式-authorization-code-访问"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 通过授权码模式(authorization code)访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-通过密码模式-password-访问"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 通过密码模式(password)访问</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="1.简介Spring Boot是由Pivotal团队提供的快速开发框架，基于SpringMVC通过注解+内置Http服务器如：tomcat-embed-core，简化了XML配置，快速将一些常用的第三方依赖整合（通过Maven继承依赖关系），最终实现以Java应用程序的方式进行执行。">
<meta name="keywords" content="源码">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot源码分析（1）：启动原理">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;08&#x2F;Spring-Boot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9A%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86&#x2F;index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="1.简介Spring Boot是由Pivotal团队提供的快速开发框架，基于SpringMVC通过注解+内置Http服务器如：tomcat-embed-core，简化了XML配置，快速将一些常用的第三方依赖整合（通过Maven继承依赖关系），最终实现以Java应用程序的方式进行执行。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191105165623-75c5a.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191105165625-834c8.png">
<meta property="og:updated_time" content="2020-01-08T07:03:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191105165623-75c5a.png">

<link rel="canonical" href="http://congsheng.wang/2020/01/08/Spring-Boot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9A%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Spring Boot源码分析（1）：启动原理 | 个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">congsheng的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/08/Spring-Boot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%881%EF%BC%89%EF%BC%9A%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Boot源码分析（1）：启动原理
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 15:03:09" itemprop="dateCreated datePublished" datetime="2020-01-08T15:03:09+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Spring技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/Spring-Boot/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Boot</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h1><p>Spring Boot是由Pivotal团队提供的快速开发框架，基于SpringMVC通过注解+内置Http服务器如：tomcat-embed-core，简化了XML配置，快速将一些常用的第三方依赖整合（通过Maven继承依赖关系），最终实现以Java应用程序的方式进行执行。</p>
<a id="more"></a>

<h2 id="1-1-SpringBoot起源"><a href="#1-1-SpringBoot起源" class="headerlink" title="1.1 SpringBoot起源"></a>1.1 SpringBoot起源</h2><ul>
<li>Spring框架：Spring框架从早期的IOC与AOP衍生出了很多产品例如Spring (boot、security、jpa)等等</li>
<li>SpringMVC框架：Spring MVC提供了一种轻度耦合的方式来开发web应用,它是Spring的一个web框架。通过Dispatcher Servlet, ModelAndView 和 View Resolver，开发web应用变得很容易。解决的问题领域是网站应用程序或者服务开发——URL路由、Session、模板引擎、静态Web资源等等，是基于Spring的一个 MVC 框架。</li>
<li>SpringBoot框架：Spring Boot实现了自动配置，降低了项目搭建的复杂度。它主要是为了解决使用Spring框架需要进行大量的配置太麻烦的问题，所以它并不是用来替代Spring的解决方案，而是和Spring框架紧密结合用于提升Spring开发者体验的工具。同时它集成了大量常用的第三方库配置(例如Jackson, JDBC, Mongo, Redis, Mail等等)，是基于Spring4的条件注册的一套快速开发整合包。</li>
</ul>
<p><img src="http://image.winrains.cn/2019/11/20191105165623-75c5a.png" alt="http://image.winrains.cn/2019/11/20191105165623-75c5a.png"></p>
<h2 id="1-2-便捷的starter-poms-启动器"><a href="#1-2-便捷的starter-poms-启动器" class="headerlink" title="1.2 便捷的starter poms (启动器)"></a>1.2 便捷的starter poms (启动器)</h2><p>starter包含了搭建项目快速运行所需的依赖。它是一个依赖关系描述符的集合。当应用需要一种spring的其它服务时，不需要粘贴拷贝大量的依赖关系描述符。例如想在spring中使用redis，只需要在项目中包含 spring-boot-starter-redis 依赖就可以使用了，所有的starters遵循一个相似的命名模式：spring-boot-starter-<em>，在这里</em>是一种特殊类型的应用程序。该命名结构可以帮你找到需要的starter。很多IDEs集成的Maven允许你通过名称搜索依赖。</p>
<h2 id="1-3-demo"><a href="#1-3-demo" class="headerlink" title="1.3 demo"></a>1.3 demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoApplication</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        SpringApplication.run(DemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这是一个简单的SpringBoot的启动类实现，下文章将围绕这个demo进行扩展分析。</p>
<h2 id="1-4-SpringBoot启动流程"><a href="#1-4-SpringBoot启动流程" class="headerlink" title="1.4 SpringBoot启动流程"></a>1.4 SpringBoot启动流程</h2><p><img src="http://image.winrains.cn/2019/11/20191105165625-834c8.png" alt="http://image.winrains.cn/2019/11/20191105165625-834c8.png"></p>
<h1 id="2-SpringBootApplication注解分析"><a href="#2-SpringBootApplication注解分析" class="headerlink" title="2 @SpringBootApplication注解分析"></a>2 @SpringBootApplication注解分析</h1><p>以下是注解@SpringBootApplication的源码实现</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Target</span>(ElementType.TYPE)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Documented</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Inherited</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@SpringBootConfiguration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@EnableAutoConfiguration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@ComponentScan</span>(excludeFilters = &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="variable">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="variable">@Filter</span>(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">public <span class="variable">@interface</span> SpringBootApplication &#123;</span></pre></td></tr></table></figure>

<p>可以发现它是由众多注解组合而成的，下面具体分析下这里每个注解所起到的作用。</p>
<ul>
<li><p>@Target Target通过ElementType来指定注解可使用范围的枚举集合（FIELD/METHOD/PARAMETER…）</p>
</li>
<li><p>@Retention Retention(保留)注解说明,这种类型的注解会被保留到那个阶段. 有三个值:</p>
<ul>
<li>RetentionPolicy.SOURCE —— 这种类型的Annotations只在源代码级别保留,编译时就会被忽略</li>
<li>RetentionPolicy.CLASS —— 这种类型的Annotations编译时被保留,在class文件中存在,但JVM将会忽略</li>
<li>RetentionPolicy.RUNTIME —— 这种类型的Annotations将被JVM保留,所以他们能在运行时被JVM或其他使</li>
</ul>
</li>
<li><p>@Documented 注解表明这个注解应该被 javadoc工具记录. 默认情况下,javadoc是不包括注解的. 但如果声明注解时指定了 @Documented,则它会被 javadoc 之类的工具处理, 所以注解类型信息也会被包括在生成的文档中</p>
</li>
<li><p>@Inherited 允许子类继承父类的注解，仅限于类注解有用，对于方法和属性无效。</p>
</li>
<li><p>@SpringBootConfiguration 注解实际上和@Configuration有相同的作用，配备了该注解的类就能够以JavaConfig的方式完成一些配置，可以不再使用XML配置。</p>
</li>
<li><p>@ComponentScan 这个注解完成的是自动扫描的功能，相当于Spring XML配置文件中的：``,可使用basePackages属性指定要扫描的包，及扫描的条件。如果不设置则默认扫描@ComponentScan注解所在类的同级类和同级目录下的所有类，所以我们的Spring Boot项目，一般会把入口类放在顶层目录中，这样就能够保证源码目录下的所有类都能够被扫描到。</p>
</li>
<li><p>@EnableAutoConfiguration 这个注解是让Spring Boot的配置能够如此简化的关键性注解。我把EnableAutoConfiguration的实现端上来了，大家来鉴赏一下！</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Target</span>(ElementType.TYPE)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Documented</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Inherited</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@AutoConfigurationPackage</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Import</span>(AutoConfigurationImportSelector.class)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">public <span class="variable">@interface</span> EnableAutoConfiguration &#123;</span></pre></td></tr></table></figure>

<ul>
<li>@AutoConfigurationPackage 注解用于保存自动配置类以供之后的使用，比如给JPA entity扫描器，用来扫描开发人员通过注解@Entity定义的entity类。通俗的讲就是，注册bean定义到容器中。</li>
<li><strong>@Import(AutoConfigurationImportSelector.class)</strong>是EnableAutoConfiguration注解中最关键的来，它借助AutoConfigurationImportSelector，可以帮助SpringBoot应用将所有符合条件的@Configuration配置都加载到当前SpringBoot创建并使用的IoC容器中。关于@Import注解要说的内容还比较多，改天再聊。</li>
</ul>
</li>
</ul>
<p>关于注解的话题就先谈到这里，下面开启撸代码环节。</p>
<h1 id="3-剖析代码"><a href="#3-剖析代码" class="headerlink" title="3 剖析代码"></a>3 剖析代码</h1><p>查看SpringApplication的源代码可以发现SpringApplication的启动由两部分组成：</p>
<ul>
<li>new SpringApplication(primarySources)：创建SpringApplication对象</li>
<li>run(args)：调用run方法</li>
</ul>
<h2 id="3-1-实例化SpringApplication对象"><a href="#3-1-实例化SpringApplication对象" class="headerlink" title="3.1 实例化SpringApplication对象"></a>3.1 实例化SpringApplication对象</h2><p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.resourceLoader = resourceLoader;<span class="comment">//1、初始化资源加载器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);<span class="comment">//2、断言资源加载类不能为 null</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));<span class="comment">//3、初始化加载资源类集合并去重</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.webApplicationType = deduceWebApplicationType();<span class="comment">//4、 推断应用类型是Standard还是Web</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    setInitializers((Collection) getSpringFactoriesInstances(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;<span class="comment">//5、设置应用上下文初始化器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;<span class="comment">//6、设置监听器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();<span class="comment">//7、推断应用入口类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>下面将针对源码中的重要实现进行详细的分析。</p>
<h3 id="3-1-1-初始化资源加载器"><a href="#3-1-1-初始化资源加载器" class="headerlink" title="3.1.1 初始化资源加载器"></a>3.1.1 初始化资源加载器</h3><p>ResourceLoader接口，在 Spring 中用于加载资源，通过它可以获取一个Resouce 对象。使用spring的朋友都知道它加载资源的方式由多种，下面就挑两个常用的继承ResourceLoader的接口与实现类说起。</p>
<ul>
<li>DefaultResourceLoader ： 作为 ResourceLoader 接口的直接实现类，该类实现了基本的资源加载功能，可以实现对单个资源的加载。</li>
<li>ResourcePatternResolver ：该接口继承了 ResourceLoader，定义了加载多个资源的方法， 可以实现对多个资源的加载。</li>
</ul>
<p><strong>1、DefaultResourceLoader</strong><br>上面介绍过该类通过实现 ResourceLoader 接口实现了加载单个资源的功能。它的子类通过继承它来实现具体的资源访问策略。下面来探究下该类如何加载单个资源：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public Resource get<span class="constructor">Resource(String <span class="params">location</span>)</span> &#123;<span class="comment">//这里是三种识别location加载出Resource的方式。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Assert</span>.</span></span>not<span class="constructor">Null(<span class="params">location</span>, <span class="string">"Location must not be null"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1.先看有没有自定义的ProtocolResolver，如果有则先根据自定义的ProtocolResolver解析location得到Resource</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    for (ProtocolResolver protocolResolver : this.protocolResolvers) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Resource resource = protocolResolver.resolve(location, this);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (resource != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            return resource;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//2.根据路径是否匹配"/"或"classpath:"来解析得到ClassPathResource</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (location.starts<span class="constructor">With(<span class="string">"/"</span>)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        return get<span class="constructor">ResourceByPath(<span class="params">location</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (location.starts<span class="constructor">With(CLASSPATH_URL_PREFIX)</span>) &#123;<span class="comment">//classpath</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">ClassPathResource(<span class="params">location</span>.<span class="params">substring</span>(CLASSPATH_URL_PREFIX.<span class="params">length</span>()</span>), get<span class="constructor">ClassLoader()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;<span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//默认传入的location是一个URL路径，加载得到一个UrlResource</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            URL url = <span class="keyword">new</span> <span class="constructor">URL(<span class="params">location</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            return (<span class="module-access"><span class="module"><span class="identifier">ResourceUtils</span>.</span></span>is<span class="constructor">FileURL(<span class="params">url</span>)</span> ? <span class="keyword">new</span> <span class="constructor">FileUrlResource(<span class="params">url</span>)</span> : <span class="keyword">new</span> <span class="constructor">UrlResource(<span class="params">url</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        catch (MalformedURLException ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// 如果以上三种情况都不满足，则按照“/”来处理</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            return get<span class="constructor">ResourceByPath(<span class="params">location</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>扫盲</strong>：ProtocolResolver是解析location的自定义拓展类，有了它我们才能随意传入不同格式的location，然后根据对应的格式去解析并获得我们的Resource即可。<br><strong>扩展</strong>：在Spring容器初始化过程中，我们可以自定义一个类实现ProtocolResolver接口，然后实现该resolve方法，就可以解析特定的location得到Resoure。<br><strong>2、ResourcePatternResolver</strong><br>该接口继承了ResourceLoader接口，在其基础上增加了同时对多个资源的访问功能。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResourcePatternResolver</span> <span class="keyword"><span class="keyword">extends</span> <span class="type">ResourceLoader</span></span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">String</span> CLASSPATH_ALL_URL_PREFIX = <span class="string">"classpath*:"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 例如使用 ant 风格的路径，匹配路径下的多个资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Resource[] getResources(<span class="keyword">String</span> locationPattern) throws IOException;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>PathMatchingResourcePatternResolver是 ResourcePatternResolver 接口的直接实现类，它是基于模式匹配的，默认使用AntPathMatcher 进行路径匹配，它除了支持 ResourceLoader 支持的前缀外，还额外支持 “classpath*” ，下面查看源码看看它如何实现对多个资源的访问。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public Resource<span class="literal">[]</span> get<span class="constructor">Resources(String <span class="params">locationPattern</span>)</span> throws IOException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="module-access"><span class="module"><span class="identifier">Assert</span>.</span></span>not<span class="constructor">Null(<span class="params">locationPattern</span>, <span class="string">"Location pattern must not be null"</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">     <span class="comment">//首先判断资源路径是否是类路径下的资源（以 “classpath*:” 开头）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (locationPattern.starts<span class="constructor">With(CLASSPATH_ALL_URL_PREFIX)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 通过 getPathMatcher 方法取得 PathMatcher ，默认只有 AntPathMatcher 一个实现类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">       <span class="comment">// 通过 isPattern 方法判断路径是否允许存在多个匹配的资源（路径中包含 “*” 或 “?”）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (get<span class="constructor">PathMatcher()</span>.is<span class="constructor">Pattern(<span class="params">locationPattern</span>.<span class="params">substring</span>(CLASSPATH_ALL_URL_PREFIX.<span class="params">length</span>()</span>))) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//找到所有匹配路径（ant 风格）的资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            return find<span class="constructor">PathMatchingResources(<span class="params">locationPattern</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//通过类加载器查找</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            return find<span class="constructor">AllClassPathResources(<span class="params">locationPattern</span>.<span class="params">substring</span>(CLASSPATH_ALL_URL_PREFIX.<span class="params">length</span>()</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">int</span> prefixEnd = (locationPattern.starts<span class="constructor">With(<span class="string">"war:"</span>)</span> ? locationPattern.index<span class="constructor">Of(<span class="string">"*/"</span>)</span> + <span class="number">1</span> :</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                locationPattern.index<span class="constructor">Of(':')</span> + <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 判断资源路径 ":" 之后的部分是否包含 "*" 或 "?"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (get<span class="constructor">PathMatcher()</span>.is<span class="constructor">Pattern(<span class="params">locationPattern</span>.<span class="params">substring</span>(<span class="params">prefixEnd</span>)</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// a file pattern</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            return find<span class="constructor">PathMatchingResources(<span class="params">locationPattern</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// 若不存在表示是单个资源，则通过从构造函数传入的 ResourceLoader 取得</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            return <span class="keyword">new</span> Resource<span class="literal">[]</span> &#123;get<span class="constructor">ResourceLoader()</span>.get<span class="constructor">Resource(<span class="params">locationPattern</span>)</span>&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p><strong>扩展</strong>：查看源码发现ApplicationContext接口也继承了 ResourcePatternResolver 接口，说明它也集成了对对单个或多个资源的访问功能。</p>
<ul>
<li><p>当 Spring 需要进行资源访问时，实际上并不需要直接使用 Resource 实现类，而是调用 getResource 方法来获取资源。</p>
</li>
<li><p>当通过 ApplicationContext 实例获取 Resource 实例时，它将会负责选择具体的 Resource 的实现类。代码如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Resource <span class="keyword">res</span> = ctx.getResource(<span class="comment">"some/resource/path/myTemplate.txt);</span></span></pre></td></tr></table></figure>

</li>
</ul>
<p>Spring采用和 ApplicationContext 相同的策略来访问资源。也就是说：</p>
<ul>
<li>如果 ApplicationContext 是 FileSystemXmlApplicationContext，res 就是 FileSystemResource 实例；</li>
<li>如果 ApplicationContext 是 ClassPathXmlApplicationContext，res 就是 ClassPathResource 实例；</li>
<li>如果 ApplicationContext 是 XmlWebApplicationContext，res 是 ServletContextResource 实例。</li>
</ul>
<p>也就是说 ApplicationContext 将会确定具体的资源访问策略，从而将应用程序和具体的资源访问策略分离开来，这就体现了策略模式的优势。</p>
<h3 id="3-1-2-设置应用上下文初始化器setInitializers"><a href="#3-1-2-设置应用上下文初始化器setInitializers" class="headerlink" title="3.1.2 设置应用上下文初始化器setInitializers"></a>3.1.2 设置应用上下文初始化器setInitializers</h3><ul>
<li><strong>介绍</strong>：initializers是SpringApplication中的一个实例属性：List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers，每一个initailizer都是一个实现了ApplicationContextInitializer接口的实例。ApplicationContextInitializer是Spring IOC容器中提供的一个接口，源码如下：</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>ApplicationContextInitializer&lt;C extends ConfigurableApplicationContext&gt;&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    void initialize(C applicationContext);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<ul>
<li><strong>作用</strong>：ApplicationContextInitializer接口的作用就是在spring prepareContext的时候做一些初始化工作，在spring 初始化的过程中 执行prepareContext方法的时候里面会通过applyInitializers方法回调所有ApplicationContextInitializer接口的实现。所以在SpringApplication的构造方法中执行了setInitializers方法，该方法是把初始化的ApplicationContextInitializer实现类全部加载到SpringApplication内部的集合中。</li>
<li><strong>实现</strong>：这些初始化器(initializers)是Spring Boot从本地的META-INF/spring.factories文件和jar文件中的META-INF/spring.factories 文件获取配置的初始化类（注意这边是获取了配置文件的全部配置类），然后通过loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</li>
</ul>
<p>}方法获得ApplicationContextInitializer接口全部实现类的完整名称，最后通过反射的机制获得ApplicationContextInitializer实现类。</p>
<ul>
<li><strong>使用</strong>：通过getSpringFactoriesInstances(</li>
</ul>
<p>ApplicationContextInitializer.class)方法获得实现类</p>
<h3 id="3-1-3-设置监听器-setListeners"><a href="#3-1-3-设置监听器-setListeners" class="headerlink" title="3.1.3 设置监听器(setListeners)"></a>3.1.3 设置监听器(setListeners)</h3><p>listeners成员变量，是一个ApplicationListener&lt;?&gt;类型对象的集合。可以看到获取该成员变量内容使用的是跟成员变量initializers一样的方法，只不过传入的类型从ApplicationContextInitializer.class变成了ApplicationListener.class。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">ApplicationListener</span>&lt;<span class="symbol">E</span> <span class="symbol">extends</span> <span class="symbol">ApplicationEvent</span>&gt; <span class="symbol">extends</span> <span class="symbol">EventListener</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">void</span> onApplicationEvent(E event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这个接口基于JDK中的EventListener接口，实践了观察者模式。对于Spring框架的观察者模式实现，它限定感兴趣的事件类型需要是ApplicationEvent类型的子类，而这个类同样是继承自JDK中的EventObject类。</p>
<h3 id="3-1-4-推断应用入口类"><a href="#3-1-4-推断应用入口类" class="headerlink" title="3.1.4 推断应用入口类"></a>3.1.4 推断应用入口类</h3><p>该方法通过构造一个运行时异常，通过异常栈中方法名为main的栈帧来得到main()所在类的名字。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Class&lt;?&gt; deduce<span class="constructor">MainApplicationClass()</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        StackTraceElement<span class="literal">[]</span> stackTrace = <span class="keyword">new</span> <span class="constructor">RuntimeException()</span>.get<span class="constructor">StackTrace()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        for (StackTraceElement stackTraceElement : stackTrace) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (<span class="string">"main"</span>.equals(stackTraceElement.get<span class="constructor">MethodName()</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">                return <span class="module-access"><span class="module"><span class="identifier">Class</span>.</span></span>for<span class="constructor">Name(<span class="params">stackTraceElement</span>.<span class="params">getClassName</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    catch (ClassNotFoundException ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Swallow and continue</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    return null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h2 id="3-2-run方法"><a href="#3-2-run方法" class="headerlink" title="3.2 run方法"></a>3.2 run方法</h2><p>源码如下：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public ConfigurableApplicationContext run(String... args) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1、计时监控类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    stopWatch<span class="variable">.start</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 2、初始化应用上下文和异常报告集合</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    ConfigurableApplicationContext <span class="keyword">context</span> = <span class="literal">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 3、设置系统属性java.awt.headless的值，默认值为：true（没有图形化界面）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    configureHeadlessProperty();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 4、创建所有 Spring 运行监听器并发出开始执行的事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    SpringApplicationRunListeners listeners = getRunListeners(args);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    listeners<span class="variable">.starting</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    try &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 5、初始化默认应用参数类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                args);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 6、根据SpringApplicationRunListeners和应用参数来准备 Spring 环境</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        ConfigurableEnvironment environment = prepareEnvironment(listeners,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                applicationArguments);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        configureIgnoreBeanInfo(environment);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 7、准备Banner打印器 - 就是启动Spring Boot的时候打印在console上的ASCII艺术字体</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        Banner printedBanner = printBanner(environment);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 8、创建Spring上下文</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">context</span> = createApplicationContext();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 9、准备异常报告器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        exceptionReporters = getSpringFactoriesInstances(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">                SpringBootExceptionReporter<span class="variable">.class</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">new</span> Class[] &#123; ConfigurableApplicationContext<span class="variable">.class</span> &#125;, <span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 10、Spring上下文前置处理</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        prepareContext(<span class="keyword">context</span>, environment, listeners, applicationArguments,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">                printedBanner);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 11、刷新Spring上下文</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        refreshContext(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 12、Spring上下文后置处理</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        afterRefresh(<span class="keyword">context</span>, applicationArguments);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 13、停止计时监控类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        stopWatch<span class="variable">.stop</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 14、输出日志记录执行主类名、时间信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span><span class="variable">.logStartupInfo</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span><span class="variable">.mainApplicationClass</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">                    <span class="variable">.logStarted</span>(getApplicationLog(), stopWatch);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 15、发布应用上下文启动完成事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        listeners<span class="variable">.started</span>(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 16、执行所有 Runner 运行器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        callRunners(<span class="keyword">context</span>, applicationArguments);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    catch (Throwable ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        handleRunFailure(<span class="keyword">context</span>, ex, exceptionReporters, listeners);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> IllegalStateException(ex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    try &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 17、发布应用上下文就绪事件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        listeners<span class="variable">.running</span>(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    catch (Throwable ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        handleRunFailure(<span class="keyword">context</span>, ex, exceptionReporters, <span class="literal">null</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">        throw <span class="keyword">new</span> IllegalStateException(ex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 18、返回应用上下文</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">context</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>下面针对run方法中提到的一些重要步骤进行阐述：</p>
<h3 id="3-2-1-计时监控类"><a href="#3-2-1-计时监控类" class="headerlink" title="3.2.1 计时监控类"></a>3.2.1 计时监控类</h3><p>启动方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    start(<span class="string">""</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(String taskName)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentTaskName != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't start StopWatch: it's already running"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.currentTaskName = taskName;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.startTimeMillis = System.currentTimeMillis();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>你可以看到它传入了一个空字符串给当前任务作为任务名称，然后记录当前Spring Boot应用启动的开始时间。并且它会判断当前任务名是否存在，用于保证Spring Boot应用不重复启动。</p>
<h3 id="3-2-2-初始化应用上下文和异常报告集合"><a href="#3-2-2-初始化应用上下文和异常报告集合" class="headerlink" title="3.2.2 初始化应用上下文和异常报告集合"></a>3.2.2 初始化应用上下文和异常报告集合</h3><p>这里仅初始化一个应用上下文对象context和一个空的异常报告集合，具体用途看下文。</p>
<h3 id="3-2-3-设置系统属性"><a href="#3-2-3-设置系统属性" class="headerlink" title="3.2.3 设置系统属性"></a>3.2.3 设置系统属性</h3><p>configureHeadlessProperty的方法实现如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureHeadlessProperty</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    System.setProperty(SYSTEM_PROPERTY_JAVA_AWT_HEADLESS, System.getProperty(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">            SYSTEM_PROPERTY_JAVA_AWT_HEADLESS, Boolean.toString(<span class="keyword">this</span>.headless)));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">String</span> SYSTEM_PROPERTY_JAVA_AWT_HEADLESS = <span class="string">"java.awt.headless"</span>;</span></pre></td></tr></table></figure>

<p>该方法设置了一个名为java.awt.headless的系统属性，观其源码可以发现它给属性设值System.setProperty(),而它的值来源于System.getProperty()，这并不奇怪，因为System中getProperty()有2个重载方法，其中getProperty()有单参和双参两个方法,这里调用的是双参数方法，该方法在没有的时候会返回一个调用者指定的默认值，所以这里先获取后设置。这个设置的目的是保证即使没有检测到显示器（服务器不需要显示器）,也允许程序启动。</p>
<h3 id="3-2-4-创建所有-Spring-运行监听器并发出开始执行的事件"><a href="#3-2-4-创建所有-Spring-运行监听器并发出开始执行的事件" class="headerlink" title="3.2.4 创建所有 Spring 运行监听器并发出开始执行的事件"></a>3.2.4 创建所有 Spring 运行监听器并发出开始执行的事件</h3><p>实现如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据args获取所有SpringApplicationRunListeners监听器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">SpringApplicationRunListeners listeners = get<span class="constructor">RunListeners(<span class="params">args</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//这段代码大家应该已经熟悉了,获取SpringApplicationRunListeners扩展</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> SpringApplicationRunListeners get<span class="constructor">RunListeners(String[] <span class="params">args</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Class&lt;?&gt;<span class="literal">[]</span> types = <span class="keyword">new</span> Class&lt;?&gt;<span class="literal">[]</span>&#123;<span class="module-access"><span class="module"><span class="identifier">SpringApplication</span>.</span></span><span class="keyword">class</span>, String<span class="literal">[]</span>.<span class="keyword">class</span>&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    return <span class="keyword">new</span> <span class="constructor">SpringApplicationRunListeners(<span class="params">logger</span>, <span class="params">getSpringFactoriesInstances</span>(SpringApplicationRunListener.<span class="params">class</span>, <span class="params">types</span>, <span class="params">this</span>, <span class="params">args</span>)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>通过Class<?>[] types = new Class<?>[]{SpringApplication.class, String[].class};类型加载对应的监听器,并创建SpringApplicationRunListener实例<br>下面的内容和之前实例化初始化器的流程是一样，通过getSpringFactoriesInstances方法从spring.factories中获取与SpringApplicationRunListener.class相关的实例类名列表。</p>
<h3 id="3-2-5-初始化默认应用参数类"><a href="#3-2-5-初始化默认应用参数类" class="headerlink" title="3.2.5 初始化默认应用参数类"></a>3.2.5 初始化默认应用参数类</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">ApplicationArguments applicationArguments = <span class="keyword">new</span> <span class="constructor">DefaultApplicationArguments(<span class="params">args</span>)</span>;</span></pre></td></tr></table></figure>

<p>args是启动Spring应用的命令行参数，该参数可以在Spring应用中被访问。<br>如：–server.port=9000</p>
<h3 id="3-2-6-根据运行监听器和应用参数来准备-Spring-环境"><a href="#3-2-6-根据运行监听器和应用参数来准备-Spring-环境" class="headerlink" title="3.2.6 根据运行监听器和应用参数来准备 Spring 环境"></a>3.2.6 根据运行监听器和应用参数来准备 Spring 环境</h3><p>创建并配置当前SpringBoot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile(其作用就是指定激活的配置文件，可以区分环境来加载不同的配置)）,并遍历调用所有的SpringApplicationRunListener的environmentPrepared()方法，广播Environment准备完毕。<br>源码如下：</p>
<figure class="highlight rsl"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment prepareEnvironment(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        SpringApplicationRunListeners listeners,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        ApplicationArguments applicationArguments) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//获取或创建环境（存在就直接返回，不存在创建一个再返回）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    ConfigurableEnvironment <span class="built_in">environment</span> = getOrCreateEnvironment();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//配置环境：配置PropertySources和activeProfiles</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    configureEnvironment(<span class="built_in">environment</span>, applicationArguments.getSourceArgs());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//listeners环境准备(就是广播ApplicationEnvironmentPreparedEvent事件)。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    listeners.environmentPrepared(<span class="built_in">environment</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//将环境绑定到SpringApplication</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    bindToSpringApplication(<span class="built_in">environment</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//如果非web环境，将环境转换成StandardEnvironment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (this.webApplicationType == WebApplicationType.NONE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">environment</span> = new EnvironmentConverter(getClassLoader())</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                .convertToStandardEnvironmentIfNecessary(<span class="built_in">environment</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//配置PropertySources对它自己的递归依赖</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    ConfigurationPropertySources.attach(<span class="built_in">environment</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="built_in">environment</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>prepareEnvironment的作用：加载外部化配置资源到environment，包括命令行参数、servletConfigInitParams、servletContextInitParams、systemProperties、sytemEnvironment、random、application.yml(.yaml/.xml/.properties)等；初始化日志系统。</p>
<h3 id="3-2-7-准备Banner打印器"><a href="#3-2-7-准备Banner打印器" class="headerlink" title="3.2.7 准备Banner打印器"></a>3.2.7 准备Banner打印器</h3><p>该功能仅供自娱自乐，不做过多解读，看源码便是。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Banner printBanner(ConfigurableEnvironment environment) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.bannerMode == Banner.Mode.OFF) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    ResourceLoader resourceLoader = (<span class="keyword">this</span>.resourceLoader != <span class="literal">null</span> ? <span class="keyword">this</span>.resourceLoader</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            : new DefaultResourceLoader(getClassLoader()));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    SpringApplicationBannerPrinter bannerPrinter = new SpringApplicationBannerPrinter(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            resourceLoader, <span class="keyword">this</span>.banner);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.bannerMode == Mode.LOG) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> bannerPrinter.print(environment, <span class="keyword">this</span>.mainApplicationClass, logger);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> bannerPrinter.print(environment, <span class="keyword">this</span>.mainApplicationClass, System.<span class="keyword">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="3-2-8-创建Spring上下文"><a href="#3-2-8-创建Spring上下文" class="headerlink" title="3.2.8 创建Spring上下文"></a>3.2.8 创建Spring上下文</h3><p>源码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SERVLET_WEB_CONTEXT_CLASS = <span class="string">"org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_REACTIVE_WEB_CONTEXT_CLASS = <span class="string">"org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CONTEXT_CLASS = <span class="string">"org.springframework.context.annotation.AnnotationConfigApplicationContext"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> ConfigurableApplicationContext createApplicationContext() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 先判断有没有指定的实现类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">Class</span>&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 如果没有，则根据应用类型选择</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//根据webApplicationType的类型去反射创建ConfigurableApplicationContext的具体实例。</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">case</span> SERVLET:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                contextClass = <span class="keyword">Class</span>.forName(DEFAULT_WEB_CONTEXT_CLASS);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">case</span> REACTIVE:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                contextClass = <span class="keyword">Class</span>.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                contextClass = <span class="keyword">Class</span>.forName(DEFAULT_CONTEXT_CLASS);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                    <span class="string">"Unable create a default ApplicationContext, "</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">                            + <span class="string">"please specify an ApplicationContextClass"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">                    ex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 通过反射获取对应类的实例</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>createApplicationContext()该方法的逻辑较为简单，共两个分支：</p>
<ul>
<li>自定义ApplicationContext的实现类</li>
<li>根据当前应用的类型webApplicationType来匹配对应的ApplicationContext，是servlet、reactive或者非web应用</li>
</ul>
<h3 id="3-2-9-准备异常报告器"><a href="#3-2-9-准备异常报告器" class="headerlink" title="3.2.9 准备异常报告器"></a>3.2.9 准备异常报告器</h3><p>这一步的逻辑和实例化初始化器和监听器的一样，都是通过调用 getSpringFactoriesInstances 方法来获取配置的异常类名称并实例化所有的异常处理类。</p>
<h3 id="3-2-10-Spring上下文前置处理"><a href="#3-2-10-Spring上下文前置处理" class="headerlink" title="3.2.10 Spring上下文前置处理"></a>3.2.10 Spring上下文前置处理</h3><p>源码如下：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">private <span class="keyword">void</span> prepareContext(ConfigurableApplicationContext <span class="keyword">context</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        ApplicationArguments applicationArguments, Banner printedBanner) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//设置容器环境，包括各种变量</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">context</span><span class="variable">.setEnvironment</span>(environment);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//设置上下文的 bean 生成器和资源加载器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    postProcessApplicationContext(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//执行容器中的ApplicationContextInitializer（包括 spring.factories和自定义的实例）</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    applyInitializers(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//触发所有 SpringApplicationRunListener 监听器的 contextPrepared 事件方法</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    listeners<span class="variable">.contextPrepared</span>(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//记录启动日志</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span><span class="variable">.logStartupInfo</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        logStartupInfo(<span class="keyword">context</span><span class="variable">.getParent</span>() == <span class="literal">null</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        logStartupProfileInfo(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 添加特定于引导的单例bean</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">context</span><span class="variable">.getBeanFactory</span>()<span class="variable">.registerSingleton</span>(<span class="string">"springApplicationArguments"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            applicationArguments);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (printedBanner != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">context</span><span class="variable">.getBeanFactory</span>()<span class="variable">.registerSingleton</span>(<span class="string">"springBootBanner"</span>, printedBanner);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 加载所有资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    Set&lt;Object&gt; sources = getAllSources();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    Assert<span class="variable">.notEmpty</span>(sources, <span class="string">"Sources must not be empty"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//加载我们的启动类，将启动类注入容器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    load(<span class="keyword">context</span>, sources<span class="variable">.toArray</span>(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//触发所有 SpringApplicationRunListener 监听器的 contextLoaded 事件方法</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    listeners<span class="variable">.contextLoaded</span>(<span class="keyword">context</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这块会对整个上下文进行一个预处理，比如触发监听器的响应事件、加载资源、设置上下文环境等等。</p>
<h3 id="3-2-11-刷新Spring上下文"><a href="#3-2-11-刷新Spring上下文" class="headerlink" title="3.2.11 刷新Spring上下文"></a>3.2.11 刷新Spring上下文</h3><p>源码如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="built_in">ref</span>reshContext(ConfigurableApplicationContext context) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">ref</span>resh(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.registerShutdownHook) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//向JVM运行时注册一个关机钩子，在JVM关机时关闭这个上下文</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            context.registerShutdownHook();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">catch</span> (AccessControlException ex) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">// Not allowed in some environments.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这块主要做了两件事：</p>
<ol>
<li>通过refresh方法对整个IoC容器的初始化（包括Bean资源的定位、解析、注册等等）</li>
<li>通过context.registerShutdownHook()（向JVM运行时注册一个关机钩子，在JVM关机时关闭这个上下文，除非它当时已经关闭。）</li>
</ol>
<h3 id="3-2-12-Spring上下文后置处理"><a href="#3-2-12-Spring上下文后置处理" class="headerlink" title="3.2.12 Spring上下文后置处理"></a>3.2.12 Spring上下文后置处理</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterRefresh</span><span class="params">(ConfigurableApplicationContext context,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">        ApplicationArguments args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>该方法没有实现，可以根据需要做一些定制化的操作。</p>
<h3 id="3-2-13-停止计时监控类"><a href="#3-2-13-停止计时监控类" class="headerlink" title="3.2.13 停止计时监控类"></a>3.2.13 停止计时监控类</h3><p>源码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void stop() throws IllegalStateException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentTaskName == <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> new IllegalStateException(<span class="string">"Can't stop StopWatch: it's not running"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    long lastTime = System.currentTimeMillis() - <span class="keyword">this</span>.startTimeMillis;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.totalTimeMillis += lastTime;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.lastTaskInfo = new TaskInfo(<span class="keyword">this</span>.currentTaskName, lastTime);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.keepTaskList) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.taskList.add(<span class="keyword">this</span>.lastTaskInfo);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    ++<span class="keyword">this</span>.taskCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.currentTaskName = <span class="literal">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>该方法主要是做计时监听器停止操作，并统计一些任务执行信息。</p>
<h3 id="3-2-14-输出日志记录执行主类名、时间信息"><a href="#3-2-14-输出日志记录执行主类名、时间信息" class="headerlink" title="3.2.14 输出日志记录执行主类名、时间信息"></a>3.2.14 输出日志记录执行主类名、时间信息</h3><p>源码如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (this.logStartupInfo) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">new</span> <span class="constructor">StartupInfoLogger(<span class="params">this</span>.<span class="params">mainApplicationClass</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">                    .log<span class="constructor">Started(<span class="params">getApplicationLog</span>()</span>, stopWatch);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>用于打印主类信息和时间信息。</p>
<h3 id="3-2-15-发布应用上下文启动完成事件"><a href="#3-2-15-发布应用上下文启动完成事件" class="headerlink" title="3.2.15 发布应用上下文启动完成事件"></a>3.2.15 发布应用上下文启动完成事件</h3><p>源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">started</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        listener.started(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>执行所有SpringApplicationRunListener实现的started方法。</p>
<h3 id="3-2-16-执行所有-Runner-运行器"><a href="#3-2-16-执行所有-Runner-运行器" class="headerlink" title="3.2.16 执行所有 Runner 运行器"></a>3.2.16 执行所有 Runner 运行器</h3><p>Runner 运行器用于在服务启动时进行一些业务初始化操作，这些操作只在服务启动后执行一次。<br>Spring Boot提供了ApplicationRunner和CommandLineRunner两种服务接口CommandLineRunner、ApplicationRunner<br><strong>对比</strong>：</p>
<ul>
<li>相同点<ul>
<li>两者均在服务启动完成后执行，并且只执行一次。</li>
<li>两者都能获取到应用的命令行参数。</li>
<li>两者在执行时机上是一致的（可以通过Ordered相关的接口或注解来实现自定义执行优先级。）。</li>
</ul>
</li>
<li>不同点<ul>
<li>虽然两者都是获取到应用的命令行参数，但是ApplicationRunner获取到的是封装后的ApplicationArguments对象，而CommandLine获取到的是ApplicationArguments中的sourceArgs属性（List<String>）,即原始参数字符串列表（命令行参数列表）。</li>
</ul>
</li>
</ul>
<p>源码如下：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void call<span class="constructor">Runners(ApplicationContext <span class="params">context</span>, ApplicationArguments <span class="params">args</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    List&lt;Object&gt; runners = <span class="keyword">new</span> ArrayList&lt;&gt;<span class="literal">()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从Spring容器中获取ApplicationRunner实现类        runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从Spring容器中获取CommandLineRunner实现类        runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//排序</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="module-access"><span class="module"><span class="identifier">AnnotationAwareOrderComparator</span>.</span></span>sort(runners);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//回调</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    for (Object runner : <span class="keyword">new</span> LinkedHashSet&lt;&gt;(runners)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (runner instanceof ApplicationRunner) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            call<span class="constructor">Runner((ApplicationRunner)</span> runner, args);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (runner instanceof CommandLineRunner) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            call<span class="constructor">Runner((CommandLineRunner)</span> runner, args);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>ApplicationRunner还是CommandLineRunner，都是在应用启动完成后执行一次业务初始化代码，达到的效果也类似，由于ApplicationRunner的方法参数是ApplicationArguments对象，使用起来更加方便，所以更推荐使用。</p>
<h3 id="3-2-17-发布应用上下文就绪事件"><a href="#3-2-17-发布应用上下文就绪事件" class="headerlink" title="3.2.17 发布应用上下文就绪事件"></a>3.2.17 发布应用上下文就绪事件</h3><p>源码如下</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        listener.<span class="built_in">running</span>(context);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>触发所有 SpringApplicationRunListener 监听器的 running 事件方法。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SpirngBoot启动流程到这里就分析完了、接下来的文章会针对SpringBoot的特定场景进行分析，希望每个看到这篇文章的朋友都能有所收获，同时也欢迎大家多提宝贵意见共同成长。</p>
<blockquote>
<p>作者：模范青蛙</p>
<p>来源：<a href="https://segmentfault.com/a/1190000020359093" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020359093</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/08/Spring-5-%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%8816%EF%BC%89%EF%BC%9ASpring-%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%92%8C%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" rel="prev" title="Spring 5 源码解析（16）：Spring 中的异步和计划任务">
      <i class="fa fa-chevron-left"></i> Spring 5 源码解析（16）：Spring 中的异步和计划任务
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/08/Spring-Boot%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%882%EF%BC%89%EF%BC%9A%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86/" rel="next" title="Spring Boot源码分析（2）：自动配置原理">
      Spring Boot源码分析（2）：自动配置原理 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-简介"><span class="nav-number">1.</span> <span class="nav-text">1.简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-SpringBoot起源"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 SpringBoot起源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-便捷的starter-poms-启动器"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 便捷的starter poms (启动器)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-demo"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-SpringBoot启动流程"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 SpringBoot启动流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-SpringBootApplication注解分析"><span class="nav-number">2.</span> <span class="nav-text">2 @SpringBootApplication注解分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-剖析代码"><span class="nav-number">3.</span> <span class="nav-text">3 剖析代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-实例化SpringApplication对象"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 实例化SpringApplication对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-初始化资源加载器"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 初始化资源加载器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-设置应用上下文初始化器setInitializers"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2 设置应用上下文初始化器setInitializers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-设置监听器-setListeners"><span class="nav-number">3.1.3.</span> <span class="nav-text">3.1.3 设置监听器(setListeners)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-推断应用入口类"><span class="nav-number">3.1.4.</span> <span class="nav-text">3.1.4 推断应用入口类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-run方法"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 run方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-计时监控类"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 计时监控类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-初始化应用上下文和异常报告集合"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 初始化应用上下文和异常报告集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-设置系统属性"><span class="nav-number">3.2.3.</span> <span class="nav-text">3.2.3 设置系统属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-创建所有-Spring-运行监听器并发出开始执行的事件"><span class="nav-number">3.2.4.</span> <span class="nav-text">3.2.4 创建所有 Spring 运行监听器并发出开始执行的事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-5-初始化默认应用参数类"><span class="nav-number">3.2.5.</span> <span class="nav-text">3.2.5 初始化默认应用参数类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-6-根据运行监听器和应用参数来准备-Spring-环境"><span class="nav-number">3.2.6.</span> <span class="nav-text">3.2.6 根据运行监听器和应用参数来准备 Spring 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-7-准备Banner打印器"><span class="nav-number">3.2.7.</span> <span class="nav-text">3.2.7 准备Banner打印器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-8-创建Spring上下文"><span class="nav-number">3.2.8.</span> <span class="nav-text">3.2.8 创建Spring上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-9-准备异常报告器"><span class="nav-number">3.2.9.</span> <span class="nav-text">3.2.9 准备异常报告器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-10-Spring上下文前置处理"><span class="nav-number">3.2.10.</span> <span class="nav-text">3.2.10 Spring上下文前置处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-11-刷新Spring上下文"><span class="nav-number">3.2.11.</span> <span class="nav-text">3.2.11 刷新Spring上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-12-Spring上下文后置处理"><span class="nav-number">3.2.12.</span> <span class="nav-text">3.2.12 Spring上下文后置处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-13-停止计时监控类"><span class="nav-number">3.2.13.</span> <span class="nav-text">3.2.13 停止计时监控类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-14-输出日志记录执行主类名、时间信息"><span class="nav-number">3.2.14.</span> <span class="nav-text">3.2.14 输出日志记录执行主类名、时间信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-15-发布应用上下文启动完成事件"><span class="nav-number">3.2.15.</span> <span class="nav-text">3.2.15 发布应用上下文启动完成事件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-16-执行所有-Runner-运行器"><span class="nav-number">3.2.16.</span> <span class="nav-text">3.2.16 执行所有 Runner 运行器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-17-发布应用上下文就绪事件"><span class="nav-number">3.2.17.</span> <span class="nav-text">3.2.17 发布应用上下文就绪事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

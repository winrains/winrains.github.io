<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="判断一个网站值不值钱的一个重要标准就是看pv&#x2F;uv，那么你知道pv,uv是怎么统计的么？当然现在有第三方做的比较完善的可以直接使用，但如果让我们自己来实现这么一个功能，应该怎么做呢？本篇内容较长，源码如右 ➡️ https:&#x2F;&#x2F;github.com&#x2F;liuyueyi&#x2F;spring-boot-demo&#x2F;tree&#x2F;master&#x2F;spring-case&#x2F;124-redis-sitecount">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot 应用篇--Redis（2）：搭建一个简单站点统计服务">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;08&#x2F;Spring-Boot-%E5%BA%94%E7%94%A8%E7%AF%87-Redis%EF%BC%882%EF%BC%89%EF%BC%9A%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1%E6%9C%8D%E5%8A%A1&#x2F;index.html">
<meta property="og:site_name" content="congsheng的博客">
<meta property="og:description" content="判断一个网站值不值钱的一个重要标准就是看pv&#x2F;uv，那么你知道pv,uv是怎么统计的么？当然现在有第三方做的比较完善的可以直接使用，但如果让我们自己来实现这么一个功能，应该怎么做呢？本篇内容较长，源码如右 ➡️ https:&#x2F;&#x2F;github.com&#x2F;liuyueyi&#x2F;spring-boot-demo&#x2F;tree&#x2F;master&#x2F;spring-case&#x2F;124-redis-sitecount">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;d0671-00.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;5d99f-01.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;85f48-02.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;da4b9-03.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;a477d-04.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;1e325-05.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;c7405-06.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;3cd31-07.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;271af-08.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;ac992-09.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;ebce7-10.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;a9e87-11.jpg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;ae10c-12.jpg">
<meta property="og:updated_time" content="2020-01-08T09:11:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;d0671-00.jpg">

<link rel="canonical" href="http://congsheng.wang/2020/01/08/Spring-Boot-%E5%BA%94%E7%94%A8%E7%AF%87-Redis%EF%BC%882%EF%BC%89%EF%BC%9A%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1%E6%9C%8D%E5%8A%A1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Spring Boot 应用篇--Redis（2）：搭建一个简单站点统计服务 | congsheng的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">congsheng的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问：winrains.cn</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/08/Spring-Boot-%E5%BA%94%E7%94%A8%E7%AF%87-Redis%EF%BC%882%EF%BC%89%EF%BC%9A%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1%E6%9C%8D%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="congsheng的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Boot 应用篇--Redis（2）：搭建一个简单站点统计服务
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 17:11:26" itemprop="dateCreated datePublished" datetime="2020-01-08T17:11:26+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Spring技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Java技术</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Spring%E6%8A%80%E6%9C%AF/Spring-Boot/" itemprop="url" rel="index">
                    <span itemprop="name">Spring Boot</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>判断一个网站值不值钱的一个重要标准就是看pv/uv，那么你知道pv,uv是怎么统计的么？当然现在有第三方做的比较完善的可以直接使用，但如果让我们自己来实现这么一个功能，应该怎么做呢？<br>本篇内容较长，源码如右 ➡️ <a href="https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-case/124-redis-sitecount" target="_blank" rel="noopener">https://github.com/liuyueyi/spring-boot-demo/tree/master/spring-case/124-redis-sitecount</a></p>
<a id="more"></a>

<h2 id="I-背景及需求"><a href="#I-背景及需求" class="headerlink" title="I. 背景及需求"></a>I. 背景及需求</h2><p>为了看看我的博客是不是我一个人的单机游戏，所以就想着统计一下总的访问量，每日的访问人数，哪些博文又是大家感兴趣的，点击得多的；<br>因此就萌发了自己撸一个pv/uv统计的服务，当然我这个也不需要特别完善高大上，能满足我自己的基本需要就可以了</p>
<ul>
<li>希望统计站点(域名）总访问次数</li>
<li>希望统计站点总的访问人数，当前访问者在访问人数中的排名（即这个ip是所有访问ip中的第多少位访问的这个站点）</li>
<li>每个子页面都有访问次数，访问总人数，当前ip访问的排名统计</li>
<li>同一个ip，同一天内访问同一个子页面，pv次数只加1次；隔天之后，再次访问pv+1</li>
</ul>
<h2 id="II-方案设计"><a href="#II-方案设计" class="headerlink" title="II. 方案设计"></a>II. 方案设计</h2><p>前面的背景和需求，可以说大致说明了我们要做个什么东西，以及需要注意哪些事项，再进行方案设计的过程中，则需要对需求进行详细拆解</p>
<h3 id="1-术语说明"><a href="#1-术语说明" class="headerlink" title="1. 术语说明"></a>1. 术语说明</h3><p>前面提到了pv,uv，在我们的实际实现中，会发现这个服务中对于pv,uv的定义和标准定义并不是完全一致的，下面进行说明</p>
<h4 id="a-pv"><a href="#a-pv" class="headerlink" title="a. pv"></a>a. pv</h4><p><code>page viste</code>, 每个页面的访问次数，在本服务中，我们的pv指的是总量，即从开始接入时，到现在总的访问次数<br>但是这里有个限制： <strong>一个合法的ip，一天之内pv统计次数只能+1次</strong></p>
<ul>
<li>根据ip进行区分，因此需要获取访问者ip</li>
<li>同一天内，这个ip访问相同的URI，只能算一次有效pv；第二天之后，再次访问，则可以再算一次有效pv</li>
</ul>
<h4 id="b-hot"><a href="#b-hot" class="headerlink" title="b. hot"></a>b. hot</h4><p>前面的pv针对ip进行了限制，一个ip同一天的访问，只能计算一次，大部分情况下这种统计并没有什么问题，但是如果一个文章写得特别有参考意义，导致有人重复的看，仔细的看，换着花样的刷新看，这个时候统计下总的访问次数是不是也挺好的<br>因此在这个服务中，引入了hot（热度）的概念，对于一个uri而言，只要一次点击，hot+1</p>
<h4 id="c-uv"><a href="#c-uv" class="headerlink" title="c. uv"></a>c. uv</h4><p><code>unique visitor</code>, 这个就是统计URI的访问ip数</p>
<h3 id="2-流程图"><a href="#2-流程图" class="headerlink" title="2. 流程图"></a>2. 流程图</h3><p>通过前面三个术语的定义，我们的操作流程就相对清晰了，我们的服务接收一个IP和URI，然后操作对应的pv,uv,hot并返回</p>
<ul>
<li>首先判断这个ip是否为第一次访问这个URI</li>
<li>是，则pv+1, uv+1, hot+1</li>
<li>否，表示之前访问过，uv就不能变了<ul>
<li>判断是否今天第一次访问</li>
<li>是，今天访问过，那么pv不变，hot+1</li>
<li>否，之前访问过，今天没有，pv可以+1， hot+1</li>
</ul>
</li>
</ul>
<p>对应的流程图如下<br><a href="http://image.winrains.cn/2019/11/d0671-00.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/d0671-00.jpg" alt="流程图"></a><br>流程图</p>
<h3 id="3-数据结构"><a href="#3-数据结构" class="headerlink" title="3. 数据结构"></a>3. 数据结构</h3><p>流程清晰之后，接下来就需要看下pv,uv,hot三个数据怎么存了</p>
<h4 id="a-pv-1"><a href="#a-pv-1" class="headerlink" title="a. pv"></a>a. pv</h4><p>pv保存的就是访问次数，与ip无关，所以kv存储就可以满足我们的需求了，这里的key为uri，value则保存pv的值</p>
<h4 id="b-hot-1"><a href="#b-hot-1" class="headerlink" title="b. hot"></a>b. hot</h4><p>hot和pv类似，同样用kv可以满足要求</p>
<h4 id="c-uv-1"><a href="#c-uv-1" class="headerlink" title="c. uv"></a>c. uv</h4><p>uv这里有两个数据，一个是uv总数，要给是这个ip的访问排名，redis中有个zset数据结构正好就可以做这个<br>zset数据结构中，我们定义value为ip，score为ip的排名，那么uv就是最大的score了</p>
<h4 id="d-结构图"><a href="#d-结构图" class="headerlink" title="d. 结构图"></a>d. 结构图</h4><p><a href="http://image.winrains.cn/2019/11/5d99f-01.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/5d99f-01.jpg" alt="流程图"></a><br>流程图</p>
<h3 id="4-方案设计"><a href="#4-方案设计" class="headerlink" title="4. 方案设计"></a>4. 方案设计</h3><p>流程清晰，结构设计出来之后，就可以进入具体的方案设计环节了，在这个环节中，我们引入一个app的维度，这样我们的服务就可以通用了；<br>每个使用者都申请一个app，那么这个使用者的请求的所有站点统计数据，都关联到这个app上，这样也有利于后续统计了</p>
<h4 id="a-接口API"><a href="#a-接口API" class="headerlink" title="a. 接口API"></a>a. 接口API</h4><p>引入了app之后，结合前面的两个参数ip + URI，我们的请求参数就清晰了</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@Data</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisitReqDTO</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 应用区分</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> app;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 访问者ip</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> ip;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 访问的URI</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> uri;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>然后我们返回的数据，pv + uv + rank + hot，所以返回的基础VO如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Created by <span class="doctag">@author</span> yihui in 16:19 19/5/12.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@AllArgsConstructor</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisitVO</span> <span class="title">implements</span> <span class="title">Serializable</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * pv，与传统的有点区别，这里表示这个url的总访问次数；每个ip，一天次数只+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="built_in">Long</span> pv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * uv 页面总的ip访问数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="built_in">Long</span> uv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 当前ip，第一次访问本url的排名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="built_in">Long</span> rank;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 热度，每次访问计数都+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="built_in">Long</span> hot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> VisitVO() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> VisitVO(VisitVO visitVO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.pv = visitVO.pv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.uv = visitVO.uv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.rank = visitVO.rank;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.hot = visitVO.hot;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>此外需要注意一点的是，发起一个子页面的请求时，这个时候我们基于域名的站点总数统计也应该被触发（简单来说，访问<code>http://spring.hhui.top/spring-blog/</code>时，不仅这个uri的统计需要更新， <code>spring.hhui.top</code>这个域名的pv,uv,hot也需要随之统计）<br>因此我们最终的返回对象应该是</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@NoArgsConstructor</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@AllArgsConstructor</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">public class SiteVisitDTO &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 站点访问统计</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">VisitVO</span> <span class="selector-tag">siteVO</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * 页面访问统计</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">VisitVO</span> <span class="selector-tag">uriVO</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>有输出，又返回，那么访问api就简单了</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SiteVisitDTO visit(<span class="name">VisitReqDTO</span> reqDTO)<span class="comment">;</span></span></pre></td></tr></table></figure>

<h4 id="b-hot相关api"><a href="#b-hot相关api" class="headerlink" title="b. hot相关api"></a>b. hot相关api</h4><p>hot数据结构为hash，每次请求过来，都是次数+1，因此直接使用redis的 <code>hIncrBy</code>，实现计数+1，并返回最终的计数</p>
<ul>
<li>key: <code>&quot;hot_cnt_&quot; + app</code> 作为hash的key</li>
<li>field: 使用URI作为hash的field</li>
<li>value: 保存具体的hot，整型</li>
</ul>
<p><a href="http://image.winrains.cn/2019/11/85f48-02.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/85f48-02.jpg" alt="hot api"></a><br>hot api</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>应用的热度统计计数</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param app</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">private <span class="built_in">String</span> buildHotKey(<span class="built_in">String</span> app) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="string">"hot_cnt_"</span> + app;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>热度，每访问一次，计数都+1</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param key</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param uri</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">public Long addHot(<span class="built_in">String</span> key, <span class="built_in">String</span> uri);</span></pre></td></tr></table></figure>

<h4 id="c-pv相关api"><a href="#c-pv相关api" class="headerlink" title="c. pv相关api"></a>c. pv相关api</h4><p>pv与hot不一样的是并不是每次都需要计数+1，所以它需要有一个查询pv的接口，和一个计数+1的接口</p>
<ul>
<li>key: <code>&quot;site_cnt_&quot; + app</code> 作为hash的key</li>
<li>field: 使用URI作为hash的field</li>
<li>value: 保存具体的pv，整型</li>
</ul>
<p><a href="http://image.winrains.cn/2019/11/da4b9-03.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/da4b9-03.jpg" alt="pv api"></a><br>pv api</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>应用的pv统计计数</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param app</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">private <span class="built_in">String</span> buildPvKey(<span class="built_in">String</span> app) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="string">"site_cnt_"</span> + app;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>获取pv</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>pv存储结果为hash，一个应用一个key; field 为uri； value为pv</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return null表示首次有人访问；这个时候需要+1</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">public Long getPv(<span class="built_in">String</span> key, <span class="built_in">String</span> uri);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>pv 次数+1</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param key</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param uri</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> addPv(<span class="built_in">String</span> key, <span class="built_in">String</span> uri)</span></pre></td></tr></table></figure>

<h4 id="d-uv相关api"><a href="#d-uv相关api" class="headerlink" title="d. uv相关api"></a>d. uv相关api</h4><p>前面说到uv采用的是zset数据结构，其中ip作为value，排名作为score；所以uv就是最大的score</p>
<ul>
<li>key: 根据app和uri来确定uv的key</li>
<li>value: 存储访问者ip（ipv4格式的）</li>
<li>score: 排名，整型</li>
</ul>
<p><a href="http://image.winrains.cn/2019/11/a477d-04.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/a477d-04.jpg" alt="uv api"></a><br>uv api<br>因为uv需要返回两个结构，所以我们的返回需要注意</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>app+uri 对应的uv</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param app</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param uri</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">private <span class="built_in">String</span> buildUvKey(<span class="built_in">String</span> app, <span class="built_in">String</span> uri) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="string">"uri_rank_"</span> + app + <span class="string">"_"</span> + uri;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>获取uri对应的uv，以及当前访问ip的历史访问排名</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>使用zset来存储，key为uri唯一标识；value为ip；score为访问的排名</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param key : 由app与URI来生成，即一个uri维护一个uv集</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param ip: 访问者ip</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@return 返回uv/rank, 如果对应的值为0，表示没有访问过</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">public ImmutablePair&lt;<span class="comment"><span class="markdown">/<span class="emphasis">** uv *</span>/</span></span>Long, <span class="comment"><span class="markdown">/<span class="emphasis">** rank *</span>/</span></span>Long&gt; getUv(<span class="built_in">String</span> key, <span class="built_in">String</span> ip)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>uv +1</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> *</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param key</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param ip</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"><span class="bullet"> * </span>@param rank</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown"> */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">public <span class="keyword">void</span> addUv(<span class="built_in">String</span> key, <span class="built_in">String</span> ip, Long rank)</span></pre></td></tr></table></figure>

<h4 id="e-今日是否访问"><a href="#e-今日是否访问" class="headerlink" title="e. 今日是否访问"></a>e. 今日是否访问</h4><p>前面的都还算比较简单，接下来有个非常有意思的地方了，如何判断这个ip，今天访问没访问？<br><strong>方案一</strong><br>要实现这个功能，一个自然而然的想法就出来了，直接kv就行了</p>
<ul>
<li>key: <code>uri_年月日_ip</code></li>
<li>value: 1</li>
</ul>
<p>如果value存在，表示今天访问过，如果不存在，则没有访问过<br><strong>方案二</strong><br>前面那个倒是没啥问题，如果我希望统计今天某个uri的ip访问数，上面的就不太好处理，很容易想到用hash来替换</p>
<ul>
<li>key: <code>uri_年月日</code></li>
<li>field: <code>ip</code></li>
<li>value: 1</li>
</ul>
<p>同样value存在，则表示今天访问过；否则没有访问过<br>如果需要统计今天访问的总数，hlen一把就可以；还可以获取今天所有访问过的ip<br><strong>方案三</strong><br>前面的方案看似挺好的，但是有个缺陷，如果我这个站点特别火，每天几百万的uv，这个存储量就有点夸张了</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># 简单的算一下 <span class="number">10</span>w uv的存储开销</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">field: ip   # 一个ip(<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span>) 字符串存储算 <span class="number">16</span>B；</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">value: <span class="number">1</span>  # 算 <span class="number">1</span>B</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>w uv = <span class="number">10</span>w * <span class="number">17</span>B = <span class="number">1.7</span>MB</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"># 假设这个站点有<span class="number">100</span>个<span class="number">10</span>w uv的子页面，每天存储需要 <span class="number">170</span>MB</span></pre></td></tr></table></figure>

<p>通过上面简单的计算可以看出这存储开销对于比较火的站点而言，有点吓人；然后可以找其他的存储方式了，所以bitmap可以隆重登场了<br><a href="http://image.winrains.cn/2019/11/1e325-05.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/1e325-05.jpg" alt="bitmap"></a><br>bitmap<br>我们将位数组分成四节，分别于ip的四段对应，因为ipv4每一段取值是(0-2^8)，所以我们的位数组，也只需要(4 * 8b = 4B)，相比较前面的方案来说，存储空间大大减少<br>看到上面这个结构，会有一个疑问，为什么分成四节？将ip转成整形，作为下标，一个就可以了</p>
<ul>
<li>答：将ip转为整型，取值将是 (0 - 2^32)，需要的bitmap空间为<code>4Gb</code>，显然不如上面优雅</li>
</ul>
<hr>
<p><strong>方案确定</strong><br>上面三个方案中，我们选择了第三个，对应的api设计也比较简单了</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取今天的日期，格式为 20190512</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> getToday() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    LocalDate date = LocalDate.now();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">int</span> <span class="built_in">year</span> = date.getYear();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">int</span> <span class="built_in">month</span> = date.getMonthValue();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">int</span> <span class="built_in">day</span> = date.getDayOfMonth();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">8</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> buf.<span class="built_in">append</span>(<span class="built_in">year</span>).<span class="built_in">append</span>(<span class="built_in">month</span> &lt; <span class="number">10</span> ? <span class="string">"0"</span> : <span class="string">""</span>).<span class="built_in">append</span>(<span class="built_in">month</span>).<span class="built_in">append</span>(<span class="built_in">day</span> &lt; <span class="number">10</span> ? <span class="string">"0"</span> : <span class="string">""</span>).<span class="built_in">append</span>(<span class="built_in">day</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            .toString();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 每日访问统计</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param app</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param uri</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> buildUriTagKey(<span class="keyword">String</span> app, <span class="keyword">String</span> uri) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="string">"uri_tag_"</span> + DateUtil.getToday() + <span class="string">"_"</span> + app + <span class="string">"_"</span> + uri;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 标记ip访问过这个key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param ip</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> tagVisit(<span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">String</span> ip)</span></pre></td></tr></table></figure>

<h2 id="III-服务实现"><a href="#III-服务实现" class="headerlink" title="III. 服务实现"></a>III. 服务实现</h2><p>前面接口设计出来，按照既定思路实现就属于比较轻松的环节了</p>
<h4 id="1-pv接口实现"><a href="#1-pv接口实现" class="headerlink" title="1. pv接口实现"></a>1. pv接口实现</h4><p>pv两个接口，一个访问，一个计数+1，都可以直接使用redisTemplate的基础操作完成</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 获取pv</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * pv存储结果为hash，一个应用一个key; field 为uri； value为pv</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @return null表示首次有人访问；这个时候需要+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Long getPv(<span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">String</span> uri) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Long&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Long doInRedis(RedisConnection connection) <span class="keyword">throws</span> DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">byte</span>[] ans = connection.hGet(<span class="built_in">key</span>.getBytes(), uri.getBytes());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (ans == <span class="keyword">null</span> || ans.length == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> Long.parseLong(<span class="keyword">new</span> <span class="keyword">String</span>(ans));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * pv 次数+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param uri</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> addPv(<span class="keyword">String</span> <span class="built_in">key</span>, <span class="keyword">String</span> uri) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Void&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> Void doInRedis(RedisConnection connection) <span class="keyword">throws</span> DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            connection.hIncrBy(<span class="built_in">key</span>.getBytes(), uri.getBytes(), <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="2-hot接口实现"><a href="#2-hot接口实现" class="headerlink" title="2. hot接口实现"></a>2. hot接口实现</h3><p>只有一个计数+1的接口</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 热度，每访问一次，计数都+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> uri</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Long <span class="title">addHot</span><span class="params">(String key, String uri)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">return</span> redisTemplate.<span class="title">execute</span><span class="params">(<span class="keyword">new</span> RedisCallback&lt;Long&gt;()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="function">Long <span class="title">doInRedis</span><span class="params">(RedisConnection connection)</span> <span class="keyword">throws</span> DataAccessException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> connection.hIncrBy(key.getBytes(), uri.getBytes(), <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="3-uv接口实现"><a href="#3-uv接口实现" class="headerlink" title="3. uv接口实现"></a>3. uv接口实现</h3><p>uv的获取会麻烦一点，首先获取uv值，然后获取ip对应的排名；如果uv为0，排名也就不需要再获取了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 获取uri对应的uv，以及当前访问ip的历史访问排名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 使用zset来存储，key为uri唯一标识；value为ip；score为访问的排名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> key : 由app与URI来生成，即一个uri维护一个uv集</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> ip: 访问者ip</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回uv/rank, 如果对应的值为0，表示没有访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ImmutablePair&lt;<span class="comment">/** uv */</span><span class="built_in">Long</span>, <span class="comment">/** rank */</span><span class="built_in">Long</span>&gt; getUv(String key, String ip) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取总uv数，也就是最大的score</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Long</span> uv = redisTemplate.execute(new RedisCallback&lt;<span class="built_in">Long</span>&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="built_in">Long</span> doInRedis(RedisConnection connection) throws DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            Set&lt;RedisZSetCommands.Tuple&gt; <span class="keyword">set</span> = connection.zRangeWithScores(key.getBytes(), -<span class="number">1</span>, -<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (CollectionUtils.isEmpty(<span class="keyword">set</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">return</span> <span class="number">0L</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">Double</span> score = <span class="keyword">set</span>.stream().findFirst().<span class="keyword">get</span>().getScore();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> score.longValue();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (uv == <span class="literal">null</span> || uv == <span class="number">0L</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 表示还没有人访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ImmutablePair.of(<span class="number">0L</span>, <span class="number">0L</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取ip对应的访问排名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">Long</span> rank = redisTemplate.execute(new RedisCallback&lt;<span class="built_in">Long</span>&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="built_in">Long</span> doInRedis(RedisConnection connection) throws DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">Double</span> score = connection.zScore(key.getBytes(), ip.getBytes());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> score == <span class="literal">null</span> ? <span class="number">0L</span> : score.longValue();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ImmutablePair.of(uv, rank);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * uv +1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> ip</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * <span class="doctag">@param</span> rank</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void addUv(String key, String ip, <span class="built_in">Long</span> rank) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    redisTemplate.execute(new RedisCallback&lt;<span class="built_in">Void</span>&gt;() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="built_in">Void</span> doInRedis(RedisConnection connection) throws DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">            connection.zAdd(key.getBytes(), rank, ip.getBytes());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="4-今天是否访问过"><a href="#4-今天是否访问过" class="headerlink" title="4. 今天是否访问过"></a>4. 今天是否访问过</h3><p>前面选择位数组方式来记录是否访问过，这里的实现选择了简单的实现方式，利用四个bitmap来分别对应ip的四段；（实际上一个也可以实现，可以想一想应该怎么做）</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 判断ip今天是否访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 采用bitset来判断ip是否有访问，key由app与uri唯一确定</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @return true 表示今天访问过/ false 表示今天没有访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">public boolean visit<span class="constructor">Today(String <span class="params">key</span>, String <span class="params">ip</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// ip地址进行分段 127.0.0.1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    String<span class="literal">[]</span> segments = <span class="module-access"><span class="module"><span class="identifier">StringUtils</span>.</span></span>split(ip, <span class="string">"."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    for (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; segments.length; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!contain(key + <span class="string">"_"</span> + i, <span class="module-access"><span class="module"><span class="identifier">Integer</span>.</span></span>value<span class="constructor">Of(<span class="params">segments</span>[<span class="params">i</span>])</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            return <span class="literal">false</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    return <span class="literal">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> boolean contain(String key, Integer <span class="keyword">val</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    return redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Boolean&gt;<span class="literal">()</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        public Boolean <span class="keyword">do</span><span class="constructor">InRedis(RedisConnection <span class="params">connection</span>)</span> throws DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            return connection.get<span class="constructor">Bit(<span class="params">key</span>.<span class="params">getBytes</span>()</span>, <span class="keyword">val</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * 标记ip访问过这个key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param key</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param ip</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">public void tag<span class="constructor">Visit(String <span class="params">key</span>, String <span class="params">ip</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    String<span class="literal">[]</span> segments = <span class="module-access"><span class="module"><span class="identifier">StringUtils</span>.</span></span>split(ip, <span class="string">"."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    for (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; segments.length; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">int</span> finalI = i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        redisTemplate.execute(<span class="keyword">new</span> RedisCallback&lt;Void&gt;<span class="literal">()</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">            public Void <span class="keyword">do</span><span class="constructor">InRedis(RedisConnection <span class="params">connection</span>)</span> throws DataAccessException &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                connection.set<span class="constructor">Bit((<span class="params">key</span> + <span class="string">"_"</span> + <span class="params">finalI</span>)</span>.get<span class="constructor">Bytes()</span>, <span class="module-access"><span class="module"><span class="identifier">Integer</span>.</span></span>value<span class="constructor">Of(<span class="params">segments</span>[<span class="params">finalI</span>])</span>, <span class="literal">true</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                return null;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        &#125;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h3 id="4-api接口实现"><a href="#4-api接口实现" class="headerlink" title="4. api接口实现"></a>4. api接口实现</h3><p>前面基本的接口实现之后，api就是流程图的翻译了，也没有什么特别值得说到的地方，唯一需要注意的就是URI的解析，域名作为站点；uri由path + segment构成</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public static ImmutablePair&lt;<span class="comment">/**host*/</span>String, <span class="comment">/**uri*/</span>String&gt; foramt<span class="constructor">Uri(String <span class="params">uri</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    URI u = <span class="module-access"><span class="module"><span class="identifier">URI</span>.</span></span>create(uri);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    String host = u.get<span class="constructor">Host()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (u.get<span class="constructor">Port()</span> &gt; <span class="number">0</span><span class="operator"> &amp;&amp; </span>u.get<span class="constructor">Port()</span> != <span class="number">80</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        host = host + <span class="string">":80"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    String baseUri = u.get<span class="constructor">Path()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (u.get<span class="constructor">Fragment()</span> != null) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        baseUri = baseUri + <span class="string">"#"</span> + u.get<span class="constructor">Fragment()</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="module-access"><span class="module"><span class="identifier">StringUtils</span>.</span></span>is<span class="constructor">NotBlank(<span class="params">baseUri</span>)</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        baseUri = host + baseUri;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        baseUri = host;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    return <span class="module-access"><span class="module"><span class="identifier">ImmutablePair</span>.</span></span><span class="keyword">of</span>(host, baseUri);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * uri 访问统计</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @param reqDTO</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * @return</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">public SiteVisitDTO visit(VisitReqDTO reqDTO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    ImmutablePair&lt;String, String&gt; uri = <span class="module-access"><span class="module"><span class="identifier">URIUtil</span>.</span></span>foramt<span class="constructor">Uri(<span class="params">reqDTO</span>.<span class="params">getUri</span>()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取站点的访问记录</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    VisitVO uriVisit = <span class="keyword">do</span><span class="constructor">Visit(<span class="params">reqDTO</span>.<span class="params">getApp</span>()</span>, uri.get<span class="constructor">Right()</span>, reqDTO.get<span class="constructor">Ip()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    VisitVO siteVisit;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (uri.get<span class="constructor">Left()</span>.equals(uri.get<span class="constructor">Right()</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        siteVisit = <span class="keyword">new</span> <span class="constructor">VisitVO(<span class="params">uriVisit</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        siteVisit = <span class="keyword">do</span><span class="constructor">Visit(<span class="params">reqDTO</span>.<span class="params">getApp</span>()</span>, uri.get<span class="constructor">Left()</span>, reqDTO.get<span class="constructor">Ip()</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    return <span class="keyword">new</span> <span class="constructor">SiteVisitDTO(<span class="params">siteVisit</span>, <span class="params">uriVisit</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> VisitVO <span class="keyword">do</span><span class="constructor">Visit(String <span class="params">app</span>, String <span class="params">uri</span>, String <span class="params">ip</span>)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    String pvKey = build<span class="constructor">PvKey(<span class="params">app</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    String hotKey = build<span class="constructor">HotKey(<span class="params">app</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    String uvKey = build<span class="constructor">UvKey(<span class="params">app</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    String todayVisitKey = build<span class="constructor">UriTagKey(<span class="params">app</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    Long hot = visitService.add<span class="constructor">Hot(<span class="params">hotKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取pv数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    Long pv = visitService.get<span class="constructor">Pv(<span class="params">pvKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pv<span class="operator"> == </span>null<span class="operator"> || </span>pv<span class="operator"> == </span><span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 历史没有访问过，则pv + 1, uv +1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Pv(<span class="params">pvKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Uv(<span class="params">uvKey</span>, <span class="params">ip</span>, 1L)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">        visitService.tag<span class="constructor">Visit(<span class="params">todayVisitKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">VisitVO(1L, 1L, 1L, <span class="params">hot</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 判断ip今天是否访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    boolean visit = visitService.visit<span class="constructor">Today(<span class="params">todayVisitKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 获取uv及排名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">    ImmutablePair&lt;<span class="comment">/**uv*/</span>Long, <span class="comment">/**rank*/</span>Long&gt; uv = visitService.get<span class="constructor">Uv(<span class="params">uvKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (visit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 今天访问过，则不需要修改pv/uv；可以直接返回所需数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">VisitVO(<span class="params">pv</span>, <span class="params">uv</span>.<span class="params">getLeft</span>()</span>, uv.get<span class="constructor">Right()</span>, hot);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 今天没访问过</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (uv.left<span class="operator"> == </span><span class="number">0L</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 首次有人访问, pv + 1; uv +1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Pv(<span class="params">pvKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Uv(<span class="params">uvKey</span>, <span class="params">ip</span>, 1L)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">        visitService.tag<span class="constructor">Visit(<span class="params">todayVisitKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">VisitVO(<span class="params">pv</span> + 1, 1L, 1L, <span class="params">hot</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uv.right<span class="operator"> == </span><span class="number">0L</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 这个ip首次访问, pv +1; uv + 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Pv(<span class="params">pvKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Uv(<span class="params">uvKey</span>, <span class="params">ip</span>, <span class="params">uv</span>.<span class="params">left</span> + 1)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">        visitService.tag<span class="constructor">Visit(<span class="params">todayVisitKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">VisitVO(<span class="params">pv</span> + 1, <span class="params">uv</span>.<span class="params">left</span> + 1, <span class="params">uv</span>.<span class="params">left</span> + 1, <span class="params">hot</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 这个ip的今天第一次访问， pv + 1 ; uv 不变</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">        visitService.add<span class="constructor">Pv(<span class="params">pvKey</span>, <span class="params">uri</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">        visitService.tag<span class="constructor">Visit(<span class="params">todayVisitKey</span>, <span class="params">ip</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">        return <span class="keyword">new</span> <span class="constructor">VisitVO(<span class="params">pv</span> + 1, <span class="params">uv</span>.<span class="params">left</span>, <span class="params">uv</span>.<span class="params">right</span>, <span class="params">hot</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h2 id="IV-测试与小结"><a href="#IV-测试与小结" class="headerlink" title="IV. 测试与小结"></a>IV. 测试与小结</h2><h3 id="1-测试"><a href="#1-测试" class="headerlink" title="1. 测试"></a>1. 测试</h3><p>搭建一个简单的web服务，开始测试</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> * Created by @author yihui in 18:58 19/5/12.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="variable">@Controller</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">public class VisitController &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="variable">@Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    private SiteVisitFacade siteVisitFacade;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="variable">@RequestMapping</span>(path = <span class="string">"visit"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="variable">@ResponseBody</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    public SiteVisitDTO visit(VisitReqDTO reqDTO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">siteVisitFacade</span><span class="selector-class">.visit</span>(reqDTO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<h4 id="a-首次访问"><a href="#a-首次访问" class="headerlink" title="a. 首次访问"></a>a. 首次访问</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首次访问，返回的全是1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/visit?app=demo&amp;ip=192.168.0.1&amp;uri=http:/</span><span class="regexp">/hhui.top/</span>home</span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/c7405-06.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/c7405-06.jpg" alt="test a"></a><br>test a</p>
<h4 id="b-再次访问"><a href="#b-再次访问" class="headerlink" title="b. 再次访问"></a>b. 再次访问</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 再次访问，因为同样是今天访问，除了hot为2；其他的都是1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/visit?app=demo&amp;ip=192.168.0.1&amp;uri=http:/</span><span class="regexp">/hhui.top/</span>home</span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/3cd31-07.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/3cd31-07.jpg" alt="test b"></a><br>test b</p>
<h4 id="c-同ip，不同URI"><a href="#c-同ip，不同URI" class="headerlink" title="c. 同ip，不同URI"></a>c. 同ip，不同URI</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同一ip，换个uri；除站点返回hot为3，其他的全是1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/visit?app=demo&amp;ip=192.168.0.1&amp;uri=http:/</span><span class="regexp">/hhui.top/i</span>ndex</span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/271af-08.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/271af-08.jpg" alt="test c"></a><br>test c</p>
<h4 id="d-不同ip，接上一个URI"><a href="#d-不同ip，接上一个URI" class="headerlink" title="d. 不同ip，接上一个URI"></a>d. 不同ip，接上一个URI</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># 换个ip，这个uri；主站点hot=<span class="number">4</span>, pv,uv,rank=<span class="number">2</span>; uriVO全是<span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/visit?app=demo&amp;ip=192.168.0.2&amp;uri=http://hhui.top/index</span></span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/ac992-09.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/ac992-09.jpg" alt="test d"></a><br>test d</p>
<h4 id="e-上一个ip，换第一个uri"><a href="#e-上一个ip，换第一个uri" class="headerlink" title="e. 上一个ip，换第一个uri"></a>e. 上一个ip，换第一个uri</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># 换个ip，这个uri；主站点hot=<span class="number">5</span>, pv,uv,rank=<span class="number">2</span>; uriVO hot为<span class="number">3</span>，其他全是<span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/visit?app=demo&amp;ip=192.168.0.2&amp;uri=http://hhui.top/home</span></span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/ebce7-10.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/ebce7-10.jpg" alt="test e"></a><br>test e</p>
<h4 id="f-第二天访问"><a href="#f-第二天访问" class="headerlink" title="f. 第二天访问"></a>f. 第二天访问</h4><p>真要第二天操作有点麻烦，为了验证，直接干掉今天的占位标记<br><a href="http://image.winrains.cn/2019/11/a9e87-11.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/a9e87-11.jpg" alt="rest"></a><br>rest</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模拟第二天访问， pv + 1， uv不变， hot+1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/visit?app=demo&amp;ip=192.168.0.2&amp;uri=http:/</span><span class="regexp">/hhui.top/</span>home</span></pre></td></tr></table></figure>

<p><a href="http://image.winrains.cn/2019/11/ae10c-12.jpg" target="_blank" rel="noopener"><img src="http://image.winrains.cn/2019/11/ae10c-12.jpg" alt="test f"></a><br>test f</p>
<h3 id="2-小结"><a href="#2-小结" class="headerlink" title="2. 小结"></a>2. 小结</h3><p>本文可以说是redis学习之后，一个挺好的应用场景，涉及到了我们常用和不常用的几个数据结构，包括hash,zset,bitmap, 其中关于bitmap的使用个人感觉还是非常有意思的；<br>对于redis操作不太熟的，可以参考下前面几篇博文</p>
<ul>
<li><a href="http://spring.hhui.top/spring-blog/2018/10/29/181029-SpringBoot高级篇Redis之基本配置/" target="_blank" rel="noopener">181029-SpringBoot高级篇Redis之基本配置</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/11/01/181101-SpringBoot高级篇Redis之Jedis配置/" target="_blank" rel="noopener">181101-SpringBoot高级篇Redis之Jedis配置</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/11/08/181108-SpringBoot高级篇Redis之String数据结构的读写/" target="_blank" rel="noopener">181108-SpringBoot高级篇Redis之String数据结构的读写</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/11/09/181109-SpringBoot高级篇Redis之List数据结构使用姿势/" target="_blank" rel="noopener">181109-SpringBoot高级篇Redis之List数据结构使用姿势</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/12/02/181202-SpringBoot高级篇Redis之Hash数据结构使用姿势/" target="_blank" rel="noopener">181202-SpringBoot高级篇Redis之Hash数据结构使用姿势</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/12/11/181211-SpringBoot高级篇Redis之Set数据结构使用姿势/" target="_blank" rel="noopener">181211-SpringBoot高级篇Redis之Set数据结构使用姿势</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/12/12/181212-SpringBoot高级篇Redis之ZSet数据结构使用姿势/" target="_blank" rel="noopener">181212-SpringBoot高级篇Redis之ZSet数据结构使用姿势</a></li>
<li><a href="http://spring.hhui.top/spring-blog/2018/12/25/181225-SpringBoot应用篇之借助Redis实现排行榜功能/" target="_blank" rel="noopener">181225-SpringBoot应用篇之借助Redis实现排行榜功能</a></li>
</ul>
<p><strong>注意</strong><br>上面这个服务，在实际使用中，需要考虑并发问题，很明显我们上的设计并不是多线程安全的，也就是说，在并发量大的时候，获取的数据极有可能和预期的不一致<br><strong>扩展</strong><br>上文的设计中，每个uri都有一组位图，我们可以通过遍历，获取value为1的下标，来统计这个页面今天的pv数，以及更相信的今天哪些ip访问过；同样也可以分析站点的今日UV数，以及对应的访问ip</p>
<blockquote>
<p>作者：一灰灰Blog</p>
<p>来源：<a href="http://spring.hhui.top/spring-blog/2019/05/13/190513-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E5%BA%94%E7%94%A8%E7%AF%87%E4%B9%8B%E5%80%9F%E5%8A%A9Redis%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1%E6%9C%8D%E5%8A%A1/" target="_blank" rel="noopener">http://spring.hhui.top/spring-blog/2019/05/13/190513-SpringBoot%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%E5%BA%94%E7%94%A8%E7%AF%87%E4%B9%8B%E5%80%9F%E5%8A%A9Redis%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%AB%99%E7%82%B9%E7%BB%9F%E8%AE%A1%E6%9C%8D%E5%8A%A1/</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/08/Spring-Boot-%E5%BA%94%E7%94%A8%E7%AF%87-Redis%EF%BC%881%EF%BC%89%EF%BC%9A%E5%AE%9E%E7%8E%B0%E6%8E%92%E8%A1%8C%E6%A6%9C%E5%8A%9F%E8%83%BD/" rel="prev" title="Spring Boot 应用篇--Redis（1）：实现排行榜功能">
      <i class="fa fa-chevron-left"></i> Spring Boot 应用篇--Redis（1）：实现排行榜功能
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/08/Spring-Boot-%E9%AB%98%E7%BA%A7%E7%AF%87-MongoDB%EF%BC%881%EF%BC%89%EF%BC%9A%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%BD%BF%E7%94%A8/" rel="next" title="Spring Boot 高级篇--MongoDB（1）：基本环境搭建与使用">
      Spring Boot 高级篇--MongoDB（1）：基本环境搭建与使用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#I-背景及需求"><span class="nav-number">1.</span> <span class="nav-text">I. 背景及需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#II-方案设计"><span class="nav-number">2.</span> <span class="nav-text">II. 方案设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-术语说明"><span class="nav-number">2.1.</span> <span class="nav-text">1. 术语说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-pv"><span class="nav-number">2.1.1.</span> <span class="nav-text">a. pv</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-hot"><span class="nav-number">2.1.2.</span> <span class="nav-text">b. hot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-uv"><span class="nav-number">2.1.3.</span> <span class="nav-text">c. uv</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-流程图"><span class="nav-number">2.2.</span> <span class="nav-text">2. 流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-数据结构"><span class="nav-number">2.3.</span> <span class="nav-text">3. 数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-pv-1"><span class="nav-number">2.3.1.</span> <span class="nav-text">a. pv</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-hot-1"><span class="nav-number">2.3.2.</span> <span class="nav-text">b. hot</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-uv-1"><span class="nav-number">2.3.3.</span> <span class="nav-text">c. uv</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-结构图"><span class="nav-number">2.3.4.</span> <span class="nav-text">d. 结构图</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-方案设计"><span class="nav-number">2.4.</span> <span class="nav-text">4. 方案设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-接口API"><span class="nav-number">2.4.1.</span> <span class="nav-text">a. 接口API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-hot相关api"><span class="nav-number">2.4.2.</span> <span class="nav-text">b. hot相关api</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-pv相关api"><span class="nav-number">2.4.3.</span> <span class="nav-text">c. pv相关api</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-uv相关api"><span class="nav-number">2.4.4.</span> <span class="nav-text">d. uv相关api</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-今日是否访问"><span class="nav-number">2.4.5.</span> <span class="nav-text">e. 今日是否访问</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#III-服务实现"><span class="nav-number">3.</span> <span class="nav-text">III. 服务实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-pv接口实现"><span class="nav-number">3.0.1.</span> <span class="nav-text">1. pv接口实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-hot接口实现"><span class="nav-number">3.1.</span> <span class="nav-text">2. hot接口实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-uv接口实现"><span class="nav-number">3.2.</span> <span class="nav-text">3. uv接口实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-今天是否访问过"><span class="nav-number">3.3.</span> <span class="nav-text">4. 今天是否访问过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-api接口实现"><span class="nav-number">3.4.</span> <span class="nav-text">4. api接口实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IV-测试与小结"><span class="nav-number">4.</span> <span class="nav-text">IV. 测试与小结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-测试"><span class="nav-number">4.1.</span> <span class="nav-text">1. 测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-首次访问"><span class="nav-number">4.1.1.</span> <span class="nav-text">a. 首次访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-再次访问"><span class="nav-number">4.1.2.</span> <span class="nav-text">b. 再次访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-同ip，不同URI"><span class="nav-number">4.1.3.</span> <span class="nav-text">c. 同ip，不同URI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-不同ip，接上一个URI"><span class="nav-number">4.1.4.</span> <span class="nav-text">d. 不同ip，接上一个URI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-上一个ip，换第一个uri"><span class="nav-number">4.1.5.</span> <span class="nav-text">e. 上一个ip，换第一个uri</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-第二天访问"><span class="nav-number">4.1.6.</span> <span class="nav-text">f. 第二天访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-小结"><span class="nav-number">4.2.</span> <span class="nav-text">2. 小结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

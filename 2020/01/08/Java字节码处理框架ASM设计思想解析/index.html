<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="最近进行组内分享时选择了这个Java字节码处理这个主题，特此记录下来。众所周知，Java是一门运行在虚拟机上的语言，在创建之初就是为了”write once ，run anywhere “的目的，为了解决不同架构处理器区别，通过虚拟机来屏蔽不同的各个操作系统之间的区别，其虚拟机上运行的平台中立的二进制文件正是class字节码文件，当然JIT,AOT之类的技术是后来为了让Java运行更快加入的，不过">
<meta name="keywords" content="字节码,ASM">
<meta property="og:type" content="article">
<meta property="og:title" content="Java字节码处理框架ASM设计思想解析">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;08&#x2F;Java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6ASM%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E8%A7%A3%E6%9E%90&#x2F;index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="最近进行组内分享时选择了这个Java字节码处理这个主题，特此记录下来。众所周知，Java是一门运行在虚拟机上的语言，在创建之初就是为了”write once ，run anywhere “的目的，为了解决不同架构处理器区别，通过虚拟机来屏蔽不同的各个操作系统之间的区别，其虚拟机上运行的平台中立的二进制文件正是class字节码文件，当然JIT,AOT之类的技术是后来为了让Java运行更快加入的，不过">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-08T03:04:44.000Z">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://congsheng.wang/2020/01/08/Java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6ASM%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E8%A7%A3%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Java字节码处理框架ASM设计思想解析 | 个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">个人博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">congsheng的博客</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">141</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">91</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">807</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/08/Java%E5%AD%97%E8%8A%82%E7%A0%81%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6ASM%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java字节码处理框架ASM设计思想解析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 11:04:44" itemprop="dateCreated datePublished" datetime="2020-01-08T11:04:44+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">Java技术</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近进行组内分享时选择了这个Java字节码处理这个主题，特此记录下来。众所周知，Java是一门运行在虚拟机上的语言，在创建之初就是为了”write once ，run anywhere “的目的，为了解决不同架构处理器区别，通过虚拟机来屏蔽不同的各个操作系统之间的区别，其虚拟机上运行的平台中立的二进制文件正是class字节码文件，当然JIT,AOT之类的技术是后来为了让Java运行更快加入的，不过这里我们只是对Java的字节码文件的处理。<br><a href="https://link.jianshu.com?t=http%3A%2F%2Fasm.ow2.org%2F" target="_blank" rel="noopener">ASM</a>是什么呢，ASM是一个Java字节码层次的处理框架。它可以直接对class文件进行增删改的操作，Java中许多的框架的实现正是基于ASM，比如AOP的实现，Java自身的动态代理只能支持接口的形式，而使用ASM就能很方便的扩展到类的代理。可以说ASM就是一把利剑，是深入Java必须学习的一个点。<br>本章主要通过以下几点来解析ASM</p>
<ul>
<li>ASM的基础使用</li>
<li>ASM的设计模式</li>
<li>Class的文件格式</li>
<li>ASM的源码解析</li>
<li>ASM总结</li>
</ul>
<a id="more"></a>

<h3 id="ASM的基础使用"><a href="#ASM的基础使用" class="headerlink" title="ASM的基础使用"></a>ASM的基础使用</h3><p>对于ASM的使用最推荐的莫过于官方的 《ASM Guide》，介绍的十分详细。这里先抛砖引玉给出一个比较简单的例子，引出ASM中最重要的三个类。假如我们有一个需求是给一个class文件添加一个field字段，代码如下</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> <span class="keyword">class</span> AddField extends ClassVisitor &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    private String <span class="type">name</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    private <span class="type">int</span> <span class="keyword">access</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    private String <span class="keyword">desc</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    private <span class="keyword">Object</span> <span class="keyword">value</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    private <span class="type">boolean</span> duplicate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">public</span> AddField(ClassVisitor cv, String <span class="type">name</span>, <span class="type">int</span> <span class="keyword">access</span>, String <span class="keyword">desc</span>, <span class="keyword">Object</span> <span class="keyword">value</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        super(ASM5, cv);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        this.name = <span class="type">name</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        this.<span class="keyword">access</span> = <span class="keyword">access</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        this.<span class="keyword">desc</span> = <span class="keyword">desc</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        this.<span class="keyword">value</span> = <span class="keyword">value</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">public</span> FieldVisitor visitField(<span class="type">int</span> <span class="keyword">access</span>, String <span class="type">name</span>, String <span class="keyword">desc</span>, String signature, <span class="keyword">Object</span> <span class="keyword">value</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (this.name.equals(<span class="type">name</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            duplicate = <span class="keyword">true</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> super.visitField(<span class="keyword">access</span>, <span class="type">name</span>, <span class="keyword">desc</span>, signature, <span class="keyword">value</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    @Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">public</span> <span class="type">void</span> visitEnd() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!duplicate) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            FieldVisitor fv = super.visitField(<span class="keyword">access</span>, <span class="type">name</span>, <span class="keyword">desc</span>, <span class="keyword">null</span>, <span class="keyword">value</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (fv != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">                fv.visitEnd();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        super.visitEnd();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">public</span> static <span class="type">void</span> main(String[] args) throws <span class="keyword">Exception</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        String output = <span class="keyword">System</span>.getProperty("user.dir") + "/libjava/output";</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        String classDir = <span class="keyword">System</span>.getProperty("user.dir") + "/libjava/output/MainActivity.class";</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        ClassReader classReader = <span class="built_in">new</span> ClassReader(<span class="built_in">new</span> FileInputStream(classDir));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        ClassWriter classWriter = <span class="built_in">new</span> ClassWriter(classReader, ClassWriter.COMPUTE_MAXS);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        ClassVisitor addField = <span class="built_in">new</span> AddField(classWriter,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                "field",</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                Opcodes.ACC_PUBLIC + Opcodes.ACC_STATIC + Opcodes.ACC_FINAL,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">Type</span>.getDescriptor(String.<span class="keyword">class</span>),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                "value"</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        classReader.accept(addField, ClassReader.EXPAND_FRAMES);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        byte[] newClass = classWriter.toByteArray();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        File newFile = <span class="built_in">new</span> File(output, "MainActivity1.class");</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">new</span> FileOutputStream(newFile).<span class="keyword">write</span>(newClass);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这段代码是给一个Class文件多加一个字段的操作，在ASM的封装下，这样的操作实现非常简单，下面我们就将学习到ASM是如何做到这一切的。</p>
<h3 id="ASM的设计模式"><a href="#ASM的设计模式" class="headerlink" title="ASM的设计模式"></a>ASM的设计模式</h3><p>从前面的ClassVisitor以及accept方法就能看出这是明显的visitor（访问者）模式，visitor模式在Java的设计模式中是一种比较冷门的设计模式，冷门并不是因为这个模式的缺陷，而是相较于一些风格比较明显的比如单例，工厂，观察者模式，访问者模式的实际应用场景是比较少的，后面会介绍到这个模式实际存在的一个不小的问题。<br>访问者模式主要包含被访问的元素以及访问者两部分，元素一般是不同的类型，不同的访问者对于这些元素的操作一般也是不同的，访问者模式使得用户可以在不修改现有系统的情况下扩展系统的功能，为这些不同类型的元素增加新的操作。<br>访问者的模式讲解比较好的文章可以看这篇，<a href="https://link.jianshu.com?t=http%3A%2F%2Fblog.csdn.net%2Flovelion%2Farticle%2Fdetails%2F7433523" target="_blank" rel="noopener">操作复杂对象结构——访问者模式</a><br>一般访问者模式的元素会接受一个访问者的参数，在元素内部这个访问者会直接访问这个元素，说的比较绕，用代码来解释</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> interface </span>Employee &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    public void accept(Department handler);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>首先对于元素类我们提供一个接口，内部的方法就是accept，用来接收一个访问者类</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Department</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">visit</span>(<span class="params">FulltimeEmployee employee</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">visit</span>(<span class="params">ParttimeEmployee employee</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这个抽象的访问者类提供了两个访问具体元素的抽象方法，然后我们具体的实现元素类和访问者类。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FADepartment</span> <span class="keyword">extends</span> <span class="title">Department</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(FulltimeEmployee employee)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"正式员工 : "</span> + employee.getName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">visit</span><span class="params">(ParttimeEmployee employee)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"临时工 : "</span> + employee.getName());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FulltimeEmployee</span> <span class="keyword">implements</span> <span class="title">Employee</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> String name;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> String salary;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FulltimeEmployee</span><span class="params">(String name, String salary)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.name = name;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.salary = salary;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(Department <span class="keyword">handler</span>)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">handler</span>.visit(<span class="keyword">this</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这个的元素实现类中的accept方法中传进来的是抽象的访问者类，然后将自身转发出去，达到外界访问这个元素的目的。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmployeeList</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> List&lt;Employee&gt; <span class="built_in">list</span> = <span class="keyword">new</span> ArrayList&lt;&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEmployee</span><span class="params">(Employee employee)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">list</span>.add(employee);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Department department)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (Employee employee : <span class="built_in">list</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            employee.accept(department);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">String</span>[] args)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        EmployeeList <span class="built_in">list</span> = <span class="keyword">new</span> EmployeeList();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        Employee employee1 = <span class="keyword">new</span> FulltimeEmployee(<span class="string">"张三"</span>, <span class="string">"1000"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        Employee employee2 = <span class="keyword">new</span> ParttimeEmployee(<span class="string">"李四"</span>, <span class="string">"500"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        Employee employee3 = <span class="keyword">new</span> ParttimeEmployee(<span class="string">"王五"</span>, <span class="string">"400"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">list</span>.addEmployee(employee1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">list</span>.addEmployee(employee2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">list</span>.addEmployee(employee3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        Department department1 = <span class="keyword">new</span> FADepartment();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">list</span>.accept(department1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>看上面这个例子，通过这种转发的方式，我们就能在不修改元素的条件下，添加对于元素访问的操作，只需要让元素类accept一个新的访问者就行。这样看起来我们通过accept的转发行为让元素类和操作类进行了解耦，所以这种模式这种模式对于添加新的访问者的操作是符合“开闭原则”的，但是如果我们一旦要增加新的元素时，就会导致所有的访问者类都需要增加相应的访问方法，这是明显违反设计模式，所以访问者模式并不适合元素类频繁变动的场景，这也是访问者模式自身最大的缺陷。<br>对于Java class文件来说，其中的元素从设计到现在，基本没有变化，仅仅只添加了一些细节，比如泛型的引入，其实Java就是为了保证低版本的兼容性，才导致了一些不合理的存在，比如为了引入泛型，但是又不想破坏兼容性，才有了泛型擦除这样的坑爹操作，相比C#这样的语言，Java的泛型可以说只是伪泛型，但是Java的优势就是兼容性好，对于访问者模式也就是元素类不会随意改动，这个缺陷也就不存在了。</p>
<h3 id="Class的文件格式"><a href="#Class的文件格式" class="headerlink" title="Class的文件格式"></a>Class的文件格式</h3><p>前面说到Class文件结构，想要理解ASM的内部运行原理，首先需要了解Class文件，这样才能知道ASM如何对于Class文件进行操作，Class文件作为虚拟机所执行的平台中立文件，内部结构设计的十分的清晰，每一个Class文件都对应着唯一一个类或接口的定义信息。每个Class文件都由以8位为单位的字节流组成，下面是一个Class文件中所包括的项，在Class文件中，各项按照严格顺序连续存放，中间没有任何填充或者对齐作为各项间的分隔符号。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="section">ClassFile</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u4</span> magic;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> minor_version;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> major_version;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> constant_pool_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">cp_info</span> constant_pool[constant_pool_count-<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> access_flags;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> this_class;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> super_class;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> interfaces_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> interfaces[interfaces_count];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> fields_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">field_info</span> fields[fields_count];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> methods_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">method_info</span> methods[methods_count];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">u2</span> attributes_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="attribute">attribute_info</span> attributes[attributes_count];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在Class文件结构中，上面各项的含义如下：<br><strong>magic：</strong> 作为一个魔数，确定这个文件是否是一个能被虚拟机接受的class文件，值固定为0xCAFEBABE。<br><strong>minor_version，major_version：</strong>分别表示class文件的副，主版本号，不同版本的虚拟机实现支持的Class文件版本号不同。<br><strong>constant_pool_count：</strong>常量池计数器，constant_pool_count的值等于常量池表中的成员数加1。<br><strong>constant_pool：</strong>常量池，constant_pool是一种表结构，包含class文件结构及其子结构中引用的所有字符常量、类或接口名、字段名和其他常量。<br><strong>access_flags：</strong>access_flags是一种访问标志，表示这个类或者接口的访问权限及属性，包括有ACC_PUBLIC，ACC_FINAL，ACC_SUPER等等。<br><strong>this_class：</strong>类索引，指向常量池表中项的一个索引。<br><strong>super_class：</strong>父类索引，这个值必须为0或者是对常量池中项的一个有效索引值，如果为0，表示这个class只能是Object类，只有它是唯一没有父类的类。<br><strong>interfaces_count：</strong>接口计算器，表示当前类或者接口的直接父接口数量。<br><strong>interfaces[]：</strong>接口表，里面的每个成员的值必须是一个对常量池表中项的一个有效索引值。<br><strong>fields_count：</strong>字段计算器，表示当前class文件中fields表的成员个数，每个成员都是一个field_info。<br><strong>fields：</strong>字段表，每个成员都是一个完整的fields_info结构，表示当前类或接口中某个字段的完整描述，不包括父类或父接口的部分。<br><strong>methods_count：</strong>方法计数器，表示当前class文件methos表的成员个数。<br><strong>methods：</strong>方法表，每个成员都是一个完整的method_info结构，可以表示类或接口中定义的所有方法，包括实例方法，类方法，以及类或接口初始化方法。<br><strong>attributes_count：</strong>属性表，其中是每一个attribute_info，包含以下这些属性，InnerClasses，EnclosingMethod，Synthetic，Signature，Annonation等。</p>
<h3 id="ASM的源码解析"><a href="#ASM的源码解析" class="headerlink" title="ASM的源码解析"></a>ASM的源码解析</h3><p>前面我们分析了ASM的场景刚好适合访问者模式，同时也是这么做的，这里我们就从<code>accept</code>方法开始分析ASM，限于篇幅，这里省略了accept方法中部分的visitor调用，不过原理都是一样的，可以自行对照源码参考</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ClassReader.java</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> accept(<span class="keyword">final</span> ClassVisitor classVisitor,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">                       <span class="keyword">final</span> Attribute[] attrs, <span class="keyword">final</span> <span class="built_in">int</span> flags) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">int</span> u = header; <span class="comment">// current offset in the class file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    char[] c = new char[maxStringLength]; <span class="comment">// buffer used to read strings</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Context context = new Context();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    context.attrs = attrs;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    context.flags = flags;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    context.buffer = c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// reads the class declaration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">int</span> access = readUnsignedShort(u);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    String name = readClass(u + <span class="number">2</span>, c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    String superClass = readClass(u + <span class="number">4</span>, c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    String[] <span class="built_in">int</span>erfaces = new String[readUnsignedShort(u + <span class="number">6</span>)];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    u += <span class="number">8</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">int</span>erfaces.length; ++i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">int</span>erfaces[i] = readClass(u, c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        u += <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// reads the class attributes</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">   ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the class declaration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    classVisitor.visit(readInt(items[<span class="number">1</span>] - <span class="number">7</span>), access, name, signature,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            superClass, <span class="built_in">int</span>erfaces);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the source and debug info</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((flags &amp; SKIP_DEBUG) == <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            &amp;&amp; (sourceFile != <span class="literal">null</span> || sourceDebug != <span class="literal">null</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        classVisitor.visitSource(sourceFile, sourceDebug);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the outer class</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (enclosingOwner != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        classVisitor.visitOuterClass(enclosingOwner, enclosingName,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">                enclosingDesc);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the class annotations and type annotations</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ANNOTATIONS &amp;&amp; anns != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(anns), v = anns + <span class="number">2</span>; i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationValues(v + <span class="number">2</span>, c, <span class="literal">true</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                    classVisitor.visitAnnotation(readUTF8(v, c), <span class="literal">true</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ANNOTATIONS &amp;&amp; ianns != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(ianns), v = ianns + <span class="number">2</span>; i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationValues(v + <span class="number">2</span>, c, <span class="literal">true</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">                    classVisitor.visitAnnotation(readUTF8(v, c), <span class="literal">false</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ANNOTATIONS &amp;&amp; tanns != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(tanns), v = tanns + <span class="number">2</span>; i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationTarget(context, v);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationValues(v + <span class="number">2</span>, c, <span class="literal">true</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">                    classVisitor.visitTypeAnnotation(context.typeRef,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">                            context.typePath, readUTF8(v, c), <span class="literal">true</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ANNOTATIONS &amp;&amp; itanns != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(itanns), v = itanns + <span class="number">2</span>; i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationTarget(context, v);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">            v = readAnnotationValues(v + <span class="number">2</span>, c, <span class="literal">true</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">                    classVisitor.visitTypeAnnotation(context.typeRef,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">                            context.typePath, readUTF8(v, c), <span class="literal">false</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the attributes</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (attributes != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">        Attribute attr = attributes.next;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">        attributes.next = <span class="literal">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">        classVisitor.visitAttribute(attributes);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">        attributes = attr;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the inner classes</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (innerClasses != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">int</span> v = innerClasses + <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(innerClasses); i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">            classVisitor.visitInnerClass(readClass(v, c),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">                    readClass(v + <span class="number">2</span>, c), readUTF8(v + <span class="number">4</span>, c),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">                    readUnsignedShort(v + <span class="number">6</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">            v += <span class="number">8</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the fields and methods</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">    u = header + <span class="number">10</span> + <span class="number">2</span> * <span class="built_in">int</span>erfaces.length;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(u - <span class="number">2</span>); i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">        u = readField(classVisitor, context, u);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">    u += <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = readUnsignedShort(u - <span class="number">2</span>); i &gt; <span class="number">0</span>; --i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">        u = readMethod(classVisitor, context, u);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// visits the end of the class</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">    classVisitor.visitEnd();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>在accept方法中传进来了一个参数<code>ClassVisitor</code>，然后接着往下看，这里我们省略了解析class文件的过程，整个class的解析过程遵循上一小节中Class的文件格式，通过不断的读取ClassReader的构造函数中class二进制byte[]，然后在解析后通过参数classVisitor的抽象visitXXX方法将属性全部转发出去，将其中的visitXXX方法按顺序抽离出来就是</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit(read<span class="constructor">Int(<span class="params">items</span>[1] - 7)</span>, access, name, signature,superClass, interfaces);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">Source(<span class="params">sourceFile</span>, <span class="params">sourceDebug</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">OuterClass(<span class="params">enclosingOwner</span>, <span class="params">enclosingName</span>,<span class="params">enclosingDesc</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">Annotation(<span class="params">readUTF8</span>(<span class="params">v</span>, <span class="params">c</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">TypeAnnotation(<span class="params">context</span>.<span class="params">typeRef</span>,<span class="params">context</span>.<span class="params">typePath</span>, <span class="params">readUTF8</span>(<span class="params">v</span>, <span class="params">c</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">Attribute(<span class="params">attributes</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">InnerClass(<span class="params">readClass</span>(<span class="params">v</span>, <span class="params">c</span>)</span>,read<span class="constructor">Class(<span class="params">v</span> + 2, <span class="params">c</span>)</span>, read<span class="constructor">UTF8(<span class="params">v</span> + 4, <span class="params">c</span>)</span>,read<span class="constructor">UnsignedShort(<span class="params">v</span> + 6)</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">Field(<span class="params">access</span>, <span class="params">name</span>, <span class="params">desc</span>,<span class="params">signature</span>, <span class="params">value</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">Method(<span class="params">context</span>.<span class="params">access</span>,<span class="params">context</span>.<span class="params">name</span>, <span class="params">context</span>.<span class="params">desc</span>, <span class="params">signature</span>, <span class="params">exceptions</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">classVisitor.visit<span class="constructor">End()</span>;</span></pre></td></tr></table></figure>

<p>整个class文件在accept这个方法中，相当于以庖丁解牛的方式，肢解成了上一小节中ClassFile中的每一项，而这个classVisitor实际上是一个抽象类。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassVisitor</span></span></span></pre></td></tr></table></figure>

<p>有抽象类，自然会有实现类，也就是前面的ClassWriter。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ClassWriter</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span></span></span></pre></td></tr></table></figure>

<p>在前面我们添加字段的示例之中，在最后处理完class文件后，通过<code>toByteArray</code>方法生成了新的class文件，所以这里有两个疑问，第一，这个<code>toByteArray</code> 在这里担当了什么角色，为什么能够生成新的Class文件，第二，在参数转发出来之后，我们是如何通过visit系列方法改变整个Class文件的。带着这两个问题，我们继续往下看。<br>首先看一下 <code>toByteArray</code> 这个方法的前半部分</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] toByteArray() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>xFFFF) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Class file too large!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// computes the real size of the bytecode of this class</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> <span class="keyword">size</span> = <span class="number">24</span> + <span class="number">2</span> * interfaceCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> nbFields = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    FieldWriter fb = firstField;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (fb != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        ++nbFields;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">size</span> += fb.getSize();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        fb = (FieldWriter) fb.fv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> nbMethods = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    MethodWriter mb = firstMethod;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (mb != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        ++nbMethods;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">size</span> += mb.getSize();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        mb = (MethodWriter) mb.mv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> attributeCount = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ClassReader.ANNOTATIONS &amp;&amp; itanns != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        ++attributeCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">size</span> += <span class="number">8</span> + itanns.getSize();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        newUTF8(<span class="string">"RuntimeInvisibleTypeAnnotations"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (attrs != <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        attributeCount += attrs.getCount();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">size</span> += attrs.getSize(<span class="keyword">this</span>, <span class="keyword">null</span>, <span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">size</span> += pool.length;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// allocates a byte vector of this size, in order to avoid unnecessary</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// arraycopy operations in the ByteVector.enlarge() method</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    ByteVector out = <span class="keyword">new</span> ByteVector(<span class="keyword">size</span>);</span></pre></td></tr></table></figure>

<p>同样限于篇幅，这里省略了中间的一部分计算size的部分，作者在里面给出了注释，计算Class字节的真实大小，这个字节怎么计算呢，这里首先给了一个24，想必是前面ClassFile中的魔数以及版本号之类的字节数大小，然后在后面分别添加了字段，方法，属性等等的大小，通过这个最终的size，构造了一个ByteVetcor。</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">public byte[] toByteArray() &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    ByteVector <span class="meta">out</span> = new ByteVector(size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.pu<span class="meta">tInt(</span>0xCAFEBABE).pu<span class="meta">tInt(</span>version);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(<span class="meta">index</span>).putByteArray(pool.data, 0, pool.<span class="meta">length</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    int mask = Opcodes.ACC_DEPRECATED | ACC_SYNTHETIC_ATTRIBUTE</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            | ((access &amp; ACC_SYNTHETIC_ATTRIBUTE) / TO_ACC_SYNTHETIC);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(access &amp; ~mask).putShort(name).putShort(superName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(interfaceCount);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    for (int i = 0; i &lt; interfaceCount; ++i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(interfaces[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(nbFields);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    fb = firstField;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">while</span> (fb != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        fb<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        fb = (FieldWriter) fb.fv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(nbMethods);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    mb = firstMethod;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">while</span> (mb != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        mb<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        mb = (MethodWriter) mb.mv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">out</span>.putShort(attributeCount);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (bootstrapMethods != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"BootstrapMethods"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.pu<span class="meta">tInt(</span>bootstrapMethods.<span class="meta">length</span> + 2).putShort(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">                bootstrapMethodsCount);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putByteArray(bootstrapMethods.data, 0, bootstrapMethods.<span class="meta">length</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (ClassReader.SIGNATURES <span class="variable">&amp;&amp;</span> signature != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"Signature"</span>)).pu<span class="meta">tInt(</span>2).putShort(signature);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (sourceFile != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"SourceFile"</span>)).pu<span class="meta">tInt(</span>2).putShort(sourceFile);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (sourceDebug != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        int len = sourceDebug.<span class="meta">length</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"SourceDebugExtension"</span>)).pu<span class="meta">tInt(</span>len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putByteArray(sourceDebug.data, 0, len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (enclosingMethodOwner != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"EnclosingMethod"</span>)).pu<span class="meta">tInt(</span>4);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(enclosingMethodOwner).putShort(enclosingMethod);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> ((access &amp; Opcodes.ACC_DEPRECATED) != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"Deprecated"</span>)).pu<span class="meta">tInt(</span>0);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> ((access &amp; Opcodes.ACC_SYNTHETIC) != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">if</span> ((version &amp; 0xFFFF) &lt; Opcodes.V1_5</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">                || (access &amp; ACC_SYNTHETIC_ATTRIBUTE) != 0) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">            <span class="meta">out</span>.putShort(newUTF8(<span class="string">"Synthetic"</span>)).pu<span class="meta">tInt(</span>0);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (innerClasses != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"InnerClasses"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.pu<span class="meta">tInt(</span>innerClasses.<span class="meta">length</span> + 2).putShort(innerClassesCount);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putByteArray(innerClasses.data, 0, innerClasses.<span class="meta">length</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (ClassReader.ANNOTATIONS <span class="variable">&amp;&amp;</span> anns != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"RuntimeVisibleAnnotations"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">        anns<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (ClassReader.ANNOTATIONS <span class="variable">&amp;&amp;</span> ianns != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"RuntimeInvisibleAnnotations"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">        ianns<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (ClassReader.ANNOTATIONS <span class="variable">&amp;&amp;</span> tanns != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"RuntimeVisibleTypeAnnotations"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">        tanns<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (ClassReader.ANNOTATIONS <span class="variable">&amp;&amp;</span> itanns != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">out</span>.putShort(newUTF8(<span class="string">"RuntimeInvisibleTypeAnnotations"</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">        itanns<span class="meta">.put(</span><span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (attrs != <span class="meta">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">        attrs<span class="meta">.put(</span>this, <span class="meta">null</span>, 0, -1, -1, <span class="meta">out</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">if</span> (invalidFrames) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">        anns = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">        ianns = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">        attrs = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">        innerClassesCount = 0;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">        innerClasses = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">        bootstrapMethodsCount = 0;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">        bootstrapMethods = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">        firstField = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        lastField = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        firstMethod = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">        lastMethod = <span class="meta">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">        computeMaxs = false;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">        computeFrames = true;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">        invalidFrames = false;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">        new ClassReader(<span class="meta">out</span>.data).accept(this, ClassReader.SKIP_FRAMES);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">        <span class="meta">return</span> toByteArray();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">return</span> <span class="meta">out</span>.data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>方法的后半部分就是给这个ByteVector开始填数据了，按照ClassFile的格式依次填入数据，和在ClassReader中读取的顺序一模一样，这样生成的Class结构就是符合虚拟机规范的，也能被虚拟机正常的加载。<br>那么这些数据是从哪里来的呢，聪明的读者现在肯定猜到了，就是前面这些抽象的visit系列方法，它们从原始Class文件中依次读取了数据然后又作为参数传了进来，我们先看第一个方法</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">@Override</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="built_in">void</span> visit(<span class="keyword">final</span> <span class="built_in">int</span> version, <span class="keyword">final</span> <span class="built_in">int</span> access,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> String name, <span class="keyword">final</span> String signature, <span class="keyword">final</span> String superName,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> String[] <span class="built_in">int</span>erfaces) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.version = version;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.access = access;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.name = newClass(name);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    thisName = name;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ClassReader.SIGNATURES &amp;&amp; signature != <span class="literal">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.signature = newUTF8(signature);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.superName = superName == <span class="literal">null</span> ? <span class="number">0</span> : newClass(superName);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (<span class="built_in">int</span>erfaces != <span class="literal">null</span> &amp;&amp; <span class="built_in">int</span>erfaces.length &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">int</span>erfaceCount = <span class="built_in">int</span>erfaces.length;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.<span class="built_in">int</span>erfaces = new <span class="built_in">int</span>[<span class="built_in">int</span>erfaceCount];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">int</span>erfaceCount; ++i) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">this</span>.<span class="built_in">int</span>erfaces[i] = newClass(<span class="built_in">int</span>erfaces[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>这个visit方法是转发的第一个方法，其中的几个参数分别表示了原Class文件中的编译版本，访问标志（是否是final，static，abstract等等），类或接口名，泛型，父类以及实现的接口，可以看到这个方法只是单纯的赋了一下值，并没有什么其他的操作，这些值在最后生成新Class文件的时候会再次写入到byte数组中。<br>再看一个有点复杂的，ASM对于method的处理</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">public <span class="keyword">final</span> MethodVisitor visitMethod(<span class="keyword">final</span> <span class="built_in">int</span> access, <span class="keyword">final</span> <span class="built_in">String</span> name,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">                                       <span class="keyword">final</span> <span class="built_in">String</span> desc, <span class="keyword">final</span> <span class="built_in">String</span> signature, <span class="keyword">final</span> <span class="built_in">String</span>[] exceptions) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MethodWriter(<span class="keyword">this</span>, access, name, desc, signature,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">            exceptions, computeMaxs, computeFrames);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>直接代理给了 <code>MethodWriter</code> 类进行处理，继续跟进去构造函数</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">MethodWriter(<span class="keyword">final</span> ClassWriter cw, <span class="keyword">final</span> <span class="built_in">int</span> access, <span class="keyword">final</span> <span class="keyword">String</span> name,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> <span class="keyword">String</span> desc, <span class="keyword">final</span> <span class="keyword">String</span> signature,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> <span class="keyword">String</span>[] exceptions, <span class="keyword">final</span> <span class="built_in">boolean</span> computeMaxs,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">final</span> <span class="built_in">boolean</span> computeFrames) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">super</span>(Opcodes.ASM5);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (cw.firstMethod == <span class="keyword">null</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        cw.firstMethod = <span class="keyword">this</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        cw.lastMethod.mv = <span class="keyword">this</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    cw.lastMethod = <span class="keyword">this</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  ......</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>前面分析Class的文件结构的时候，方法表是一个数组类型，一个类中存在多个方法是很正常的，这个visitMethod同样会被调用多次，这里重点关注这个 <code>firstMethod</code> 和 <code>cw.lastMethod.mv</code>，在ClassWriter类中其实并没有明显的数组类型来存放多方法结构，这也是ASM对于method和field写的比较模糊的一点，每一次的 <code>visitMethod</code> 的调用都是 new 一个 MethodWriter对象，第一次 <code>cw.firstMethod == null</code>，于是给了 <code>firstMethod</code> 和 <code>lastMethod</code> 赋值当前，既有头又有尾，有些双向链表的意思，但是这里在第二次进来的时候走的是 <code>cw.lastMethod.mv = this</code> ，而 <code>cw.lastMethod</code> 指向的是刚才的 <code>MethodWriter</code> 对象，这就很清晰了，每一个 <code>MethodWriter</code> 的 mv 字段保留着下一个的引用，实际上只是单向的链表。<br>然后我们看一下在输出新的Class文件的时候</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">mb = firstMethod;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="comment">(mb != null)</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    mb.put<span class="comment">(out)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    mb = <span class="comment">(MethodWriter)</span> mb.mv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>刚才我们构造的 method 链表又重新的一个个的写进去了，而我们每一次的visitMethod 都会加长这个链表。<br>ASM就是通过这种方式来修改Class结构的，当我们想要加一个方法的时候，只需要多调用一次 visitMethod 方法，而当我们想删除其中一个方法的时候，只需要 return null，让这个MethodWrite 对象不会被构建即可。</p>
<h3 id="ASM总结"><a href="#ASM总结" class="headerlink" title="ASM总结"></a>ASM总结</h3><p>ClassReader通过读取整个class文件，作为访问者模式中的元素类，而ClassWrite作为ClassVisitor的实现类，是一个特殊的具体访问者，通过一个<code>accept</code>方法将两个连接起来，并在对应的visitXXX系列方法中决定最终元素的属性，而且元素的访问操作是可以进行链式转发的，这样我们既可以拥有ClassWrite的class文件生成能力，也能在自定义的visitor中实现我们想要对于class元素的处理。整体来说，ASM是一款十分优秀的字节码处理的框架，访问者模式十分适合对于class这样的格式基本不会改变的元素形式。<br>这一章主要是介绍ASM对于单个class文件的处理，对于一个完整的Java工程来说，我们想要处理的class文件可能是整个项目所编译出来的全部，后面会带来一篇hook编译过程来实现class处理的文章，两篇结合起来就能实现许多的功能，动态代理，无侵入式埋点，热修复框架都将不是遥不可及。</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="https://link.jianshu.com?t=http%3A%2F%2Fblog.csdn.net%2Flovelion%2Farticle%2Fdetails%2F7433523" target="_blank" rel="noopener">操作复杂对象结构——访问者模式</a></li>
<li><a href="https://link.jianshu.com?t=http%3A%2F%2Fdownload.forge.objectweb.org%2Fasm%2Fasm4-guide.pdf" target="_blank" rel="noopener">ASM guide</a></li>
<li><a href="https://link.jianshu.com?t=https%3A%2F%2Fitem.jd.com%2F11703581.html" target="_blank" rel="noopener">Java虚拟机规范</a></li>
</ul>
<blockquote>
<p>作者：sheepm</p>
<p>来源：<a href="https://www.jianshu.com/p/26e99d39b3fb" target="_blank" rel="noopener">https://www.jianshu.com/p/26e99d39b3fb</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" rel="tag"># 字节码</a>
              <a href="/tags/ASM/" rel="tag"># ASM</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/08/%E6%90%9E%E6%87%82-Java-%E5%86%85%E9%83%A8%E7%B1%BB/" rel="prev" title="搞懂 Java 内部类">
      <i class="fa fa-chevron-left"></i> 搞懂 Java 内部类
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/08/%E5%AD%97%E8%8A%82%E7%A0%81%E5%A2%9E%E5%BC%BA%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/" rel="next" title="字节码增强技术探索">
      字节码增强技术探索 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#ASM的基础使用"><span class="nav-number">1.</span> <span class="nav-text">ASM的基础使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASM的设计模式"><span class="nav-number">2.</span> <span class="nav-text">ASM的设计模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Class的文件格式"><span class="nav-number">3.</span> <span class="nav-text">Class的文件格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASM的源码解析"><span class="nav-number">4.</span> <span class="nav-text">ASM的源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ASM总结"><span class="nav-number">5.</span> <span class="nav-text">ASM总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文献"><span class="nav-number">6.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">807</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">91</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">141</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>

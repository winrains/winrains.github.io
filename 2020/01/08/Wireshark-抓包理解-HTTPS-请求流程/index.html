<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://congsheng.wang').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="1. 准备我的操作是这样的，让手机和电脑在同一个局域网内（比如连接同一个 wifi），接着在手机的wifi上设置代理，电脑使用 Charles 做代理，IP 为电脑在局域网 IP，我这边的环境，手机 IP 为 172.17.32.117，电脑 IP 为 172.17.32.19。再设置代理端口为 8888。设置代理后，接下来手机的请求都会通过电脑的网卡代理请求发送出去。其实可以不用这么绕。我之所以">
<meta name="keywords" content="HTTPS,Wireshark">
<meta property="og:type" content="article">
<meta property="og:title" content="Wireshark 抓包理解 HTTPS 请求流程">
<meta property="og:url" content="http:&#x2F;&#x2F;congsheng.wang&#x2F;2020&#x2F;01&#x2F;08&#x2F;Wireshark-%E6%8A%93%E5%8C%85%E7%90%86%E8%A7%A3-HTTPS-%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B&#x2F;index.html">
<meta property="og:site_name" content="congsheng的博客">
<meta property="og:description" content="1. 准备我的操作是这样的，让手机和电脑在同一个局域网内（比如连接同一个 wifi），接着在手机的wifi上设置代理，电脑使用 Charles 做代理，IP 为电脑在局域网 IP，我这边的环境，手机 IP 为 172.17.32.117，电脑 IP 为 172.17.32.19。再设置代理端口为 8888。设置代理后，接下来手机的请求都会通过电脑的网卡代理请求发送出去。其实可以不用这么绕。我之所以">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120415-a00e8.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120417-2460a.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120418-83d68.jpeg">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120419-738e0.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120420-1caff.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120421-dc523.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120421-3d0a2.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120421-81215.gif">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120421-30ed5.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120422-b9a8b.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120423-5d80b.gif">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120424-30102.png">
<meta property="og:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120425-787f3.png">
<meta property="og:updated_time" content="2020-01-08T11:08:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;image.winrains.cn&#x2F;2019&#x2F;11&#x2F;20191109120415-a00e8.png">

<link rel="canonical" href="http://congsheng.wang/2020/01/08/Wireshark-%E6%8A%93%E5%8C%85%E7%90%86%E8%A7%A3-HTTPS-%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>Wireshark 抓包理解 HTTPS 请求流程 | congsheng的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">congsheng的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">欢迎访问：winrains.cn</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">156</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">984</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://congsheng.wang/2020/01/08/Wireshark-%E6%8A%93%E5%8C%85%E7%90%86%E8%A7%A3-HTTPS-%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="congsheng.wang">
      <meta itemprop="description" content="trouble is a friend">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="congsheng的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Wireshark 抓包理解 HTTPS 请求流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 19:08:30" itemprop="dateCreated datePublished" datetime="2020-01-08T19:08:30+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" itemprop="url" rel="index">
                    <span itemprop="name">网络安全</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" itemprop="url" rel="index">
                    <span itemprop="name">网络协议</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="1-准备"><a href="#1-准备" class="headerlink" title="1. 准备"></a>1. 准备</h2><p>我的操作是这样的，让手机和电脑在同一个局域网内（比如连接同一个 wifi），接着在手机的wifi上设置代理，电脑使用 Charles 做代理，IP 为电脑在局域网 IP，我这边的环境，手机 IP 为 172.17.32.117，电脑 IP 为 172.17.32.19。再设置代理端口为 8888。设置代理后，接下来手机的请求都会通过电脑的网卡代理请求发送出去。<br>其实可以不用这么绕。我之所以多设了一个代理，是因为自己电脑创建的 wifi 热点，手机接收不到。为了让手机的包能经过电脑网络嗅探到才这么处理的。<br>最便捷的方式，就是电脑放个 wifi 热点给手机连接完事。</p>
<a id="more"></a>

<p>创建后代理连接后，然后使用 Wireshark 嗅探网卡，比如我这里使用的是 etho0 网卡去访问网络的。这时候玩玩手机，打开几个请求，Wireshark 上面就会出现捕捉的大量的包，各种各样的协议都有，有 ARP 寻人启事（寻找 IP 对应的物理地址），有 TCP 连接包，有 HTTP 请求包。</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120415-a00e8.png" alt="img"></p>
<p>请求数据</p>
<p>这里我设置了一下过滤规则，把对网易的一个 <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fnex.163.com" target="_blank" rel="noopener">https://nex.163.com</a> 的一个的请求过滤出来如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120417-2460a.png" alt="img"></p>
<p>HTTPS 连接数据</p>
<p>整个完整的 HTTPS 请求的过程如下：</p>
<ul>
<li><strong>TCP 三次握手</strong>。</li>
<li>因为我使用电脑作为代理，所以还有一个 <strong>CONNECT 请求用来建立 HTTP 代理</strong>。</li>
<li><strong>使用 TLSv1.2 进行 SSL 握手</strong>。</li>
<li><strong>使用握手协商好的密钥对 HTTP 进行加密传输</strong>。</li>
<li><strong>TCP 四次挥手</strong>。</li>
</ul>
<p>接下来把手机称为 A（172.17.32.211），电脑称为 B（172.17.32.19），对完整的过程进行简要分析。</p>
<h2 id="2-分析"><a href="#2-分析" class="headerlink" title="2. 分析"></a>2. 分析</h2><h3 id="2-1-三次握手"><a href="#2-1-三次握手" class="headerlink" title="2.1. 三次握手"></a>2.1. 三次握手</h3><h4 id="2-1-1-TCP-协议内容"><a href="#2-1-1-TCP-协议内容" class="headerlink" title="2.1.1. TCP 协议内容"></a>2.1.1. TCP 协议内容</h4><p>作为整个过程的第一个 TCP 包，这里对它做一个详细的剖析，理解一下 TCP 报文的格式和内容。TCP 是传输层协议，负责可靠的数据通信，它在整个体系结构的位置如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120418-83d68.jpeg" alt="img"></p>
<p>计算机网络体系结构</p>
<p>作为传输层协议，主要为上层协议提供三个功能：</p>
<ul>
<li><strong>可靠传输</strong>，为每个字节安排好序号，排好序，并且有重传机制保证信息不丢失。</li>
<li><strong>流量控制</strong>，有滑动窗口，避免发送端和接收端速率不一致导致发包过快来不及接收。</li>
<li><strong>拥塞避免</strong>，在网络环境差的时候，控制好传包的时间间隔，避开高峰期，不给原本已经很拥堵的网络添堵。</li>
</ul>
<p>TCP 协议为 HTTP 和 SSL 协议提供了基础的通信功能。所以 SSL 协议是基于 TCP 的。<br>三次握手的内容有：</p>
<table>
<thead>
<tr>
<th>No.</th>
<th>Time</th>
<th>Source</th>
<th>Destionation</th>
<th>Protocol</th>
<th>Length</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>379</td>
<td>4.623811</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>TCP</td>
<td>74</td>
<td>35973 → 8888 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 SACK_PERM=1 TSval=15986187 TSecr=0 WS=256</td>
</tr>
<tr>
<td>380</td>
<td>4.623860</td>
<td>172.17.32.19</td>
<td>172.17.32.211</td>
<td>TCP</td>
<td>74</td>
<td>8888 → 35973 [SYN, ACK] Seq=0 Ack=1 Win=8192 Len=0 MSS=1460 WS=256 SACK_PERM=1 TSval=59355465 TSecr=15986187</td>
</tr>
<tr>
<td>393</td>
<td>4.781431</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>TCP</td>
<td>66</td>
<td>35973 → 8888 [ACK] Seq=1 Ack=1 Win=87808 Len=0 TSval=15986193 TSecr=59355465</td>
</tr>
</tbody></table>
<p>对每个包进行详细的分析：</p>
<h4 id="2-1-2-Round-1"><a href="#2-1-2-Round-1" class="headerlink" title="2.1.2. Round 1"></a>2.1.2. Round 1</h4><p><strong>A 发出一个带 SYN 同步位的包，通知服务端要建立连接</strong>。<br>第一次握手，发出的 TCP 包的数据和 Wireshark 解析的结果如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120419-738e0.png" alt="img"></p>
<p>第一次握手</p>
<p>灰色部分就是 TCP 报文的数据内容，第一个两个字节 0x8c85 = 35973 表示源端口。<br>TCP 报文的格式如下，对应的如上图的灰色部分。非灰色部分分别为 IP 首部和数据帧首部。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="code"> 0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--<span class="code">+--+</span>--+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">|                    源端口                      |                     目的端口                   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------------------------------------------+</span>-----------------------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">|                                             序列号                                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------------------------------------------------------------------------------------------+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">|                                             确认号                                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------+</span>-----------------<span class="code">+-----------------+</span>-----------------------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">|  首部长度  |     保留位       | U| A| P| R| S| F|                      窗口                      |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------+</span>-----------------<span class="code">+-----------------+</span>-----------------------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">|                    校验和                      |                     紧急指针                   |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-----------------------------------------------+</span>-----------------------<span class="code">+-----------------------+</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">|                    选项                                                |        填充            |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="code">+=======================================================================+</span>=======================+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">|                                             数据                                               |</span></pre></td></tr></table></figure>

<p>参考谢希仁版本的 《计算机网络》一书，对照着整个报文格式表，把整个 TCP 报文的二进制信息和相关意义做些说明：</p>
<ul>
<li><p><strong>源端口</strong>，2 字节，0x8c85 = 35973。</p>
</li>
<li><p><strong>目的端口</strong>，2字节，0x22b8 = 8888。</p>
</li>
<li><p><strong>序号</strong>，4 字节，0xc7a3ce5c。TCP 连接传送的每一个字节都有编号，而这里表示的是要发送的数据（data）的第一个字节的序号。后面按照这个序号递增。这里发送的是 TCP 连接的第一个包，这里的序号是随机产生的。</p>
</li>
<li><p><strong>确认号</strong>，4 字节，0x00000000。期望收到的下一个报文段数据部分第一个字节的序号。如果发出了 N 确认号，就表示 N-1 之前的数据都收到了。</p>
</li>
<li><p><strong>首部长度（偏移）</strong>，4 位，0xa = 10。这里每一位表示4字节，所以 10*4 = 40 字节。TCP 首部的长度，因为 4 位最大的数为 15，所以整个首部最大 60 字节。首部后面就是数据字段。</p>
</li>
<li><p><strong>保留位</strong>，6 位，0x000。这里还没有用到为 0，这里的设计作为一个扩展以便未来会用上。</p>
</li>
<li><p>控制位</p>
<p>，6 位，0x002 = 二进制 000010。每一位都有意义，这里对应 6 种类型：</p>
<ul>
<li><strong>URG</strong>，Urgent，表示紧急数据要提交，有了这个标记为整个报文就有了插队的特权，和紧急指针一起用。</li>
<li><strong>ACK</strong>，Acknowledge，1 表示这是一个确认报文，用来确认收到了包，确认报文是不带数据的。</li>
<li><strong>PSH</strong>，Push，1 表示这是一个推送报文，通知对方尽快响应。因为服务端可能因为缓存问题要等了一会儿才发包。这里就是催促一下对方赶紧发包。</li>
<li><strong>RST</strong>，Reset，1 表示拒绝了这个包，网络发生错误的时候这种包会非常多。比如重复的包就会被 reset 掉。</li>
<li><strong>SYN</strong>，Synchronization，1 表示建立连接用来同步序号。用来握手阶段，通知对方包的初始序号。</li>
<li><strong>FIN</strong>，Finish，1 表示发送方 B 完成数据发送，通知接收方 A 该结束了。</li>
</ul>
<p>我们这里作为整个请求过程中的第一个 TCP 报文，仅仅设置一个控制位 SYN，一方面通知响应者 B 要建立连接了，另一方面同步一下序号。</p>
</li>
<li><p><strong>窗口</strong>，2 字节，0xffff = 65535。发送本报文的接收窗口大小，比如 A 发送了这个报文，表示能接收的数据量为从确认号算起来加上窗口大小，B 发送的报文字节数不能超过这个限制。这个值受 A 的缓存影响，是动态变化的。前面给出确认号为 0， 然后窗口大小 65535，表示还有 65535 的缓存空间可以接受序号 0 ~ 65535 的字节。</p>
</li>
<li><p><strong>检验和</strong>，2 字节，0x068f。接收方受到报文要计算一下数据包的检验和是否和该值匹配，确保数据包的完整。这里只保证了数据完整性，并没有确认服务端身份，也没有用摘要算法。目的在于能快速检验，而且采用检验和的方式还可以使用硬件加速。</p>
</li>
<li><p><strong>紧急指针</strong>，2 字节，0x0000f。和控制位 URG 配合使用，意义在于，有紧急数据要处理，这里的值表示紧急数据在报文中的位置。</p>
</li>
</ul>
<p>到这里的话，TCP 数据报首部固定部分结束，固定部分一共有 20 字节。也就是 TCP 首部，至少要有 20 字节。<br>固定首部后，就是可长度可以变化的选项了：</p>
<ul>
<li><p>选项</p>
<p>，可达 40 字节</p>
<ul>
<li><strong>最大报文长度</strong>，0x020405b4。0x2 表示这是个 MSS 选项，0x04 表示该选项一共有 4 字节，这里的 0x05b4 = 1460 为该选项的值。这个表示 TCP 数据部分的最大字节数。</li>
<li><strong>时间戳</strong>，0x080a00f3ee0b00000000。0x8 表示这是个时间戳选项，0x0a 表示该选项一共有 10 字节，0x00f3ee = 15986187 就是发送者的发送时间，0x00000000 = 0 表示接收端的时间。</li>
</ul>
</li>
</ul>
<p>整个所以 TCP 数据包的大小可以这样表示：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="code">+------------------------+</span>--------------------------------------------------------------+</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">|  TCP 首部，20 ~ 60 字节 |           数据部分，受 MSS 大小限制                           |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="code">+------------------------+</span>--------------------------------------------------------------+</span></pre></td></tr></table></figure>

<p>我们 Wireshark 后面的一长串的信息就指出了该 TCP 报文的一些主要信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">35973 → 8888 [SYN] <span class="attribute">Seq</span>=0 <span class="attribute">Win</span>=65535 <span class="attribute">Len</span>=0 <span class="attribute">MSS</span>=1460 <span class="attribute">SACK_PERM</span>=1 <span class="attribute">TSval</span>=15986187 <span class="attribute">TSecr</span>=0 <span class="attribute">WS</span>=256</span></pre></td></tr></table></figure>

<ul>
<li><strong>源端口和目的端口</strong>，35973-&gt;8888。</li>
<li><strong>序号</strong>，Seq=0，这是一个相对值而非绝对值，相对第一个包的序列号。因为是整个 TCP 流的第一包，所以 Wireshark 认定该包的序列号为 0。</li>
<li><strong>窗口大小</strong>，win=65535，也就是发送端的当前窗口最多容纳 65535 个字节。</li>
<li><strong>数据部分大小</strong>，Len=0，不带数据。</li>
<li><strong>最大报文大小选择</strong>，MSS=1460，数据部分最多有 1460 个字节。</li>
<li><strong>选择确认选项</strong>，SACK_PERM=1。</li>
<li><strong>发送时间戳</strong>，TSval=15986187，发出这个数据包的时候的时间戳。</li>
<li><strong>应答时间戳</strong>，TSecr=0，当前要发送的包应答的那个包的发送时间戳，因为是第一个包，应答的时间戳为 0。</li>
<li><strong>窗口扩大</strong>，WS=256。</li>
</ul>
<p>从上面的分析可以看出，这个 SYN 包并没有携带数据，但是按协议这里要消耗一个序号。<br>在发出 SYN 包后，A 端进入 <strong>SYN-SENT</strong> 状态。</p>
<h4 id="2-1-3-Round-2"><a href="#2-1-3-Round-2" class="headerlink" title="2.1.3. Round 2"></a>2.1.3. Round 2</h4><p><strong>B 收到 SYN 包，发出 SYN + ACK 确认包</strong>。<br>这个包，既是确认收到了第一次握手的包，也是一个由 B 端发出的同步包，表示自己准备好了，可以开始传数据了。<br>因为 Wireshark 已经帮我们分析好包的内容了，上面列举的包二进制数据和 TCP 报文结构只是为了学习，实际应用可以直接看 Wireshark 的解析内容。包的内容如下:</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120420-1caff.png" alt="img"></p>
<p>第二次握手</p>
<p>TCP 报文包相对于第一次握手的包可以窥见一些变化：</p>
<ul>
<li><strong>源端口和目的端口</strong>：8888 -&gt; 35973。</li>
<li><strong>窗口大小</strong>：8192，可以看成接收端的窗口只有 8192，和发送端差距还是挺大的。</li>
<li><strong>控制位</strong>：既有 SYN 又有 ACK。因为这既是一个接收端 B 的自己同步包，里面有一个接收端的初始序号，Wireshark 转化为相对序号 0；同时这也是对第一次握手的包的确认。因此这个包也不带数据。</li>
<li><strong>发送时间戳</strong>：59355465</li>
<li><strong>应答时间戳</strong>：15986187</li>
</ul>
<p>可以看到，这个包的应答时间戳刚好是第一次握手的发送时间戳。从这里也可以理解到，这个包就是在响应第一次握手的包<br>所以，接收方 A 可以利用这个值来计算这一次 <strong>RTT</strong>，收到第二次握手的包后，计算当前时间戳减去该包的应答时间戳就是一个 <strong>RTT</strong> 的延时了。<br>这虽然是 ACK 包，但也是 SYN 包，所以也要消耗一个序号。<br>在发出这个包后，B 端进入 SYN-REVD 状态。</p>
<h4 id="2-1-4-Round-3"><a href="#2-1-4-Round-3" class="headerlink" title="2.1.4. Round 3"></a>2.1.4. Round 3</h4><p><strong>A 收到后，再发出一个 ACK 确认包</strong><br>发出的包如下：</p>
<table>
<thead>
<tr>
<th>No.</th>
<th>Time</th>
<th>Source</th>
<th>Destionation</th>
<th>Protocol</th>
<th>Length</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>393</td>
<td>4.781431</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>TCP</td>
<td>66</td>
<td>35973 → 8888 [ACK] Seq=1 Ack=1 Win=87808 Len=0 TSval=15986193 TSecr=59355465</td>
</tr>
</tbody></table>
<p>这里我们产生一个疑问，这里发送端 A 发连接请求信息、接收端 B 发确认信息，又互相同步了序号，是不是已经可以传输数据了？但实际上 A 还要再发一个 ACK 确认报文，如图所示，确认收到了 B 第二次握手发出的包，这个时候，在这个 ACK 包后 A 和 B 才正式进入 ESTABLISHED 状态。这就是第三次握手。<br>这是为什么呢？<br>假设我们用两次握手，然后在第一次握手期间，A 发了第一次握手包后出现了这样的场景：一直没有得到响应而进行超时重传，又发了一次包，然后我们称上一次包为失效包。<br>然后我们可以看到：</p>
<ul>
<li><strong>新包到达接收端 B</strong>，然后因为两次握手 B 觉得连接建立，于是等着发送端 A 发数据，A 也发了数据。</li>
<li><strong>失效的包经过艰苦跋涉，也到达了接收端 B</strong>，B 并不清楚这是失效包，又开始等待发送端 A 发数据。然而此时 A 不发数据，所以 B 的资源就浪费掉了。</li>
</ul>
<p>所以，只有接收端 B 在发送端 A 发出了第三次握手包后，才认为连接已经建立，开始等待发送端 A 发送的数据，才不会因为失效的连接请求报文导致接收端异常。</p>
<h4 id="2-1-5-小结"><a href="#2-1-5-小结" class="headerlink" title="2.1.5. 小结"></a>2.1.5. 小结</h4><p>TCP 三次握手的时序图如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120421-dc523.png" alt="img"></p>
<p>三次握手时序图</p>
<p>三次握手，有几个重要的任务，一个是<strong>同步序号</strong>，接收端和发送端都发出同步包来通知对方初始序号，这样子后面接收的包就可以根据序号来保证可靠传输；另一个是让发送端和接收都<strong>做好准备</strong>。然后就开始传数据了。<br>整个过程都发生在 HTTP 报文发出之前。HTTP 协议就是依靠着 TCP 协议来做传输的管理。TCP 可以认为是它的管家，管理着传输的大大小小的事务，比如要不要保证包顺序一致？什么时候发包？要不要收包？TCP 是很严格的。<br>三次握手在 Java API 层面，对应的就是 Socket 的连接的创建（最终调用的是 native 层的 socket 创建）：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">socket.<span class="built_in">connect</span>(address, connectTimeout);</span></pre></td></tr></table></figure>

<p>这里的 connectTimeout 对应的是三次握手的总时长，如果超时了就会被认为连接失败。<br>比如一个场景，客户端发出一个 SYN 报文后，迟迟没有收到服务端的 SYN + ACK。这时候客户端触发重传机制，每次重传的间隔时间加倍，同样没有收到包。然后如果这段时间超出了连接超时时间的设置，那么建立连接超时就发生了。<br>所以，如果三次握手要花的时间，总是大于这里的 connectTimeout 时间，这个 Socket 就无法建立连接。<br>我们这一次请求的三次握手时间在 180ms 左右。<br>像在 OkHttp 中，如果是三次握手阶段的连接超时，是会有重试机制的。也就是重新建联，重新发出 SYN 报文发起 TCP 连接。重新建联的时候会更换连接的路由，如果已经没有可选择路由的话，那么这个就真的失败了。<br>在 OkHttp 3.9.0 的默认配置中，连接超时的时间为 10000ms = 10s。在 OkHttpClient.Builder 中。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attr">connectTimeout</span> = <span class="number">10_000</span><span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="attr">readTimeout</span> = <span class="number">10_000</span><span class="comment">;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="attr">writeTimeout</span> = <span class="number">10_000</span><span class="comment">;</span></span></pre></td></tr></table></figure>

<p>实际应用的时候，根据业务场景来调整。</p>
<h3 id="2-2-创建-HTTP-代理（非必要）"><a href="#2-2-创建-HTTP-代理（非必要）" class="headerlink" title="2.2. 创建 HTTP 代理（非必要）"></a>2.2. 创建 HTTP 代理（非必要）</h3><p>这次请求，为了让 Wireshark 抓到手机的包，我使用了电脑作为代理。<br>其实就是客户端 A 使用 HTTP 协议和代理服务器 B 建立连接。和普通的 HTTP 请求一样，需要携带 IP + 端口号，如果有身份验证的时候还会带上授权信息，代理服务器 B 会使用授权信息进行验证。然后代理服务器会去连接远程主机，连接成功后返回 200。<br>Wireshark 抓到的包有这样两条信息，就是在创建代理：</p>
<table>
<thead>
<tr>
<th>No.</th>
<th>Time</th>
<th>Source</th>
<th>Destionation</th>
<th>Protocol</th>
<th>Length</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>396</td>
<td>4.798832</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>HTTP</td>
<td>284</td>
<td>CONNECT nex.163.com:443 HTTP/1.1</td>
</tr>
<tr>
<td>401</td>
<td>4.816127</td>
<td>172.17.32.19</td>
<td>172.17.32.211</td>
<td>HTTP</td>
<td>105</td>
<td>HTTP/1.0 200 Connection established</td>
</tr>
</tbody></table>
<p>请求报文：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CONNECT nex<span class="number">.163</span>.com:<span class="number">443</span> HTTP/<span class="number">1.1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Linux; Android <span class="number">6.0</span><span class="number">.1</span>; MI <span class="number">5</span> Build/MXB48T; wv) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Version/<span class="number">4.0</span> Chrome/<span class="number">51.0</span><span class="number">.2704</span><span class="number">.81</span> Mobile Safari/<span class="number">537.36</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">Host: nex<span class="number">.163</span>.com</span></pre></td></tr></table></figure>

<p>响应报文：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">HTTP/1.0 200<span class="built_in"> Connection </span>established</span></pre></td></tr></table></figure>

<p>HTTP CONNECT 是在 HTTP1.1 新增的命令，用于支撑 https 加密。<br>因为我采用代理的方式抓包才有这一个步骤。如果是直接抓 PC 机上浏览器发出的 HTTPS 包，不会有这个过程。<br>然后我们思考一下，为什么代理服务器需要这些信息，要连接的主机名和端口号？<br>这是因为后面进行 SSL 加密 HTTP协议，因为代理服务器拿不到加密密钥，是无法获取到 HTTP 首部的，进而无法这个请求是要发到哪个主机的。所以，这里先使用 CONNECT 方法，把主机名和对应的端口号通知代理服务器。<br>这个也被称为 HTTPS SSL 隧道协议。建立这个 SSL 隧道后，这个特殊代理就会对数据进行盲转发。</p>
<h3 id="2-3-TLS-SSL-握手"><a href="#2-3-TLS-SSL-握手" class="headerlink" title="2.3. TLS/SSL 握手"></a>2.3. TLS/SSL 握手</h3><h4 id="2-3-1-TLS-SSL-协议内容"><a href="#2-3-1-TLS-SSL-协议内容" class="headerlink" title="2.3.1. TLS/SSL 协议内容"></a>2.3.1. TLS/SSL 协议内容</h4><p>SSL 整个协议实际上分两层，SSL 记录协议和其他子协议（SSL握手协议，SSL改变密码协议，SSL警告协议）：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120421-3d0a2.png" alt="img"></p>
<p>SSL 协议</p>
<p>这两层协议的关系，其实就是数据封装的关系，SSL 握手封装协议封装其他上层协议。<br>封装握手协议：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Client </span>Hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        Version: TLS 1.0 (0x0301)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Length: 153</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Protocol:<span class="built_in"> Client </span>Hello</span></pre></td></tr></table></figure>

<p>封装应用数据协议，比如 HTTP：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="string">Secure</span> <span class="string">Sockets</span> <span class="string">Layer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">TLSv1.2 Record Layer: Application Data Protocol:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Content Type:</span> <span class="string">Application</span> <span class="string">Data</span> <span class="string">(23)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Version:</span> <span class="string">TLS</span> <span class="number">1.2</span> <span class="string">(0x0303)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Length:</span> <span class="number">1072</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Encrypted Application Data:</span> <span class="string">6d9b3c9089271630c33506fe28cd6a61fed1f4bd2808f537...</span></span></pre></td></tr></table></figure>

<p>封装交换密码协议：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: <span class="keyword">Change</span> Cipher Spec Protocol: <span class="keyword">Change</span> Cipher Spec</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Content</span> <span class="keyword">Type</span>: <span class="keyword">Change</span> Cipher Spec (<span class="number">20</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Version</span>: TLS <span class="number">1.2</span> (<span class="number">0x0303</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Length</span>: <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Change</span> Cipher Spec Message</span></pre></td></tr></table></figure>

<p>封装警报协议：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1<span class="number">.2</span> <span class="type">Record</span> Layer: <span class="keyword">Encrypted</span> Alert</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Content <span class="keyword">Type</span>: Alert (<span class="number">21</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Version</span>: TLS <span class="number">1.2</span> (<span class="number">0x0303</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Length: <span class="number">48</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Alert Message: <span class="keyword">Encrypted</span> Alert</span></pre></td></tr></table></figure>

<p>所以 SSL 记录协议其实就是一个其他协议的载体，只是提供了一个封装的功能。它的格式为：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">|<span class="string"> 内容类型 </span>|<span class="string"> 主要版本 </span>|<span class="string"> 次要版本 </span>|<span class="string"> 长度 </span>|</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">|<span class="string">          明文/加密/压缩 数据包       </span>|</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">|<span class="string">          MAC(0, 16, 20)            </span>|</span></pre></td></tr></table></figure>

<p>MAC 就是消息验证码，用来验证数据的完整性，保证中途没有篡改。这个消息验证码比数字签名弱一些，使用的是对称密钥加密摘要。数字签名使用的是非对称密钥加密，有区分公钥私钥。<br>记录协议的主要目的有这几个，为其他 SSL 子协议提供了以下服务：</p>
<ul>
<li><p><strong>分组、组合</strong>。如果有几个协议的内容，是可以不用等客户端确认后再发送的，这里会进行组合合并，然后在同一个 TCP 包中发送。接收方接收到组合的 SSL 记录协议报文，也会根据协议来进行分组。</p>
</li>
<li><p><strong>压缩、解压缩</strong>。可选项，如果需要压缩的话。</p>
</li>
<li><p><strong>消息认证（MAC）</strong>。注意，这里不提供数字签名。消息认证用的是用对称密钥，解密算法效率比公钥算法快，安全性弱一些。如果已经明确了，加密用的对称密钥只有合法的客户端和服务端获得，那么这个的安全效果和数字签名一样。</p>
</li>
<li><p>加密传输</p>
<p> 。比如已经协商好加密密钥和算法了，直接对应用层协议加密传输：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Encrypted Application Data: 6d9b3c9089271630c33506fe28<span class="keyword">cd</span>6a61fed1f4bd2808f537.<span class="string">..</span></span></pre></td></tr></table></figure>

</li>
</ul>
<p>TCP 三次握手结束并且和代理服务器成功连接后，建联成功，客户端 A 就开始发起 SSL 连接，首先会进入 SSL 握手阶段。<br>SSL 握手阶段的主要目的有这么几个：</p>
<ul>
<li><p><strong>协商加密算法</strong>。为了能够提供效率，使用对称密钥。对称加密使用的是位运算，速度快，甚至可以硬件加速。非对称加密比如 RSA，使用了大数乘法等，整体会比较慢。对称加密只要密钥没有泄漏，那也是非常安全的。这也是后面 SSL 握手协议要确保的。</p>
</li>
<li><p><strong>协商加密密钥</strong> 。用来对后面的 HTTP 协议等应用协议内容进行加密。这个密钥又称为主密钥，为加密算法的密钥。</p>
</li>
<li><p><strong>验证身份</strong> 。通常情况下，只要验证服务端身份。特殊情况下，比如一些安全级别高的应用场景，还要验证客户端身份。服务端会返回证书链，有根 CA 证书在里头。通过证书的链式担保，可以确认服务端是否是可信任的。同时，在握手期间，公钥传输成功后，还会对某些信息进行数字签名，确保数据没有被篡改且身份无误。</p>
</li>
</ul>
<p>SSL 握手的流程并不是一成不变的，根据实际的应用场景来。主要有三种：</p>
<ul>
<li><strong>只验证服务端</strong>。这个用三个阶段就完成握手，我们这次的请求也是这样。一般的网络请求也仅仅到这个程度。</li>
<li><strong>验证服务端和客户端</strong>。在安全性要求较高的场景，服务端也要验证客户端的身份。方式也是发证书证明自己。</li>
<li><strong>恢复原有会话</strong> 。这个属于HTTPS 优化的范畴。使用 Session Ticket 或者 Session ID 机制恢复之前已经完成握手的会话。这个是可以允许在不同的 TCP 上进行的。因为握手的加密数据已经保存，直接恢复就可以开始传递了。Session Ticket 由客户端保存加密信息，Session ID 的方式由服务端保存加密信息。不过 Session Ticket 在 Android 客户端还没有得到广泛的支持，和具体机型和内置的 OpenSSL 的版本有关。</li>
</ul>
<p>SSL 握手的完整的交互过程如下，这里是验证服务端又验证了客户端的情况：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120421-81215.gif" alt="img"></p>
<p>SSL 握手</p>
<p>我们的请求只验证服务端，所以 7,8,9 是不存在的。<br>现在具体分析每一个阶段的内容。</p>
<h4 id="2-3-2-阶段一"><a href="#2-3-2-阶段一" class="headerlink" title="2.3.2. 阶段一"></a>2.3.2. 阶段一</h4><p><strong>Client Hello</strong><br>作为 SSL 握手的第一个握手包，我们详细分析和理解一下包的内容。<br>下面是 Wireshark 解析好的这个 SSL 协议的数据包：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Client </span>Hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        Version: TLS 1.0 (0x0301)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Length: 153</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Protocol:<span class="built_in"> Client </span>Hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            Handshake Type:<span class="built_in"> Client </span>Hello (1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            Length: 149</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            Random</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                GMT Unix Time: Dec  1, 2050 02:37:13.000000000 �й���׼ʱ��</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                Random Bytes: 4e12e967b6169c4d67caf0575079f34b277d12318385f5a9<span class="built_in">..</span>.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            Session ID Length: 0</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            Cipher Suites Length: 40</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            Cipher Suites (20 suites)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            Compression Methods Length: 1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            Compression Methods (1 method)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            Extensions Length: 68</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            Extension: server_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            Extension: Extended Master Secret</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            Extension: signature_algorithms</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            Extension: ec_point_formats</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            Extension: elliptic_curves</span></pre></td></tr></table></figure>

<p>这个包如何解读，按照之前对 SSL 协议的分析，其实分成两个部分：</p>
<ul>
<li>SSL 握手协议。</li>
<li>SSL 记录协议。</li>
</ul>
<p>因为是握手过程，密钥还没协商，这里还是使用明文传输，记录协议的数据载体就是明文的 SSL 握手协议。<br>SSL 握手协议的格式为：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-------+</span>--------+----------------------</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">| 类型  | 长度    | 内容</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="code">+-------+</span>--------+----------------------</span></pre></td></tr></table></figure>

<p>我们可以从握手协议的数据包中得到这些信息：</p>
<ul>
<li><p>版本</p>
<p>，TLS 1.2 也是 SSLv3.2。这是 SSL 客户端能够支持的 </p>
<p>SSL 最高版本</p>
<p>，主版本号 3，此版本号 2。TLS 目前的版本如下：</p>
<table>
<thead>
<tr>
<th>Major Version</th>
<th>Minor Version</th>
<th>Version Type</th>
</tr>
</thead>
<tbody><tr>
<td>3</td>
<td>0</td>
<td>SSLv3</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>TLS 1.0</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>TLS 1.1</td>
</tr>
<tr>
<td>3</td>
<td>3</td>
<td>TLS 1.2</td>
</tr>
</tbody></table>
<p>最后使用什么样的版本，得由服务端决定。如果服务端不支持的话，客户端得降版本。</p>
</li>
<li><p>随机数</p>
<p> ，生成一个32字节随机数。最后加密数据用的主密钥，需要客户端和服务端一起协商出来。后面服务端的 Server Hello 阶段也会生成一个随机数。一同用来计算出主密钥。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Random <span class="built_in">Bytes</span>: <span class="number">4e12</span>e967b6169c4d67caf0575079f34b277d12318385f5a9<span class="params">...</span></span></pre></td></tr></table></figure>
</li>
<li><p><strong>会话ID</strong> ，这里为 0。这个 Session ID 是可以重用的，具体看服务端资源和支持情况。如果要复用 Session ID， SSL 服务端需要维护连接的状态和上次握手成功留下的加密信息。因为这是这是第一次访问该网址，会话 ID 尚未创建，客户端没记录，这里为 0。如果客户端保存了 Session ID 的信息，下次发起 SSL 请求的时候会带上。</p>
</li>
<li><p>加密套件</p>
<p> ，客户端可以支持的密码套件列表。这些套件会根据优先级排序。每一个套件代表一个密钥规格。以 “TLS” 开头，接着是密钥交换算法，然后用 “WITH” 连接加密算法和认证算法。一个加密套件有这么几个内容：密钥交换算法、加密算法（会带有支持的最高密钥位数）、认证算法还有加密方式密钥交换算法用在 SSL 握手阶段的交换协商好的对称密钥的阶段，为非对称加密，比如：</p>
<ul>
<li><strong>EC Deffie-Hellman</strong> 密钥交换算法。这里会被缩写为 ECDHE，也称为 DH 加密。</li>
<li><strong>RSA</strong> 密钥加密算法。</li>
</ul>
<p>加密算法，是最后要用来加密 HTTP 数据的，为对称加密算法，比如：</p>
<ul>
<li><strong>DES</strong></li>
<li><strong>3DES</strong></li>
<li><strong>AES</strong></li>
</ul>
<p>摘要算法，也是对数据进行摘要。后面可以用来做数据的校验，保证数据的一致性，让中途被篡改的包失效，比如：</p>
<ul>
<li><strong>MD5</strong></li>
<li><strong>SHA1</strong></li>
<li><strong>SHA256</strong></li>
</ul>
<p>所以这里一共应用了三种密钥技术，非对称密钥，对称密钥和摘要算法。用一句话总结：用非对称加密算法来传递对称加密算法的密钥，同时用摘要算法保证数据的完整性。<br>这一次请求，客户端提供了 20 种密码套件供服务端选择，最终使用什么密码套件是服务端决定的。要什么密码套件会在 Server Hello 中进行反馈。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Cipher Suites (<span class="number">20</span> suites)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (<span class="number">0xc02b</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (<span class="number">0xc02c</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (<span class="number">0xc02f</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (<span class="number">0xc030</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_DHE_RSA_WITH_AES_128_GCM_SHA256 (<span class="number">0x009e</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384 (<span class="number">0x009f</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA (<span class="number">0xc009</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA (<span class="number">0xc00a</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (<span class="number">0xc013</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA (<span class="number">0xc014</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA (<span class="number">0x0033</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA (<span class="number">0x0039</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_ECDSA_WITH_RC4_128_SHA (<span class="number">0xc007</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_ECDHE_RSA_WITH_RC4_128_SHA (<span class="number">0xc011</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_RSA_WITH_AES_128_GCM_SHA256 (<span class="number">0x009c</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (<span class="number">0x009d</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_RSA_WITH_AES_128_CBC_SHA (<span class="number">0x002f</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_RSA_WITH_AES_256_CBC_SHA (<span class="number">0x0035</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_RSA_WITH_RC4_128_SHA (<span class="number">0x0005</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    Cipher Suite: TLS_EMPTY_RENEGOTIATION_INFO_SCSV (<span class="number">0x00ff</span>)</span></pre></td></tr></table></figure>
</li>
<li><p><strong>压缩算法</strong> ，这里为 0，说明不支持压缩算法</p>
</li>
<li><p><strong>扩展字段</strong> ，一些扩展信息，比如 SNI 的支持，ALPN 的信息等等。</p>
</li>
</ul>
<p>密码套件随着密码学的发展而发展，而且根据现实应用中，可能会有某些密码被破解，从而导致密码套件可能会导致安全问题，所以一般都会使用当前最新最安全的密码套件。<br>在 Android 系统中，一般情况下，使用 SSLSocket进行连接的时候，会带上系统默认的支持的密码套件。但是这个有个缺点，比如某些密码套件的加密算法被破解或者出现安全漏洞，而且要跟着系统升级反应缓慢。OkHttp 在进行 SSL 握手的时候，会使用 ConnectionSpec 类中带上提供了一系列最新的密码套件。可以从注释上看，这些密码套件在 Chrome 51 和 Android 7.0 以上得到了完全支持。</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120421-30ed5.png" alt="img"></p>
<p>OkHttp 密码套件</p>
<p>然后，再把这些密码套件和 Android 系统支持的密码套件取交集，提交给服务端。这样，万一哪个密码套件有问题，OkHttp 官方会下降支持。网络库 OkHttp 库会随着版本的迭代，不断地去提供比较新的密码套件，并且放弃那些不安全的密码套件。接入应用即时更新 OkHttp，就不用等待缓慢的系统更新了。<br>如果提供的所有密码套件服务端都不支持，OkHttp 有回退机制，退而求其次，选比较旧的套件。</p>
<h4 id="2-3-3-阶段二"><a href="#2-3-3-阶段二" class="headerlink" title="2.3.3. 阶段二"></a>2.3.3. 阶段二</h4><p><strong>Server Hello</strong><br>服务端收到了客户端的 Hello，通过客户端的配置信息，结合服务端的自身情况，给出了最终的配置信息。<br>Wireshark 解析后的内容如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Server </span>Hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Length: 93</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Protocol:<span class="built_in"> Server </span>Hello</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            Handshake Type:<span class="built_in"> Server </span>Hello (2)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            Length: 89</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            Random</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                GMT Unix Time: Jul  4, 2022 12:28:57.000000000 �й���׼ʱ��</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                Random Bytes: 6e15dfda5067399e9cd552ba30fb961914c5ce0e3f61d8f8<span class="built_in">..</span>.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            Session ID Length: 32</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            Session ID: 7a92546002c514f9a0b11ef585935c7cc5182d9db3ef0db3<span class="built_in">..</span>.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            Cipher Suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA (0xc013)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            Compression Method: <span class="literal">null</span> (0)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            Extensions Length: 17</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            Extension: server_name</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            Extension: renegotiation_info</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            Extension: ec_point_formats</span></pre></td></tr></table></figure>

<p>具体内容如下：</p>
<ul>
<li><p><strong>版本</strong>，指定这次 SSL 使用 TLSv1.2 版本。</p>
</li>
<li><p>随机数</p>
<p> ，上面的 Client Hello 过程也生产了一个 32 位随机数，这两个随机数将参与主密钥（master key）的创建。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Random Bytes: 6e15dfda5067399e9<span class="keyword">cd</span>552ba30fb961914c5ce0e3f61d8f8.<span class="string">..</span></span></pre></td></tr></table></figure>
</li>
<li><p>会话ID</p>
<p> ，这里不为 0。说明服务端允许客户端再以后的 SSL 连接中复用这次会话。在使用 HTTPS 的 Session Ticket 可以用到。会话 ID 由服务端维持，采用恢复会话的方式创建 SSL 连接。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Session ID: <span class="number">7</span>a<span class="number">92546002</span><span class="keyword">c</span><span class="number">514</span>f<span class="number">9</span>a<span class="number">0</span>b<span class="number">11</span>ef<span class="number">585935</span><span class="keyword">c</span><span class="number">7</span><span class="keyword">cc</span><span class="number">5182</span>d<span class="number">9</span>db<span class="number">3</span>ef<span class="number">0</span>db<span class="number">3</span>...</span></pre></td></tr></table></figure>
</li>
<li><p><strong>加密套件</strong> ，<code>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA</code> 。这个是从客户端 Client Hello 上传的 20 个加密套件中选中的，根据密码套件的格式，上面的信息有，交换加密算法为<code>ECDHE</code> ，就是<code>EC Diffie-Hellman</code> ，RSA 表示后面 Server Key Exchange 阶段的携带 DH 加密算法的公钥的包的数字签名的加密算法是 RSA。加密算法为 <code>AES</code> ，最高密钥支持 128 位，使用 CBC 分组。认证算法 <code>SHA</code> 。所谓 CBC 就是 AES 的机密模式，为分组加密。<code>ECDHE_RSA</code>，表示交换加密算法为 ，<code>RSA</code> 是后面的 获取 <code>ECDHE</code> 的参数的包进行的数字签名用的算法。</p>
</li>
<li><p><strong>压缩方法</strong> ，这里为 0，表示不使用压缩算法。</p>
</li>
</ul>
<p><strong>Certificate</strong><br>上面的 Server Hello 已经制定了接下来的非对称加密算法<br>服务端下发证书，客户端验证服务端的身份，并且取出证书携带的公钥，这个公钥是交换加密算法的公钥。也就是在 Server Hello 阶段指定的 <code>ECDHE</code> （EC Diffie-Hellman）算法，也是通常说的 DH 加密。<br>这个 Certificate 消息下发了从携带自己公钥的数字证书和 CA 证书的证书链，在 Certificates 字段中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="string">Secure</span> <span class="string">Sockets</span> <span class="string">Layer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">TLSv1.2 Record Layer: Handshake Protocol:</span> <span class="string">Certificate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Content Type:</span> <span class="string">Handshake</span> <span class="string">(22)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Version:</span> <span class="string">TLS</span> <span class="number">1.2</span> <span class="string">(0x0303)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Length:</span> <span class="number">2403</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Handshake Protocol:</span> <span class="string">Certificate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">Handshake Type:</span> <span class="string">Certificate</span> <span class="string">(11)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">Length:</span> <span class="number">2399</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">Certificates Length:</span> <span class="number">2396</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Certificates</span> <span class="string">(2396</span> <span class="string">bytes)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">Certificate Length:</span> <span class="number">1283</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">Certificate:</span> <span class="string">308204ff308203e7a0030201020210248b4dd17f3ef11a77...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">Certificate Length:</span> <span class="number">1107</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">Certificate:</span> <span class="string">3082044f30820337a0030201020203023a6f300d06092a86...</span></span></pre></td></tr></table></figure>

<p>CA 是 PKI 体系的重要组成部分，称为认证机构。<br>那什么是 CA 证书？就是用来 CA 中心发布的，认证该服务单证书的合法性，可以确保该证书来源可靠而不是被中间人替换了。但是 CA 证书也可能被中间人拦截造假？那就再用一个证书来认证它。看起来好像没完没了。实际上到最后有一个根 CA 证书，这个证书存储再浏览器或者操作系统中，是系统直接信任的。<br>服务端证书需要 CA 证书做认证。使用的还是数字签名方式，从数据中摘要一段信息，用 CA 证书的加密。然后验证的时候时候，用 CA 证书的公钥解密，用同样的摘要算法摘要数据部分和解密好的信息进行比较。</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120422-b9a8b.png" alt="img"></p>
<p>证书的签名和验签</p>
<p>客户端在验证服务端证书的有效性有这样的一个过程。首先会找到该证书的认证证书，也就是中级 CA 证书。然后找中级 CA 证书的认证证书，可以是另一个中级 CA 证书，也可能是根 CA 证书。这样直到根 CA 证书。<br>接着从根 CA 证书开始往下去验证数字签名。比如有这样的证书链：根 CA 证书-&gt; 中级 CA 证书 -&gt; 服务端证书。用 CA 证书的公钥去验证中级证书的数字签名，再用中级证书的公钥去验证服务器证书的数字签名。任何一个环节验证失败，就可以认为证书不合法。<br>这就是整个证书链的认证过程：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120423-5d80b.gif" alt="img"></p>
<p>证书验证过程</p>
<p>查看抓到的包的数据，发现只有两个证书。为服务端证书和中级 CA 证书。根 CA 证书呢？顺藤摸瓜找到它。<br>首先看服务端证书。它内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attr">Certificate:</span> <span class="string">308204ff308203e7a0030201020210248b4dd17f3ef11a77...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="string">signedCertificate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">version:</span> <span class="string">v3</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">serialNumber:</span> <span class="number">0x248b4dd17f3ef11a7733fead4cd68c21</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="string">signature</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">issuer:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">rdnSequence:</span> <span class="number">3</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-countryName=US)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationName=GeoTrust</span> <span class="string">Inc.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-commonName=GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="string">validity</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">notBefore:</span> <span class="string">utcTime</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">utcTime:</span> <span class="number">15</span><span class="number">-10</span><span class="number">-14</span> <span class="number">00</span><span class="string">:00:00</span> <span class="string">(UTC)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">notAfter:</span> <span class="string">utcTime</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">utcTime:</span> <span class="number">17</span><span class="number">-12</span><span class="number">-30</span> <span class="number">23</span><span class="string">:59:59</span> <span class="string">(UTC)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">subject:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">rdnSequence:</span> <span class="number">6</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-countryName=CN)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-stateOrProvinceName=Zhejiang)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-localityName=Hangzhou)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationName=NetEase</span> <span class="string">(Hangzhou)</span> <span class="string">Network</span> <span class="string">Co.,</span> <span class="string">Ltd)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationalUnitName=MAIL</span> <span class="string">Dept.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-commonName=*.163.com)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        <span class="string">subjectPublicKeyInfo</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            <span class="string">algorithm</span> <span class="string">(rsaEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">Padding:</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">subjectPublicKey:</span> <span class="string">3082010a0282010100ce9da6fb3a940ae04a939b85a1a961...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">extensions:</span> <span class="number">8</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-subjectAltName)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-basicConstraints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-keyUsage)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-cRLDistributionPoints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-certificatePolicies)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-extKeyUsage)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-authorityKeyIdentifier)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-pe-authorityInfoAccessSyntax)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="string">algorithmIdentifier</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">Padding:</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">encrypted:</span> <span class="string">ad75f99ff40e582bc9a17c01c98edf02696aa4f821dfe870...</span></span></pre></td></tr></table></figure>

<p>从这个证书中我们可以窥见这些信息：<br>首先是 signedCertificate 字段的内容，即数字证书的数据：</p>
<ul>
<li><p><strong>版本</strong>，version，v3。对应的就是 X.509 V3 标准。</p>
</li>
<li><p><strong>序列号</strong> ，serialNumber，0x248…，证书颁发者唯一序列号。</p>
</li>
<li><p><strong>签名算法ID</strong> ，Signature Algorithm。这里指的是使用 SHA-256 进行摘要，RSA 进行加密的签名算法。</p>
</li>
<li><p><strong>证书颁发者</strong> ，issuer，就是颁发该证书的 CA 的信息。里面携带后该 CA 的唯一名称（DN，Distinguished Name），比如国家为 US（美国），组织机构为 GeoTrust Inc.，名称为 <strong>GeoTrust SSL CA - G3</strong>。后面我们需要从证书链找到该 CA 证书，去认证当前证书。</p>
</li>
<li><p><strong>有效期</strong> ，validity，证书的起始时间和终止时间。可以得出该证书到 17 年 12 月 30 日后过期。</p>
</li>
<li><p><strong>对象名称</strong> ，subject，里面就是该证书的名称等主要信息了。比如国家为 CN（中国），组织为 <strong>NetEase (Hangzhou) Network Co., Ltd</strong>。名称为 <code>*.163.com</code> ，也是该证书适用的域名。</p>
</li>
<li><p><strong>对象公钥信息</strong> ，subjectPublicKeyInfo。因为这是服务端证书，这个公钥后面将用于主密钥的交换过程，从中可以了解到这个公钥采用 RSA 加密，公钥内容为 3082010a0282010100ce9da6fb3a940ae04a939b85a1a961…</p>
</li>
<li><p>扩展部分</p>
<p> ，一些扩展信息。比如对象的别名。这个如果是 CDN 的服务器证书，那么别名将会非常多。是所有使用该 CDN 的网站的域名。比如之前抓到的 CDNetworks 的 CDN 证书，它的扩展字段 subjectAltName 有这些信息：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attr">Certificate:</span> <span class="string">308220a630821f8ea00302010202100b8a2d407d6121375c...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="string">signedCertificate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">version:</span> <span class="string">v3</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">serialNumber:</span> <span class="number">0x0b8a2d407d6121375cba2fac96354a41</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="string">signature</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">issuer:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="string">validity</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">subject:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">rdnSequence:</span> <span class="number">5</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-countryName=US)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-stateOrProvinceName=California)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-localityName=Campbell)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationName=CDNetworks</span> <span class="string">Inc.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-commonName=support13.cdnetworks.net)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="string">subjectPublicKeyInfo</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">extensions:</span> <span class="number">10</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-authorityKeyIdentifier)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-subjectKeyIdentifier)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-subjectAltName)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">Extension Id:</span> <span class="number">2.5</span><span class="number">.29</span><span class="number">.17</span> <span class="string">(id-ce-subjectAltName)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">GeneralNames:</span> <span class="number">314</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                    <span class="attr">GeneralName:</span> <span class="string">dNSName</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                        <span class="attr">dNSName:</span> <span class="string">support13.cdnetworks.net</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                    <span class="attr">GeneralName:</span> <span class="string">dNSName</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">                        <span class="attr">dNSName:</span> <span class="string">china.ray-ban.com</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">                    <span class="attr">GeneralName:</span> <span class="string">dNSName</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">                        <span class="attr">dNSName:</span> <span class="string">static1.read.ru</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">                    <span class="attr">GeneralName:</span> <span class="string">dNSName</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">                        <span class="attr">dNSName:</span> <span class="string">ps4.cache.square-enix.co.jp</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">                    <span class="string">...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-keyUsage)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-extKeyUsage)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-cRLDistributionPoints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-certificatePolicies)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-pe-authorityInfoAccessSyntax)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-basicConstraints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(iso.3.6.1.4.1.11129.2.4.2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="string">algorithmIdentifier</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">Padding:</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">encrypted:</span> <span class="string">68728010fd9e4b7e3bdbe5e47ec680330b6851e1ea4dc737...</span></span></pre></td></tr></table></figure>

<p>可以了解到该 CDN 为 314 个域名提供服务。</p>
</li>
</ul>
<p>然后是证书颁发机构的签名信息：</p>
<ul>
<li><strong>签名算法</strong>，algorithmIdentifier。这里得出使用的还是 SHA-256 摘要加 RSA 加密的签名算法。这个就是认证该证书的 CA 证书使用的签名算法。</li>
<li><strong>签名信息</strong> ，encrypted，这个信息的内容，CA 证书对 SHA-256 对上面的数据部分进行摘要后，使用 RSA 的私钥加密获得。后面会用在该证书的认证过程，取出 CA 证书的公钥，解密签名信息，用同样的算法获取数据摘要，对比一下是否相同。</li>
</ul>
<p>从上面的 issuer 可以了解到，认证该服务器证书的 CA 证书为 <strong>GeoTrust SSL CA - G3</strong> ，我们从 Certificates 找到对应的中级证书的内容如下（中级证书可以有好几级，我们这儿只有一级）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="attr">Certificate:</span> <span class="string">3082044f30820337a0030201020203023a6f300d06092a86...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="string">signedCertificate</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">version:</span> <span class="string">v3</span> <span class="string">(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">serialNumber:</span> <span class="number">146031</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="string">signature</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">issuer:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">rdnSequence:</span> <span class="number">3</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-countryName=US)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationName=GeoTrust</span> <span class="string">Inc.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-commonName=GeoTrust</span> <span class="string">Global</span> <span class="string">CA)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="string">validity</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">notBefore:</span> <span class="string">utcTime</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">utcTime:</span> <span class="number">13</span><span class="number">-11</span><span class="number">-05</span> <span class="number">21</span><span class="string">:36:50</span> <span class="string">(UTC)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">notAfter:</span> <span class="string">utcTime</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">utcTime:</span> <span class="number">22</span><span class="number">-05</span><span class="number">-20</span> <span class="number">21</span><span class="string">:36:50</span> <span class="string">(UTC)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">subject:</span> <span class="string">rdnSequence</span> <span class="string">(0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">rdnSequence:</span> <span class="number">3</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-countryName=US)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-organizationName=GeoTrust</span> <span class="string">Inc.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                <span class="attr">RDNSequence item:</span> <span class="number">1</span> <span class="string">item</span> <span class="string">(id-at-commonName=GeoTrust</span> <span class="string">SSL</span> <span class="string">CA</span> <span class="bullet">-</span> <span class="string">G3)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="string">subjectPublicKeyInfo</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            <span class="string">algorithm</span> <span class="string">(rsaEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">Padding:</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="attr">subjectPublicKey:</span> <span class="string">3082010a0282010100e3be7e0a86a3cf6b6d3d2ba197ad49...</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">extensions:</span> <span class="number">8</span> <span class="string">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-authorityKeyIdentifier)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-subjectKeyIdentifier)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-basicConstraints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-keyUsage)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-cRLDistributionPoints)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-pe-authorityInfoAccessSyntax)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-certificatePolicies)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            <span class="string">Extension</span> <span class="string">(id-ce-subjectAltName)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="string">algorithmIdentifier</span> <span class="string">(sha256WithRSAEncryption)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">Padding:</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">encrypted:</span> <span class="string">a0d4f72cfb740b7f64f1cd436a9f62531c027c9890a2ee4f...</span></span></pre></td></tr></table></figure>

<p>可以得到中级证书名为 <strong>GeoTrust SSL CA - G3</strong> ，证书组织为 <strong>GeoTrust Inc.</strong> 。<br>认证该 CA 证书的证书呢？还是看 issue 字段，认证证书名为 <strong>GeoTrust Global CA</strong> ，组织同样是 <strong>GeoTrust Inc.</strong> 。<br>其实这个就是根 CA 证书。在这个请求中没有找到，但在浏览器或者操作系统可以找到。一般的浏览器和系统都会内置该 CA 证书。所以根证书是受浏览器或者操作系统信任的，无需其他证书做担保。<br>如果想要自己的系统再信任某些非通用的权威机构的根 CA 证书，那么就去安装它。<br>比如我的 Windows 系统就安装了 <strong>GeoTrust Global CA</strong> 证书：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120424-30102.png" alt="img"></p>
<p>Windows 的证书管理</p>
<p>像我们平时使用 Charles 抓 HTTPS 就是这个原理，把 Charles 的 CA 证书安装在手机中，成为受信任的根 CA 证书。<br>基本原理就是，Charles 代理作为 SSL 隧道，并没有透明传输，而是作为一个中间人，拦截了 SSL 握手信息，修改里面的 CA 证书。仿冒手机端和真实服务端建立连接获取主密钥，然后又仿冒服务端和手机客户端建立 SSL 连接，修改服务端证书的 CA 和数字签名，这样 Charles 就可以解析到加密的 HTTP 内容了。<br>修改后的服务端证书如下，可以看到 issuer 被替换成了 Charles 的证书。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Certificate: <span class="number">30821</span>ff230821edaa0030201020206015e7406ab1c300d06...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    signedCertificate</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">version</span>: v3 (<span class="number">2</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        serialNumber: <span class="number">1505185147676</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        signature (sha256WithRSAEncryption)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        issuer: rdnSequence (<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">            rdnSequence: <span class="number">6</span> <span class="keyword">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-commonName=Charles Proxy Custom Root Certificate)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-organizationalUnitName=<span class="keyword">http</span>://charlesproxy.com/ssl)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-organizationName=XK72 Ltd)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-localityName=Auckland)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-stateOrProvinceName=Auckland)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-countryName=NZ)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        validity</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        subject: rdnSequence (<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            rdnSequence: <span class="number">5</span> <span class="keyword">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-countryName=US)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-stateOrProvinceName=California)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-localityName=Campbell)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-organizationName=CDNetworks Inc.)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                RDNSequence <span class="keyword">item</span>: <span class="number">1</span> <span class="keyword">item</span> (id-<span class="keyword">at</span>-commonName=support13.cdnetworks.net)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        subjectPublicKeyInfo</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        extensions: <span class="number">7</span> <span class="keyword">items</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    algorithmIdentifier (sha256WithRSAEncryption)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    Padding: <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    encrypted: da491fc58682c7b85751db9def0b366d58cf09755ab8ef7d...</span></pre></td></tr></table></figure>

<p>到这个阶段，我们有了一个小想法，是不是可以自己搞个根 CA ，然后推广到各个设备上使用？<br>理论上可以。但是推广成本太高，市场上被大多数系统认可的就这几家机构：</p>
<ul>
<li>Symantec（VeriSign/GeoTrust）</li>
<li>Comodo</li>
<li>GoDaddy</li>
</ul>
<p>像 BAT 这样的大厂也需要买它们的证书。像我这次抓的是网易的包，使用的也是 <strong>GeoTrust</strong> 。不过也有例外，我们的 12306 比较任性，就没有购买这些机构的证书，所以上这个网站在 Chrome 等浏览器经常会弹出不受信任等等。<br><strong>Server Key Exchange</strong><br>密钥交换阶段，这个步骤是可选步骤，对 Certificate 阶段的补充，只有在这几个场景存在：</p>
<ul>
<li>协商采用了 RSA 加密，但是服务端证书没有提供 RSA 公钥。</li>
<li>协商采用了 DH（EC Diffie-Hellman） 加密，但是服务端证书没有提供 DH 参数。</li>
<li>协商采用 fortezza_kea 加密，但是服务端证书没有提供参数。</li>
</ul>
<p>我们满足了哪一个场景？<br>可以知道我们前面协商了使用 EC Diffie-Hellman 算法，而且没带参数，所以这个包就是服务端带过来的用来协商 DH 密钥参数的。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Server </span>Key Exchange</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Length: 333</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Handshake Protocol:<span class="built_in"> Server </span>Key Exchange</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Type:<span class="built_in"> Server </span>Key Exchange (12)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        Length: 329</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        EC Diffie-Hellman<span class="built_in"> Server </span>Params</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            Curve Type: named_curve (0x03)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            Named Curve: secp256r1 (0x0017)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            Pubkey Length: 65</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            Pubkey: 04a10ad7a23135095205caf7ca8e4c838728e877dbcb23c3<span class="built_in">..</span>.</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            Signature Hash Algorithm: 0x0601</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">                Signature Hash Algorithm Hash: SHA512 (6)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">                Signature Hash Algorithm Signature: RSA (1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            Signature Length: 256</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            Signature: 8c7c51f60574144e9e1385a534e12f85911e8dc7cd40dc04<span class="built_in">..</span>.</span></pre></td></tr></table></figure>

<p>这个包把 DH 算法需要的公钥给传递过来了，即 <code>Pubkey: 04a10ad7a23135095205caf7ca8e4c838728e877dbcb23c3...</code><br>同样这个包也携带了数字签名 <code>Signature: 8c7c51f60574144e9e1385a534e12f85911e8dc7cd40dc04...</code> ，用服务端证书带过来的公钥验证一下完整性和来源。<br><strong>Server Hello Done</strong><br>通知客户端，版本和加密套件协商结束。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Server </span>Hello Done</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Length: 4</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Handshake Protocol:<span class="built_in"> Server </span>Hello Done</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Type:<span class="built_in"> Server </span>Hello Done (14)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        Length: 0</span></pre></td></tr></table></figure>

<p>这个 Server Hello Done，就像 TCP 协议的 ACK 确认包一样，这里服务端也给了个确认的信息，通知客户端已经做好进入下一个阶段的准备。<br>通过 Wireshark 抓包发现了一个现象，就是 Server Key Exchange 和 Server Hello Done 被放到了同一个 SSL 记录协议中，这是因为 SSL 记录协议具有组合功能。客户端收到这样的包后，会处理成两个单独的协议包，这又是 SSL 记录协议的分组功能。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Server </span>Key Exchange</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Server </span>Hello Done</span></pre></td></tr></table></figure>

<p>这样做的好处，可以减少发 TCP 包的次数，减少 SSL 握手的时间。</p>
<h4 id="2-3-4-阶段三"><a href="#2-3-4-阶段三" class="headerlink" title="2.3.4. 阶段三"></a>2.3.4. 阶段三</h4><p>如果在一些安全级别高的场景，服务端也会要求客户端上报证书，会有 Certificate Request 的 SSL 握手报文。这样的情况下，接下来会有完整的客户端证书上报服务端的流程。整个流程和阶段二类似。</p>
<h4 id="2-3-5-阶段四"><a href="#2-3-5-阶段四" class="headerlink" title="2.3.5. 阶段四"></a>2.3.5. 阶段四</h4><p>因为我们这里只需要验证服务端的证书，所以直接进入阶段四，开始最后的握手。这个阶段的主要目的，就是生产加密密钥，并进行安全传输。<br><strong>Client Key Exchange</strong><br>这里，客户端不直接生成加密密钥，而是通过之前客户端和服务端生成的随机数又再生成一个随机数，使用前面协商好的用 EC Diffie-Hellman 算法进行加密传输给服务端。这个值又被称为 “premaster secret“。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">TLSv1.2 Record Layer: Handshake Protocol:<span class="built_in"> Client </span>Key Exchange</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    Content Type: Handshake (22)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    Version: TLS 1.2 (0x0303)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    Length: 70</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    Handshake Protocol:<span class="built_in"> Client </span>Key Exchange</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Handshake Type:<span class="built_in"> Client </span>Key Exchange (16)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        Length: 66</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        EC Diffie-Hellman<span class="built_in"> Client </span>Params</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">            Pubkey Length: 65</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            Pubkey: 0433cfbd121d0fa5299819604a15237fc9359845a2a9dffe<span class="built_in">..</span>.</span></pre></td></tr></table></figure>

<p>服务端收到这个报文后，会使用自己的私钥解开这个随机数。<br>在这个阶段过后，服务端和客户端都有三个随机数：客户端随机数、服务端随机数和预备主密钥。<br>在服务端收到了 Client Key Exchange 消息后，两端都按照相应的算法生成了主密钥，加密密钥交换完成。<br>交换完了，因为主密钥是两个端按照约定好的算法产生的，如何保证这个主密钥是正确的？<br>这时候会进入下一个阶段。客户端和服务端会对握手信息使用 SHA 做个摘要，用 AES 加密算法和主密钥加密，传递给对方验证。这种方式也称为消息认证。就是下面的过程：<br><strong>Change Cipher Spec（Client）</strong><br>客户端通知服务端，后续的报文将会被加密。<br><strong>Encrypted Handshake Message（Client）</strong><br>这里就是客户端的 Client Finished 消息。<br>也是整个 SSL 过程中，发送给服务端的第一个加密消息。<br>服务端接收后，服务端用同样的方式计算出已交互的握手消息的摘要，与用主密钥解密后的消息进行对比，一致的话，说明两端生成的主密钥一致，完成了密钥交换。<br><strong>Change Cipher Spec（Server）</strong><br>服务端通知客户端，后续的报文将会被加密。<br><strong>Encrypted Handshake Message（Server）</strong><br>这里就是服务端的 Server Finish 消息。<br>和上面的客户端的 Encrypted Handshake Message 一样，是服务端发出的第一条加密信息。<br>客户端按照协商好的主密钥解密并验证正确后，SSL 握手阶段完成。</p>
<h4 id="2-3-6-小结"><a href="#2-3-6-小结" class="headerlink" title="2.3.6. 小结"></a>2.3.6. 小结</h4><p>整个 SSL 握手主要是要完成这几个目标：</p>
<ul>
<li><p>对服务端身份的验证，或者客户端</p>
</li>
<li><p>协商好对称加密算法和对称加密密钥</p>
</li>
</ul>
<p>对应 Java API 为 SSLSocket ：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">sslSocket.startHandshake()<span class="comment">;</span></span></pre></td></tr></table></figure>

<p>这次请求的整个过程耗时大约为 380ms。可以看出，SSL 握手是很消耗请求时间的。所以对握手进行优化，比如使用 Session ID 或者 Session Ticket。这个类似于 HTTP 协议的 Session 和 Cookie 的使用。</p>
<h3 id="2-4-数据传输"><a href="#2-4-数据传输" class="headerlink" title="2.4. 数据传输"></a>2.4. 数据传输</h3><p>经过了 SSL 握手后，服务端的身份认证成功，协商出了加密算法为 AES，密钥为 xxxxx（客户端和服务端拿三个随机值用相同算法计算出来的，并没有明文传输）。一切准备就绪。<br>SSL 握手成功，已经可以对接下来的数据加密了，接下来各种应用层协议都可以加密传输。</p>
<h4 id="2-4-1-Application-Data"><a href="#2-4-1-Application-Data" class="headerlink" title="2.4.1. Application Data"></a>2.4.1. Application Data</h4><p>应用数据传输消息。因为这里是 HTTPS，所以可以对 HTTP 应用协议数据加密然后传输了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="string">Secure</span> <span class="string">Sockets</span> <span class="string">Layer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="attr">TLSv1.2 Record Layer: Application Data Protocol:</span> <span class="string">http</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Content Type:</span> <span class="string">Application</span> <span class="string">Data</span> <span class="string">(23)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Version:</span> <span class="string">TLS</span> <span class="number">1.2</span> <span class="string">(0x0303)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Length:</span> <span class="number">1072</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="attr">Encrypted Application Data:</span> <span class="string">6d9b3c9089271630c33506fe28cd6a61fed1f4bd2808f537...</span></span></pre></td></tr></table></figure>

<p>从这里，不知道密钥是无法知道这里传输的是什么数据，连传输的是什么协议的内容都不知道。<br>所以之前创建 SSL 隧道，让代理服务器盲传 HTTPS 数据，就得通过 CONNECT 方法告诉代理服务器要连哪台主机，哪个端口号，要不然代理服务器也是一脸懵逼。<br>所以 SSL 协议是很独立的，这里是对 HTTP 进行了加密，也可以对其他协议进行加密。它就像是 TCP 和应用层协议的中间层，为上层协议提供了加密的数据传输。</p>
<h4 id="2-4-2-Encryted-Alert"><a href="#2-4-2-Encryted-Alert" class="headerlink" title="2.4.2. Encryted Alert"></a>2.4.2. Encryted Alert</h4><p>SSL 警告消息，因为是加密的内容，所以单从 Wireshark 看不出警报的内容。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">Secure Sockets Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    TLSv1<span class="number">.2</span> <span class="type">Record</span> Layer: <span class="keyword">Encrypted</span> Alert</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        Content <span class="keyword">Type</span>: Alert (<span class="number">21</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">Version</span>: TLS <span class="number">1.2</span> (<span class="number">0x0303</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        Length: <span class="number">48</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        Alert Message: <span class="keyword">Encrypted</span> Alert</span></pre></td></tr></table></figure>

<p>但因为警报消息经常只是客户端用来提示服务端 SSL 传输结束，对照抓包到的内容确实如此。所以这里只是 SSL 传输结束的一个信号。<br>发出了 Encryted Alert 后客户端数据传输完毕，准备进入四次挥手断开 TCP 连接。</p>
<h3 id="2-5-四次挥手"><a href="#2-5-四次挥手" class="headerlink" title="2.5. 四次挥手"></a>2.5. 四次挥手</h3><p>客户端发送完 HTTP 的数据，也正确地获取到服务端的响应。完成了 HTTPS 的请求工作后，接下来要关闭 TCP 连接。关闭 TCP 连接一共分成四步，也可以成为四次挥手。对应包如下：</p>
<table>
<thead>
<tr>
<th>No.</th>
<th>Time</th>
<th>Source</th>
<th>Destionation</th>
<th>Protocol</th>
<th>Length</th>
<th>Info</th>
</tr>
</thead>
<tbody><tr>
<td>688</td>
<td>7.607349</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>TCP</td>
<td>66</td>
<td>35973 → 8888 [FIN, ACK] Seq=1657 Ack=3213 Win=96512 Len=0 TSval=15986483 TSecr=59355534</td>
</tr>
<tr>
<td>689</td>
<td>7.607363</td>
<td>172.17.32.19</td>
<td>172.17.32.211</td>
<td>TCP</td>
<td>66</td>
<td>8888 → 35973 [ACK] Seq=3213 Ack=1658 Win=65024 Len=0 TSval=59355763 TSecr=15986483</td>
</tr>
<tr>
<td>690</td>
<td>7.620494</td>
<td>172.17.32.19</td>
<td>172.17.32.211</td>
<td>TCP</td>
<td>66</td>
<td>8888 → 35973 [FIN, ACK] Seq=3213 Ack=1658 Win=65024 Len=0 TSval=59355764 TSecr=15986483</td>
</tr>
<tr>
<td>697</td>
<td>7.661600</td>
<td>172.17.32.211</td>
<td>172.17.32.19</td>
<td>TCP</td>
<td>66</td>
<td>35973 → 8888 [ACK] Seq=1658 Ack=3214 Win=96512 Len=0 TSval=15986494 TSecr=59355764</td>
</tr>
</tbody></table>
<p>可以看到，这四个包都只有 66 个字节。因为不带数据，是纯粹的 TCP 首部。</p>
<h4 id="2-5-1-Round-1"><a href="#2-5-1-Round-1" class="headerlink" title="2.5.1. Round 1"></a>2.5.1. Round 1</h4><p>客户端 A 发出 FIN + ACK 包，通知服务端数据传输结束，可以关闭连接了。同样这是一个 ACK 确认包，指出希望的下一个包的序号为 3213。<br>这个阶段后，客户端进入 <code>FIN_WAIT_1</code> 状态，不再发送数据给服务端，但是如果服务端还在传数据过来，客户端的 ACK 确认报文还会有。<br>服务端进入 <code>CLOSE_WAIT</code> 状态。这个状态再发出 ACK 确认包后解除。</p>
<h4 id="2-5-2-Round-2"><a href="#2-5-2-Round-2" class="headerlink" title="2.5.2. Round 2"></a>2.5.2. Round 2</h4><p>接收端 B 收到第一次挥手的包后，会先给一个 ACK 确认包，为第二次挥手。<br>这里有个疑问，既然收到了 A 的结束信息，为什么不马上结束呢？因为 A 完成数据传输，但是 B 可能还有数据没有传完，所以比三次握手会多一个步骤。<br>收到客户端的 FIN 包后，已经知道客户端结束数据传输了，所以服务端后面数据传输结束，就可以直接通知客户端可以结束了。<br>客户端收到 ACK 确认包后，进入 <code>FIN_WAIT_2</code> 状态。</p>
<h4 id="2-5-3-Round-3"><a href="#2-5-3-Round-3" class="headerlink" title="2.5.3. Round 3"></a>2.5.3. Round 3</h4><p>如果服务端数据还没有传完，会继续传给客户端。<br>等服务端的数据完全传完后，会再发一个 FIN + ACK 包，通知客户端数据传完了。<br>这个阶段后，服务端进入 <code>LAST_ACK</code> 状态，即等待客户端最后一个 ACK 报文。</p>
<h4 id="2-5-4-Round-4"><a href="#2-5-4-Round-4" class="headerlink" title="2.5.4. Round 4"></a>2.5.4. Round 4</h4><p>发送端 A 收到 B 发出的 FIN + ACK 后，进入 <code>TIME_WAIT</code> 状态。服务端收到 FIN 后进入 <code>CLOSED</code> 状态关闭连接。<br>经过 2MSL 时间，没有问题后会关闭连接。也进入 <code>CLOSED</code> 状态。<br>为什么有个 <code>TIME_WAIT</code> ？<br>原因是有可能服务端一直没有收到 FIN + ACK，有可能触发超时重传，又发了一个 FIN 给客户端，客户端要重新发送最后一个包。</p>
<h4 id="2-5-5-小结"><a href="#2-5-5-小结" class="headerlink" title="2.5.5. 小结"></a>2.5.5. 小结</h4><p>TCP 四次挥手的时序图如下：</p>
<p><img src="http://image.winrains.cn/2019/11/20191109120425-787f3.png" alt="img"></p>
<p>四次挥手时序图</p>
<h2 id="3-扩展"><a href="#3-扩展" class="headerlink" title="3. 扩展"></a>3. 扩展</h2><h3 id="3-1-Session-ID-和-Session-Ticket"><a href="#3-1-Session-ID-和-Session-Ticket" class="headerlink" title="3.1. Session ID 和 Session Ticket"></a>3.1. Session ID 和 Session Ticket</h3><ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Ffirefile%2Farticle%2Fdetails%2F80531978" target="_blank" rel="noopener">HTTPS 深入浅出 - Session ID 和 Session Ticket</a></li>
</ul>
<h3 id="3-2-SNI（Server-Name-Indication）"><a href="#3-2-SNI（Server-Name-Indication）" class="headerlink" title="3.2. SNI（Server Name Indication）"></a>3.2. SNI（Server Name Indication）</h3><ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Ffirefile%2Farticle%2Fdetails%2F80532161" target="_blank" rel="noopener">HTTPS 深入浅出 - SNI</a></li>
</ul>
<h3 id="3-3-ALPN（Application-Layer-Protocol-Negotiation）"><a href="#3-3-ALPN（Application-Layer-Protocol-Negotiation）" class="headerlink" title="3.3. ALPN（Application Layer Protocol Negotiation）"></a>3.3. ALPN（Application Layer Protocol Negotiation）</h3><ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Ffirefile%2Farticle%2Fdetails%2F80532210" target="_blank" rel="noopener">HTTPS 深入浅出 - ALPN</a></li>
</ul>
<h2 id="4-资料"><a href="#4-资料" class="headerlink" title="4. 资料"></a>4. 资料</h2><ul>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc5246" target="_blank" rel="noopener">RFC5246</a></li>
<li><a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2011%2F08%2Fwhat_is_a_digital_signature.html" target="_blank" rel="noopener">数字签名是什么？</a></li>
<li><a href="https://www.jianshu.com/p/46e48bc517d0" target="_blank" rel="noopener">证书链-Digital Certificates</a></li>
<li><a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.jdon.com%2Fperformance%2Fspeeding-up-https-with-session-resumption.html" target="_blank" rel="noopener">重用Session提高https性能</a></li>
<li><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fshansing.com%2Fread%2F355%2F" target="_blank" rel="noopener">SNI: 实现多域名虚拟主机的SSL/TLS认证</a></li>
</ul>
<blockquote>
<p>作者：Oblee</p>
<p>来源：<a href="https://www.jianshu.com/p/cf8c2f2cd18a" target="_blank" rel="noopener">https://www.jianshu.com/p/cf8c2f2cd18a</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/HTTPS/" rel="tag"># HTTPS</a>
              <a href="/tags/Wireshark/" rel="tag"># Wireshark</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/08/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-JVM-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/" rel="prev" title="深入理解 JVM 类文件结构">
      <i class="fa fa-chevron-left"></i> 深入理解 JVM 类文件结构
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/01/08/%E6%8F%AD%E7%A7%98-Spring-%E7%9A%84-Bean-%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/" rel="next" title="揭秘 Spring 的 Bean 的加载过程">
      揭秘 Spring 的 Bean 的加载过程 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-准备"><span class="nav-number">1.</span> <span class="nav-text">1. 准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-分析"><span class="nav-number">2.</span> <span class="nav-text">2. 分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-三次握手"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. 三次握手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-TCP-协议内容"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1. TCP 协议内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-Round-1"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2. Round 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-Round-2"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3. Round 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-Round-3"><span class="nav-number">2.1.4.</span> <span class="nav-text">2.1.4. Round 3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-5-小结"><span class="nav-number">2.1.5.</span> <span class="nav-text">2.1.5. 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-创建-HTTP-代理（非必要）"><span class="nav-number">2.2.</span> <span class="nav-text">2.2. 创建 HTTP 代理（非必要）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-TLS-SSL-握手"><span class="nav-number">2.3.</span> <span class="nav-text">2.3. TLS/SSL 握手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-TLS-SSL-协议内容"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1. TLS/SSL 协议内容</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-阶段一"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2. 阶段一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-阶段二"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3. 阶段二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-4-阶段三"><span class="nav-number">2.3.4.</span> <span class="nav-text">2.3.4. 阶段三</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-5-阶段四"><span class="nav-number">2.3.5.</span> <span class="nav-text">2.3.5. 阶段四</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-6-小结"><span class="nav-number">2.3.6.</span> <span class="nav-text">2.3.6. 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-数据传输"><span class="nav-number">2.4.</span> <span class="nav-text">2.4. 数据传输</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-Application-Data"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.1. Application Data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-Encryted-Alert"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.4.2. Encryted Alert</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-四次挥手"><span class="nav-number">2.5.</span> <span class="nav-text">2.5. 四次挥手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-Round-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.1. Round 1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-Round-2"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.5.2. Round 2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-Round-3"><span class="nav-number">2.5.3.</span> <span class="nav-text">2.5.3. Round 3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-4-Round-4"><span class="nav-number">2.5.4.</span> <span class="nav-text">2.5.4. Round 4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-5-小结"><span class="nav-number">2.5.5.</span> <span class="nav-text">2.5.5. 小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-扩展"><span class="nav-number">3.</span> <span class="nav-text">3. 扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Session-ID-和-Session-Ticket"><span class="nav-number">3.1.</span> <span class="nav-text">3.1. Session ID 和 Session Ticket</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-SNI（Server-Name-Indication）"><span class="nav-number">3.2.</span> <span class="nav-text">3.2. SNI（Server Name Indication）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-ALPN（Application-Layer-Protocol-Negotiation）"><span class="nav-number">3.3.</span> <span class="nav-text">3.3. ALPN（Application Layer Protocol Negotiation）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-资料"><span class="nav-number">4.</span> <span class="nav-text">4. 资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">congsheng.wang</p>
  <div class="site-description" itemprop="description">trouble is a friend</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">984</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">congsheng.wang</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
